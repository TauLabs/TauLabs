<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>TauLabs: /home/jb/code/TauLabs/ground/gcs/src/plugins/uploader/SSP/qssp.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="icon_128x128.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">TauLabs
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('qssp_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/home/jb/code/TauLabs/ground/gcs/src/plugins/uploader/SSP/qssp.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="qssp_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00012"></a>00012 <span class="comment">/*</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00014"></a>00014 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00015"></a>00015 <span class="comment"> * the Free Software Foundation; either version 3 of the License, or</span>
<a name="l00016"></a>00016 <span class="comment"> * (at your option) any later version.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00019"></a>00019 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<a name="l00020"></a>00020 <span class="comment"> * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<a name="l00021"></a>00021 <span class="comment"> * for more details.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * You should have received a copy of the GNU General Public License along</span>
<a name="l00024"></a>00024 <span class="comment"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<a name="l00025"></a>00025 <span class="comment"> * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="qssp_8h.html">qssp.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00036"></a>00036 <span class="preprocessor">#define SYNC                        225                     // Sync character used in Serial Protocol</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#define ESC                         224                     // ESC character used in Serial Protocol</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#define ESC_SYNC                    1                       // ESC_SYNC character used in Serial Protocol</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#define ACK_BIT                     0x80                    // Ack bit, bit 7 of sequence number, 1 = Acknowledge, 0 =</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="comment">//    new packet</span>
<a name="l00041"></a>00041 <span class="comment">// packet location definitions.</span>
<a name="l00042"></a>00042 <span class="preprocessor">#define LENGTH  0</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#define SEQNUM  1</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#define DATA    2</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">// Make larger sized integers from smaller sized integers</span>
<a name="l00048"></a>00048 <span class="preprocessor">#define MAKEWORD16( ub, lb )  ((uint16_t)0x0000 | ((uint16_t)(ub) &lt;&lt; 8) | (uint16_t)(lb) )</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#define MAKEWORD32( uw, lw ) ((uint32_t)(0x0UL | ((uint32_t)(uw) &lt;&lt; 16) | (uint32_t)(lw)) )</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#define MAKEWORD32B( b3, b2, b1, b0 ) ((uint32_t)((uint32_t)(b3)&lt;&lt; 24) | ((uint32_t)(b2)&lt;&lt;16) | ((uint32_t)(b1)&lt;&lt;8) | ((uint32_t)(b0) )</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">// Used to extract smaller integers from larger sized intergers</span>
<a name="l00054"></a>00054 <span class="preprocessor">#define LOWERBYTE( w )        (uint8_t)((w) &amp; 0x00ff )</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#define UPPERBYTE( w )        (uint8_t)(((w) &amp; 0xff00) &gt;&gt; 8 )</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#define UPPERWORD(lw)         (uint16_t)(((lw) &amp; 0xffff0000) &gt;&gt; 16 )</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#define LOWERWORD(lw)         (uint16_t)((lw) &amp; 0x0000ffff)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a>00059 <span class="comment">// Macros to operate on a target and bitmask.</span>
<a name="l00060"></a>00060 <span class="preprocessor">#define CLEARBIT( a, b )  ((a) = (a) &amp; ~(b))</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#define SETBIT( a, b )    ((a) = (a) | (b) )</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#define TOGGLEBIT(a,b)    ((a) = (a) ^ (b) )</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="comment">// test bit macros operate using a bit mask.</span>
<a name="l00065"></a>00065 <span class="preprocessor">#define ISBITSET( a, b )  ( ((a) &amp; (b)) == (b) ? TRUE : FALSE )</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#define ISBITCLEAR( a, b) (     (~(a) &amp; (b)) == (b) ? TRUE : FALSE )</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">/* Flag bit masks...*/</span>
<a name="l00071"></a>00071 <span class="preprocessor">#define SENT_SYNCH              (0x01)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#define ACK_RECEIVED    (0x02)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#define ACK_EXPECTED    (0x04)</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="preprocessor">#define SSP_AWAITING_ACK        0</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#define SSP_ACKED                       1</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#define SSP_IDLE                        2</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00080"></a>00080 <span class="keyword">static</span> <span class="keyword">const</span> uint16_t CRC_TABLE[] = {
<a name="l00081"></a>00081     0x0000, 0xC0C1, 0xC181, 0x0140, 0xC301, 0x03C0, 0x0280, 0xC241,
<a name="l00082"></a>00082     0xC601, 0x06C0, 0x0780, 0xC741, 0x0500, 0xC5C1, 0xC481, 0x0440,
<a name="l00083"></a>00083     0xCC01, 0x0CC0, 0x0D80, 0xCD41, 0x0F00, 0xCFC1, 0xCE81, 0x0E40,
<a name="l00084"></a>00084     0x0A00, 0xCAC1, 0xCB81, 0x0B40, 0xC901, 0x09C0, 0x0880, 0xC841,
<a name="l00085"></a>00085     0xD801, 0x18C0, 0x1980, 0xD941, 0x1B00, 0xDBC1, 0xDA81, 0x1A40,
<a name="l00086"></a>00086     0x1E00, 0xDEC1, 0xDF81, 0x1F40, 0xDD01, 0x1DC0, 0x1C80, 0xDC41,
<a name="l00087"></a>00087     0x1400, 0xD4C1, 0xD581, 0x1540, 0xD701, 0x17C0, 0x1680, 0xD641,
<a name="l00088"></a>00088     0xD201, 0x12C0, 0x1380, 0xD341, 0x1100, 0xD1C1, 0xD081, 0x1040,
<a name="l00089"></a>00089     0xF001, 0x30C0, 0x3180, 0xF141, 0x3300, 0xF3C1, 0xF281, 0x3240,
<a name="l00090"></a>00090     0x3600, 0xF6C1, 0xF781, 0x3740, 0xF501, 0x35C0, 0x3480, 0xF441,
<a name="l00091"></a>00091     0x3C00, 0xFCC1, 0xFD81, 0x3D40, 0xFF01, 0x3FC0, 0x3E80, 0xFE41,
<a name="l00092"></a>00092     0xFA01, 0x3AC0, 0x3B80, 0xFB41, 0x3900, 0xF9C1, 0xF881, 0x3840,
<a name="l00093"></a>00093     0x2800, 0xE8C1, 0xE981, 0x2940, 0xEB01, 0x2BC0, 0x2A80, 0xEA41,
<a name="l00094"></a>00094     0xEE01, 0x2EC0, 0x2F80, 0xEF41, 0x2D00, 0xEDC1, 0xEC81, 0x2C40,
<a name="l00095"></a>00095     0xE401, 0x24C0, 0x2580, 0xE541, 0x2700, 0xE7C1, 0xE681, 0x2640,
<a name="l00096"></a>00096     0x2200, 0xE2C1, 0xE381, 0x2340, 0xE101, 0x21C0, 0x2080, 0xE041,
<a name="l00097"></a>00097     0xA001, 0x60C0, 0x6180, 0xA141, 0x6300, 0xA3C1, 0xA281, 0x6240,
<a name="l00098"></a>00098     0x6600, 0xA6C1, 0xA781, 0x6740, 0xA501, 0x65C0, 0x6480, 0xA441,
<a name="l00099"></a>00099     0x6C00, 0xACC1, 0xAD81, 0x6D40, 0xAF01, 0x6FC0, 0x6E80, 0xAE41,
<a name="l00100"></a>00100     0xAA01, 0x6AC0, 0x6B80, 0xAB41, 0x6900, 0xA9C1, 0xA881, 0x6840,
<a name="l00101"></a>00101     0x7800, 0xB8C1, 0xB981, 0x7940, 0xBB01, 0x7BC0, 0x7A80, 0xBA41,
<a name="l00102"></a>00102     0xBE01, 0x7EC0, 0x7F80, 0xBF41, 0x7D00, 0xBDC1, 0xBC81, 0x7C40,
<a name="l00103"></a>00103     0xB401, 0x74C0, 0x7580, 0xB541, 0x7700, 0xB7C1, 0xB681, 0x7640,
<a name="l00104"></a>00104     0x7200, 0xB2C1, 0xB381, 0x7340, 0xB101, 0x71C0, 0x7080, 0xB041,
<a name="l00105"></a>00105     0x5000, 0x90C1, 0x9181, 0x5140, 0x9301, 0x53C0, 0x5280, 0x9241,
<a name="l00106"></a>00106     0x9601, 0x56C0, 0x5780, 0x9741, 0x5500, 0x95C1, 0x9481, 0x5440,
<a name="l00107"></a>00107     0x9C01, 0x5CC0, 0x5D80, 0x9D41, 0x5F00, 0x9FC1, 0x9E81, 0x5E40,
<a name="l00108"></a>00108     0x5A00, 0x9AC1, 0x9B81, 0x5B40, 0x9901, 0x59C0, 0x5880, 0x9841,
<a name="l00109"></a>00109     0x8801, 0x48C0, 0x4980, 0x8941, 0x4B00, 0x8BC1, 0x8A81, 0x4A40,
<a name="l00110"></a>00110     0x4E00, 0x8EC1, 0x8F81, 0x4F40, 0x8D01, 0x4DC0, 0x4C80, 0x8C41,
<a name="l00111"></a>00111     0x4400, 0x84C1, 0x8581, 0x4540, 0x8701, 0x47C0, 0x4680, 0x8641,
<a name="l00112"></a>00112     0x8201, 0x42C0, 0x4380, 0x8341, 0x4100, 0x81C1, 0x8081, 0x4040
<a name="l00113"></a>00113 };
<a name="l00114"></a>00114 
<a name="l00122"></a>00122 <span class="comment">/***********************************************************************************************************/</span>
<a name="l00123"></a>00123 
<a name="l00134"></a><a class="code" href="group___uploader.html#gaa7efad31d36502cca3aab3e4eed10d12">00134</a> <span class="keywordtype">void</span> <a class="code" href="group___uploader.html#gaa7efad31d36502cca3aab3e4eed10d12" title="Initializes the communication port for use.">qssp::ssp_Init</a>(<span class="keyword">const</span> <a class="code" href="struct_port_config__t.html">PortConfig_t</a>* <span class="keyword">const</span> info)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     thisport-&gt;<a class="code" href="group___uploader.html#ga39fea4d573ab6d52b3b2df145d6d3f7a">maxRetryCount</a>     = info-&gt;<a class="code" href="group___uploader.html#ga780cb1cf13c87035b0715a39dec4981b">max_retry</a>;
<a name="l00139"></a>00139     thisport-&gt;<a class="code" href="group___uploader.html#gacad18aa8d7e13c6500409da966437d3d">timeoutLen</a>        = info-&gt;<a class="code" href="group___uploader.html#ga13c21abf5c985cf8f33e4a6ccc45310f">timeoutLen</a>;
<a name="l00140"></a>00140     thisport-&gt;<a class="code" href="group___uploader.html#ga108da44374d16b8153824a65fec5a7ae">txBufSize</a>     = info-&gt;<a class="code" href="group___uploader.html#gacc8a53158605f7a72f895d2a80036137">txBufSize</a>;
<a name="l00141"></a>00141     thisport-&gt;<a class="code" href="group___uploader.html#ga640561a803c92539943ec445afba5e72">rxBufSize</a>         = info-&gt;<a class="code" href="group___uploader.html#ga2f1cf7a3eabee4b4fa51aeedb4e7f708">rxBufSize</a>;
<a name="l00142"></a>00142     thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>         = info-&gt;<a class="code" href="group___uploader.html#ga45f87f2e2a856d459c590f5a1a0ffeb4">txBuf</a>;
<a name="l00143"></a>00143     thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>         = info-&gt;<a class="code" href="group___uploader.html#ga351151bd718bd34e6b4acc0c33a315a1">rxBuf</a>;
<a name="l00144"></a>00144     thisport-&gt;<a class="code" href="group___uploader.html#gaa59e48abe3c6ec88333502c7abd9c309">retryCount</a>    = 0;
<a name="l00145"></a>00145     thisport-&gt;<a class="code" href="group___uploader.html#gafc6af17b7bd943cd40a0223eed26a0c3">sendSynch</a>         = FALSE;                <span class="comment">//TRUE;</span>
<a name="l00146"></a>00146     thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a>           = 255;
<a name="l00147"></a>00147     thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>           = 255;
<a name="l00148"></a>00148     thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a>         = SSP_IDLE;
<a name="l00149"></a>00149     thisport-&gt;<a class="code" href="group___uploader.html#ga4e66fb46404301e2985093c34ae57379">InputState</a>            =(<a class="code" href="group___uploader.html#gab10fc109fdda19fca8e7faf999d5a342">ReceiveState</a>)0;
<a name="l00150"></a>00150     thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a>           =(<a class="code" href="group___uploader.html#gaca51c380bc924bd9e5d794ce37ec7194">decodeState_</a>)0;
<a name="l00151"></a>00151     thisport-&gt;<a class="code" href="group___uploader.html#ga9b23351e935a17b3a216b903dabac29c">TxError</a>               =0;
<a name="l00152"></a>00152     thisport-&gt;<a class="code" href="group___uploader.html#ga6d92cd4c24b14264e16528a599123db4">RxError</a>               =0;
<a name="l00153"></a>00153     thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>               =0;
<a name="l00154"></a>00154     thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a>               =0;
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00168"></a><a class="code" href="group___uploader.html#gaa1b44e385ddf057c81585809dc71e4ba">00168</a> int16_t <a class="code" href="group___uploader.html#gaa1b44e385ddf057c81585809dc71e4ba" title="Runs the send process, checks for receipt of ack, timeouts and resends if needed.">qssp::ssp_SendProcess</a>( )
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170     int16_t value = SSP_TX_WAITING;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> == SSP_AWAITING_ACK ) {
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (sf_CheckTimeout() == TRUE) {
<a name="l00174"></a>00174             <span class="keywordflow">if</span> (thisport-&gt;<a class="code" href="group___uploader.html#gaa59e48abe3c6ec88333502c7abd9c309">retryCount</a> &lt; thisport-&gt;<a class="code" href="group___uploader.html#ga39fea4d573ab6d52b3b2df145d6d3f7a">maxRetryCount</a>) {
<a name="l00175"></a>00175                 <span class="comment">// Try again</span>
<a name="l00176"></a>00176                 sf_SendPacket();
<a name="l00177"></a>00177                 sf_SetSendTimeout();
<a name="l00178"></a>00178                 value = SSP_TX_WAITING;
<a name="l00179"></a>00179             } <span class="keywordflow">else</span> {
<a name="l00180"></a>00180                 <span class="comment">// Give up, # of trys has exceded the limit</span>
<a name="l00181"></a>00181                 value = SSP_TX_TIMEOUT;
<a name="l00182"></a>00182                 CLEARBIT( thisport-&gt;<a class="code" href="group___uploader.html#gae9ceccbaac142c00a4699e9020d27f4b">flags</a>, ACK_RECEIVED);
<a name="l00183"></a>00183                 thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> = SSP_IDLE;
<a name="l00184"></a>00184                 <span class="keywordflow">if</span> (debug)
<a name="l00185"></a>00185                   qDebug()&lt;&lt;<span class="stringliteral">&quot;Send TimeOut!&quot;</span>;
<a name="l00186"></a>00186             }
<a name="l00187"></a>00187         } <span class="keywordflow">else</span> {
<a name="l00188"></a>00188             value = SSP_TX_WAITING;
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> == SSP_ACKED ) {
<a name="l00191"></a>00191         SETBIT( thisport-&gt;<a class="code" href="group___uploader.html#gae9ceccbaac142c00a4699e9020d27f4b">flags</a>, ACK_RECEIVED);
<a name="l00192"></a>00192         value = SSP_TX_ACKED;
<a name="l00193"></a>00193         thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> = SSP_IDLE;
<a name="l00194"></a>00194     } <span class="keywordflow">else</span> {
<a name="l00195"></a>00195         thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> = SSP_IDLE;
<a name="l00196"></a>00196         value = SSP_TX_IDLE;
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198     <span class="keywordflow">return</span> value;
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00209"></a><a class="code" href="group___uploader.html#ga11e7402dcc0d8efde83d13592279f122">00209</a> int16_t <a class="code" href="group___uploader.html#ga11e7402dcc0d8efde83d13592279f122" title="Runs the receive process. fetches a byte at a time and runs the byte through the protocol receive sta...">qssp::ssp_ReceiveProcess</a>()
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211     int16_t b;
<a name="l00212"></a>00212     int16_t packet_status = SSP_RX_IDLE;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">do</span> {
<a name="l00215"></a>00215         b = thisport-&gt;<a class="code" href="group___uploader.html#gae97ecc8aa7bff549fc95c2fe0c922279">pfSerialRead</a>(); <span class="comment">// attempt to read a char from the serial buffer</span>
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (b != -1) {
<a name="l00217"></a>00217             packet_status = sf_ReceiveState(b); <span class="comment">// process the newly received byte in the receive state machine</span>
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219         <span class="comment">// keep going until either we received a full packet or there are no more bytes to process</span>
<a name="l00220"></a>00220     } <span class="keywordflow">while</span> (packet_status != SSP_RX_COMPLETE &amp;&amp; b != -1);
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keywordflow">return</span> packet_status;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00234"></a><a class="code" href="group___uploader.html#gae06a33d9cc36f1b95bb0bc0a5ab8ca3a">00234</a> int16_t <a class="code" href="group___uploader.html#gae06a33d9cc36f1b95bb0bc0a5ab8ca3a" title="processes a single byte through the receive state machine.">qssp::ssp_ReceiveByte</a>()
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236     int16_t b;
<a name="l00237"></a>00237     int16_t packet_status = SSP_RX_IDLE;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     b = thisport-&gt;<a class="code" href="group___uploader.html#gae97ecc8aa7bff549fc95c2fe0c922279">pfSerialRead</a>();
<a name="l00240"></a>00240     <span class="keywordflow">if</span>( b != -1 ) {
<a name="l00241"></a>00241         packet_status = sf_ReceiveState(b);
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243     <span class="keywordflow">return</span> packet_status;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00257"></a>00257 uint16_t   qssp::ssp_SendDataBlock(uint8_t *data, uint16_t <a class="code" href="uavobjecttemplate_8m.html#a076bf56c9bafa07f3dbda4901a40d84c">length</a> )
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259     int16_t    packet_status = SSP_TX_WAITING;
<a name="l00260"></a>00260     uint16_t   retval = FALSE;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     packet_status = <a class="code" href="group___uploader.html#gae129d1cdf9ba386b6cd8002176a35a3b" title="sends a chunk of data and does not block">ssp_SendData</a>(data, length );                <span class="comment">// send the data</span>
<a name="l00263"></a>00263     <span class="keywordflow">while</span>( packet_status == SSP_TX_WAITING )  {                                 <span class="comment">// check the status</span>
<a name="l00264"></a>00264         (<a class="code" href="group___u_a_v_objects_plugin.html#ga444cf2ff3f0ecbe028adce838d373f5c">void</a>)<a class="code" href="group___uploader.html#ga11e7402dcc0d8efde83d13592279f122" title="Runs the receive process. fetches a byte at a time and runs the byte through the protocol receive sta...">ssp_ReceiveProcess</a>();                                     <span class="comment">// process any bytes received.</span>
<a name="l00265"></a>00265         packet_status = <a class="code" href="group___uploader.html#gaa1b44e385ddf057c81585809dc71e4ba" title="Runs the send process, checks for receipt of ack, timeouts and resends if needed.">ssp_SendProcess</a>();                      <span class="comment">// check the send status</span>
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267     <span class="keywordflow">if</span>( packet_status == SSP_TX_ACKED )  {                                              <span class="comment">// figure out what happened to the packet</span>
<a name="l00268"></a>00268         retval = TRUE;
<a name="l00269"></a>00269     } <span class="keywordflow">else</span> {
<a name="l00270"></a>00270         retval = FALSE;
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272     <span class="keywordflow">return</span> retval;
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 
<a name="l00287"></a><a class="code" href="group___uploader.html#gae129d1cdf9ba386b6cd8002176a35a3b">00287</a> int16_t <a class="code" href="group___uploader.html#gae129d1cdf9ba386b6cd8002176a35a3b" title="sends a chunk of data and does not block">qssp::ssp_SendData</a>(<span class="keyword">const</span> uint8_t *data, <span class="keyword">const</span> uint16_t length )
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     int16_t value = SSP_TX_WAITING;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="keywordflow">if</span>( (length + 2) &gt; thisport-&gt;<a class="code" href="group___uploader.html#ga108da44374d16b8153824a65fec5a7ae">txBufSize</a> ) {
<a name="l00293"></a>00293         <span class="comment">// TRYING to send too much data.</span>
<a name="l00294"></a>00294         value = SSP_TX_BUFOVERRUN;
<a name="l00295"></a>00295     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> == SSP_IDLE ) {
<a name="l00296"></a>00296 <span class="preprocessor">#ifdef ACTIVE_SYNCH</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#gafc6af17b7bd943cd40a0223eed26a0c3">sendSynch</a> == TRUE )  {
<a name="l00298"></a>00298             sf_SendSynchPacket();
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300 <span class="preprocessor">#endif</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>
<a name="l00302"></a>00302 <span class="preprocessor">#ifdef SYNCH_SEND</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( length == 0 ) {
<a name="l00304"></a>00304             <span class="comment">// TODO this method could allow a task/user to start a synchronisation step if a zero is mistakenly passed to this function.</span>
<a name="l00305"></a>00305             <span class="comment">//      could add a check for a NULL data pointer, or use some sort of static flag that can only be accessed by a static function</span>
<a name="l00306"></a>00306             <span class="comment">//      that must be called before calling this function.</span>
<a name="l00307"></a>00307             <span class="comment">// we are attempting to send a synch packet</span>
<a name="l00308"></a>00308             thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> = 0;                        <span class="comment">// make this zero to cause the other end to re-synch with us</span>
<a name="l00309"></a>00309             SETBIT(thisport-&gt;<a class="code" href="group___uploader.html#gae9ceccbaac142c00a4699e9020d27f4b">flags</a>, SENT_SYNCH);
<a name="l00310"></a>00310         } <span class="keywordflow">else</span> {
<a name="l00311"></a>00311             <span class="comment">// we are sending a data packet</span>
<a name="l00312"></a>00312             CLEARBIT( thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>, ACK_BIT );     <span class="comment">// make sure we are not sending a ACK packet</span>
<a name="l00313"></a>00313             thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>++;                        <span class="comment">// update the sequence number.</span>
<a name="l00314"></a>00314             <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> &gt; 0x7F) {             <span class="comment">// check for sequence number rollover</span>
<a name="l00315"></a>00315                 thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> = 1;                  <span class="comment">// if we do have rollover then reset to 1 not zero,</span>
<a name="l00316"></a>00316                 <span class="comment">// zero is reserviced for synchronization requests</span>
<a name="l00317"></a>00317             }
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <span class="preprocessor">#else</span>
<a name="l00321"></a>00321 <span class="preprocessor"></span>        CLEARBIT( thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>, ACK_BIT );     <span class="comment">// make sure we are not sending a ACK packet</span>
<a name="l00322"></a>00322         thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>++;                        <span class="comment">// update the sequence number.</span>
<a name="l00323"></a>00323         <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> &gt; 0x7F) {             <span class="comment">// check for sequence number rollover</span>
<a name="l00324"></a>00324             thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> = 1;                  <span class="comment">// if we do have rollover then reset to 1 not zero,</span>
<a name="l00325"></a>00325             <span class="comment">// zero is reserved for synchronization requests</span>
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327 <span class="preprocessor">#endif</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>        CLEARBIT( thisport-&gt;<a class="code" href="group___uploader.html#gae9ceccbaac142c00a4699e9020d27f4b">flags</a>, ACK_RECEIVED);
<a name="l00329"></a>00329         thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> = SSP_AWAITING_ACK;
<a name="l00330"></a>00330         value = SSP_TX_WAITING;
<a name="l00331"></a>00331         thisport-&gt;<a class="code" href="group___uploader.html#gaa59e48abe3c6ec88333502c7abd9c309">retryCount</a> = 0;                               <span class="comment">// zero out the retry counter for this transmission</span>
<a name="l00332"></a>00332         sf_MakePacket( thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>, data, length, thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> );
<a name="l00333"></a>00333         sf_SendPacket( );                               <span class="comment">// punch out the packet to the serial port</span>
<a name="l00334"></a>00334         sf_SetSendTimeout(  );  <span class="comment">// do the timeout values</span>
<a name="l00335"></a>00335          <span class="keywordflow">if</span> (debug)
<a name="l00336"></a>00336              qDebug()&lt;&lt;<span class="stringliteral">&quot;Sent DATA PACKET:&quot;</span>&lt;&lt;thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>;
<a name="l00337"></a>00337     } <span class="keywordflow">else</span> {
<a name="l00338"></a>00338         <span class="comment">// error we are already sending a packet. Need to wait for the current packet to be acked or timeout.</span>
<a name="l00339"></a>00339         value = SSP_TX_BUSY;
<a name="l00340"></a>00340          <span class="keywordflow">if</span> (debug)
<a name="l00341"></a>00341              qDebug()&lt;&lt;<span class="stringliteral">&quot;Error sending TX was busy&quot;</span>;
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343     <span class="keywordflow">return</span> value;
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00360"></a><a class="code" href="group___uploader.html#ga6f47e7cf74215ceeaf3d6234ef0c37b7">00360</a> uint16_t <a class="code" href="group___uploader.html#ga6f47e7cf74215ceeaf3d6234ef0c37b7" title="Attempts to synchronize the sequence numbers with the other end of the connectin.">qssp::ssp_Synchronise</a>( )
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362     int16_t     packet_status;
<a name="l00363"></a>00363     uint16_t    retval = FALSE;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="preprocessor">#ifndef USE_SENDPACKET_DATA</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>    thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> = 0;                        <span class="comment">// make this zero to cause the other end to re-synch with us</span>
<a name="l00367"></a>00367     SETBIT(thisport-&gt;<a class="code" href="group___uploader.html#gae9ceccbaac142c00a4699e9020d27f4b">flags</a>, SENT_SYNCH);
<a name="l00368"></a>00368     <span class="comment">// TODO - should this be using ssp_SendPacketData()??</span>
<a name="l00369"></a>00369     sf_MakePacket( thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>, NULL, 0, thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> );    <span class="comment">// construct the packet</span>
<a name="l00370"></a>00370     sf_SendPacket(  );
<a name="l00371"></a>00371     sf_SetSendTimeout(  );
<a name="l00372"></a>00372     thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> = SSP_AWAITING_ACK;
<a name="l00373"></a>00373     packet_status = SSP_TX_WAITING;
<a name="l00374"></a>00374 <span class="preprocessor">#else</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>    packet_status = <a class="code" href="group___uploader.html#gae129d1cdf9ba386b6cd8002176a35a3b" title="sends a chunk of data and does not block">ssp_SendData</a>( NULL, 0 );
<a name="l00376"></a>00376 <span class="preprocessor">#endif</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>    <span class="keywordflow">while</span>( packet_status == SSP_TX_WAITING )  {         <span class="comment">// we loop until we time out.</span>
<a name="l00378"></a>00378         (<a class="code" href="group___u_a_v_objects_plugin.html#ga444cf2ff3f0ecbe028adce838d373f5c">void</a>)<a class="code" href="group___uploader.html#ga11e7402dcc0d8efde83d13592279f122" title="Runs the receive process. fetches a byte at a time and runs the byte through the protocol receive sta...">ssp_ReceiveProcess</a>(  );                   <span class="comment">// do the receive process</span>
<a name="l00379"></a>00379         packet_status = <a class="code" href="group___uploader.html#gaa1b44e385ddf057c81585809dc71e4ba" title="Runs the send process, checks for receipt of ack, timeouts and resends if needed.">ssp_SendProcess</a>(  );    <span class="comment">// do the send process</span>
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     thisport-&gt;<a class="code" href="group___uploader.html#gafc6af17b7bd943cd40a0223eed26a0c3">sendSynch</a> = FALSE;
<a name="l00382"></a>00382     <span class="keywordflow">switch</span>( packet_status ) {
<a name="l00383"></a>00383     <span class="keywordflow">case</span> SSP_TX_ACKED:
<a name="l00384"></a>00384         retval = TRUE;
<a name="l00385"></a>00385         <span class="keywordflow">break</span>;
<a name="l00386"></a>00386     <span class="keywordflow">case</span> SSP_TX_BUSY:         <span class="comment">// intentional fall through.</span>
<a name="l00387"></a>00387     <span class="keywordflow">case</span> SSP_TX_TIMEOUT:      <span class="comment">// intentional fall through.</span>
<a name="l00388"></a>00388     <span class="keywordflow">case</span> SSP_TX_BUFOVERRUN:
<a name="l00389"></a>00389         retval = FALSE;
<a name="l00390"></a>00390         <span class="keywordflow">break</span>;
<a name="l00391"></a>00391     <span class="keywordflow">default</span>:
<a name="l00392"></a>00392         retval = FALSE;
<a name="l00393"></a>00393         <span class="keywordflow">break</span>;
<a name="l00394"></a>00394     };
<a name="l00395"></a>00395     <span class="keywordflow">return</span> retval;
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 
<a name="l00407"></a>00407 <span class="keywordtype">void</span> qssp::sf_SendPacket()
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="comment">// add 3 to packet data length for: 1 length + 2 CRC (packet overhead)</span>
<a name="l00410"></a>00410     uint8_t packetLen = thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>[LENGTH] + 3;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">// use the raw serial write function so the SYNC byte does not get &#39;escaped&#39;</span>
<a name="l00413"></a>00413     thisport-&gt;<a class="code" href="group___uploader.html#ga30e501e90b5d17c51d6f26ff169cf03d">pfSerialWrite</a>(SYNC);
<a name="l00414"></a>00414     <span class="keywordflow">for</span>( uint8_t <a class="code" href="_o_p_plots_8m.html#a9336ebf25087d91c818ee6e9ec29f8c1">x</a> = 0; <a class="code" href="_o_p_plots_8m.html#a9336ebf25087d91c818ee6e9ec29f8c1">x</a> &lt; packetLen; <a class="code" href="_o_p_plots_8m.html#a9336ebf25087d91c818ee6e9ec29f8c1">x</a>++ ) {
<a name="l00415"></a>00415         sf_write_byte(thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>[<a class="code" href="_o_p_plots_8m.html#a9336ebf25087d91c818ee6e9ec29f8c1">x</a>] );
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417     thisport-&gt;<a class="code" href="group___uploader.html#gaa59e48abe3c6ec88333502c7abd9c309">retryCount</a>++;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 
<a name="l00437"></a>00437 <span class="keywordtype">void</span> qssp::sf_MakePacket( uint8_t *txBuf, <span class="keyword">const</span> uint8_t * pdata, uint16_t length, uint8_t seqNo )
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439     uint16_t    <a class="code" href="uavobjecttemplate_8m.html#a6a3730e10b2455e9a8b6599785809fce">crc</a> = 0xffff;
<a name="l00440"></a>00440     uint16_t    bufPos = 0;
<a name="l00441"></a>00441     uint8_t     b;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="comment">// add 1 for the seq. number</span>
<a name="l00444"></a>00444     txBuf[LENGTH] = length + 1;
<a name="l00445"></a>00445     txBuf[SEQNUM] = seqNo;
<a name="l00446"></a>00446     crc = sf_crc16( crc, seqNo );
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     length = length + 2;    <span class="comment">// add two for the length and seqno bytes which are added before the loop.</span>
<a name="l00449"></a>00449     <span class="keywordflow">for</span>( bufPos = 2; bufPos &lt; <a class="code" href="uavobjecttemplate_8m.html#a076bf56c9bafa07f3dbda4901a40d84c">length</a>; bufPos++ ) {
<a name="l00450"></a>00450         b = *pdata++;
<a name="l00451"></a>00451         txBuf[bufPos] = b;
<a name="l00452"></a>00452         crc = sf_crc16( crc, b );    <span class="comment">// update CRC value</span>
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     txBuf[bufPos++] = LOWERBYTE(crc);
<a name="l00455"></a>00455     txBuf[bufPos]   = UPPERBYTE(crc);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00469"></a>00469 <span class="keywordtype">void</span> qssp::sf_SendAckPacket(uint8_t seqNumber)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471     uint8_t    AckSeqNumber = SETBIT( seqNumber, ACK_BIT );
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="comment">// create the packet, note we pass AckSequenceNumber directly</span>
<a name="l00474"></a>00474     sf_MakePacket( thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>, NULL, 0, AckSeqNumber );
<a name="l00475"></a>00475     sf_SendPacket( );
<a name="l00476"></a>00476      <span class="keywordflow">if</span> (debug)
<a name="l00477"></a>00477          qDebug()&lt;&lt;<span class="stringliteral">&quot;Sent ACK PACKET:&quot;</span>&lt;&lt;seqNumber;
<a name="l00478"></a>00478     <span class="comment">// we don&#39;t set the timeout for an ACK because we don&#39;t ACK our ACKs in this protocol</span>
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00490"></a>00490 <span class="keywordtype">void</span> qssp::sf_write_byte(uint8_t c )
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492     <span class="keywordflow">if</span>( c == SYNC ) {                                                   <span class="comment">// check for SYNC byte</span>
<a name="l00493"></a>00493         thisport-&gt;<a class="code" href="group___uploader.html#ga30e501e90b5d17c51d6f26ff169cf03d">pfSerialWrite</a>( ESC );         <span class="comment">// since we are not starting a packet we must ESCAPE the SYNCH byte</span>
<a name="l00494"></a>00494         thisport-&gt;<a class="code" href="group___uploader.html#ga30e501e90b5d17c51d6f26ff169cf03d">pfSerialWrite</a>( ESC_SYNC );    <span class="comment">// now send the escaped synch char</span>
<a name="l00495"></a>00495     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( c == ESC ) {                                             <span class="comment">// Check for ESC character</span>
<a name="l00496"></a>00496         thisport-&gt;<a class="code" href="group___uploader.html#ga30e501e90b5d17c51d6f26ff169cf03d">pfSerialWrite</a>( ESC );                 <span class="comment">// if it is, we need to send it twice</span>
<a name="l00497"></a>00497         thisport-&gt;<a class="code" href="group___uploader.html#ga30e501e90b5d17c51d6f26ff169cf03d">pfSerialWrite</a>( ESC );
<a name="l00498"></a>00498     } <span class="keywordflow">else</span> {
<a name="l00499"></a>00499         thisport-&gt;<a class="code" href="group___uploader.html#ga30e501e90b5d17c51d6f26ff169cf03d">pfSerialWrite</a>( c );                   <span class="comment">// otherwise write the byte to serial port</span>
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="comment">/************************************************************************************************************</span>
<a name="l00504"></a>00504 <span class="comment">*</span>
<a name="l00505"></a>00505 <span class="comment">*  NAME:          uint16_t ssp_crc16( uint16_t crc, uint16_t data )</span>
<a name="l00506"></a>00506 <span class="comment">*  DESCRIPTION:   Uses crc_table to calculate new crc</span>
<a name="l00507"></a>00507 <span class="comment">*  ARGUMENTS:</span>
<a name="l00508"></a>00508 <span class="comment">*        arg1:    crc</span>
<a name="l00509"></a>00509 <span class="comment">*        arg2:    data - byte to calculate into CRC</span>
<a name="l00510"></a>00510 <span class="comment">*  RETURN:        New crc</span>
<a name="l00511"></a>00511 <span class="comment">*  CREATED:    5/8/02</span>
<a name="l00512"></a>00512 <span class="comment">*</span>
<a name="l00513"></a>00513 <span class="comment">*************************************************************************************************************/</span>
<a name="l00524"></a>00524 uint16_t qssp::sf_crc16( uint16_t crc, uint8_t data )
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526     <span class="keywordflow">return</span> (crc &gt;&gt; 8) ^ CRC_TABLE[( crc ^ data ) &amp; 0x00FF ];
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 
<a name="l00539"></a>00539 <span class="keywordtype">void</span> qssp::sf_SetSendTimeout()
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541     uint32_t   timeout;
<a name="l00542"></a>00542     timeout = thisport-&gt;<a class="code" href="group___uploader.html#ga175fa612d12b3411709d60fef9c26cc2">pfGetTime</a>() + thisport-&gt;<a class="code" href="group___uploader.html#gacad18aa8d7e13c6500409da966437d3d">timeoutLen</a>;
<a name="l00543"></a>00543     thisport-&gt;<a class="code" href="group___uploader.html#gac5f404a47ec2583f83bd610d5f184308">timeout</a> = timeout;
<a name="l00544"></a>00544 }
<a name="l00545"></a>00545 
<a name="l00555"></a>00555 uint16_t   qssp::sf_CheckTimeout()
<a name="l00556"></a>00556 {
<a name="l00557"></a>00557     uint16_t    retval = FALSE;
<a name="l00558"></a>00558     uint32_t    current_time;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     current_time = thisport-&gt;<a class="code" href="group___uploader.html#ga175fa612d12b3411709d60fef9c26cc2">pfGetTime</a>();
<a name="l00561"></a>00561     <span class="keywordflow">if</span>( current_time &gt; thisport-&gt;<a class="code" href="group___uploader.html#gac5f404a47ec2583f83bd610d5f184308">timeout</a> )  {
<a name="l00562"></a>00562         retval = TRUE;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <span class="keywordflow">if</span>(retval)
<a name="l00565"></a>00565          <span class="keywordflow">if</span> (debug)
<a name="l00566"></a>00566             qDebug()&lt;&lt;<span class="stringliteral">&quot;timeout &quot;</span>&lt;&lt;current_time&lt;&lt;thisport-&gt;<a class="code" href="group___uploader.html#gac5f404a47ec2583f83bd610d5f184308">timeout</a>;
<a name="l00567"></a>00567     <span class="keywordflow">return</span> retval;
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="comment">/****************************************************************************</span>
<a name="l00572"></a>00572 <span class="comment"> *  NAME:   sf_ReceiveState</span>
<a name="l00573"></a>00573 <span class="comment"> *  DESC:   Implements the receive state handling code for escaped and unescaped data</span>
<a name="l00574"></a>00574 <span class="comment"> *  ARGS:       thisport - which port to operate on</span>
<a name="l00575"></a>00575 <span class="comment"> *              c - incoming byte</span>
<a name="l00576"></a>00576 <span class="comment"> *  RETURN:</span>
<a name="l00577"></a>00577 <span class="comment"> *  CREATED:</span>
<a name="l00578"></a>00578 <span class="comment"> *  NOTES:</span>
<a name="l00579"></a>00579 <span class="comment"> *  1. change from using pointer to functions.</span>
<a name="l00580"></a>00580 <span class="comment"> ****************************************************************************/</span>
<a name="l00590"></a>00590 int16_t qssp::sf_ReceiveState(uint8_t c )
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     int16_t     retval = SSP_RX_RECEIVING;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <span class="keywordflow">switch</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga4e66fb46404301e2985093c34ae57379">InputState</a> ) {
<a name="l00595"></a>00595     <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggab10fc109fdda19fca8e7faf999d5a342acdcef956e1916566a6e6c081948de7bf">state_unescaped_e</a>:
<a name="l00596"></a>00596         <span class="keywordflow">if</span>( c == SYNC ) {
<a name="l00597"></a>00597             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac738efa240b452a9f28a1d74b3b1e577">decode_len1_e</a>;
<a name="l00598"></a>00598         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( c == ESC ) {
<a name="l00599"></a>00599             thisport-&gt;<a class="code" href="group___uploader.html#ga4e66fb46404301e2985093c34ae57379">InputState</a> = <a class="code" href="group___uploader.html#ggab10fc109fdda19fca8e7faf999d5a342ac75bd6be510b577858578d577ee4e7fa">state_escaped_e</a>;
<a name="l00600"></a>00600         } <span class="keywordflow">else</span> {
<a name="l00601"></a>00601             retval = sf_DecodeState(c);
<a name="l00602"></a>00602         }
<a name="l00603"></a>00603         <span class="keywordflow">break</span>;  <span class="comment">// end of unescaped state.</span>
<a name="l00604"></a>00604         <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggab10fc109fdda19fca8e7faf999d5a342ac75bd6be510b577858578d577ee4e7fa">state_escaped_e</a>:
<a name="l00605"></a>00605         thisport-&gt;<a class="code" href="group___uploader.html#ga4e66fb46404301e2985093c34ae57379">InputState</a> = <a class="code" href="group___uploader.html#ggab10fc109fdda19fca8e7faf999d5a342acdcef956e1916566a6e6c081948de7bf">state_unescaped_e</a>;
<a name="l00606"></a>00606         <span class="keywordflow">if</span>( c == SYNC ) {
<a name="l00607"></a>00607             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac738efa240b452a9f28a1d74b3b1e577">decode_len1_e</a>;
<a name="l00608"></a>00608         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == ESC_SYNC ) {
<a name="l00609"></a>00609             retval = sf_DecodeState(SYNC);
<a name="l00610"></a>00610         } <span class="keywordflow">else</span> {
<a name="l00611"></a>00611             retval = sf_DecodeState(c);
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613         <span class="keywordflow">break</span>;  <span class="comment">// end of the escaped state.</span>
<a name="l00614"></a>00614         <span class="keywordflow">default</span>:
<a name="l00615"></a>00615         <span class="keywordflow">break</span>;
<a name="l00616"></a>00616     }
<a name="l00617"></a>00617     <span class="keywordflow">return</span> retval;
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="comment">/****************************************************************************</span>
<a name="l00621"></a>00621 <span class="comment"> *  NAME:   sf_DecodeState</span>
<a name="l00622"></a>00622 <span class="comment"> *  DESC:   Implements the receive state finite state machine</span>
<a name="l00623"></a>00623 <span class="comment"> *  ARGS:       thisport - which port to operate on</span>
<a name="l00624"></a>00624 <span class="comment"> *              c - incoming byte</span>
<a name="l00625"></a>00625 <span class="comment"> *  RETURN:</span>
<a name="l00626"></a>00626 <span class="comment"> *  CREATED:</span>
<a name="l00627"></a>00627 <span class="comment"> *  NOTES:</span>
<a name="l00628"></a>00628 <span class="comment"> *  1. change from using pointer to functions.</span>
<a name="l00629"></a>00629 <span class="comment"> ****************************************************************************/</span>
<a name="l00630"></a>00630 
<a name="l00640"></a>00640 int16_t qssp::sf_DecodeState( uint8_t c )
<a name="l00641"></a>00641 {
<a name="l00642"></a>00642     int16_t     retval;
<a name="l00643"></a>00643     <span class="keywordflow">switch</span>( thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> ) {
<a name="l00644"></a>00644     <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac64fcf93e639a47e18038aa68ba5212d">decode_idle_e</a>:
<a name="l00645"></a>00645         <span class="comment">// &#39;c&#39; is ignored in this state as the only way to leave the idle state is</span>
<a name="l00646"></a>00646         <span class="comment">// recognition of the SYNC byte in the sf_ReceiveState function.</span>
<a name="l00647"></a>00647         retval = SSP_RX_IDLE;
<a name="l00648"></a>00648         <span class="keywordflow">break</span>;
<a name="l00649"></a>00649     <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac738efa240b452a9f28a1d74b3b1e577">decode_len1_e</a>:
<a name="l00650"></a>00650         thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[LENGTH]= c;
<a name="l00651"></a>00651         thisport-&gt;<a class="code" href="group___uploader.html#ga1de477395cd5f7c06623860c2d8017e4">rxBufLen</a> = c;
<a name="l00652"></a>00652         <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga1de477395cd5f7c06623860c2d8017e4">rxBufLen</a> &lt;= thisport-&gt;<a class="code" href="group___uploader.html#ga640561a803c92539943ec445afba5e72">rxBufSize</a> ) {
<a name="l00653"></a>00653             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194a8948184bb37f2d5b059098b995324008">decode_seqNo_e</a>;
<a name="l00654"></a>00654             retval = SSP_RX_RECEIVING;
<a name="l00655"></a>00655         } <span class="keywordflow">else</span> {
<a name="l00656"></a>00656             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac64fcf93e639a47e18038aa68ba5212d">decode_idle_e</a>;
<a name="l00657"></a>00657             retval = SSP_RX_IDLE;
<a name="l00658"></a>00658         }
<a name="l00659"></a>00659         <span class="keywordflow">break</span>;
<a name="l00660"></a>00660         <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194a8948184bb37f2d5b059098b995324008">decode_seqNo_e</a>:
<a name="l00661"></a>00661         thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] = c;
<a name="l00662"></a>00662         thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a> = 0xffff;
<a name="l00663"></a>00663         thisport-&gt;<a class="code" href="group___uploader.html#ga1de477395cd5f7c06623860c2d8017e4">rxBufLen</a>--;           <span class="comment">// subtract 1 for the seq. no.</span>
<a name="l00664"></a>00664         thisport-&gt;<a class="code" href="group___uploader.html#ga75073512a14d809c8ed03df447815d09">rxBufPos</a> = 2;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a> = sf_crc16( thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a>, c );
<a name="l00667"></a>00667         <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga1de477395cd5f7c06623860c2d8017e4">rxBufLen</a> &gt; 0 ) {
<a name="l00668"></a>00668             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194a91931af694b0871e719a59f1c25c352b">decode_data_e</a>;
<a name="l00669"></a>00669         } <span class="keywordflow">else</span> {
<a name="l00670"></a>00670             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194afa9ba876432b572e8e33d9e3dbcbf08b">decode_crc1_e</a>;
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672         retval = SSP_RX_RECEIVING;
<a name="l00673"></a>00673         <span class="keywordflow">break</span>;
<a name="l00674"></a>00674         <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194a91931af694b0871e719a59f1c25c352b">decode_data_e</a>:
<a name="l00675"></a>00675         thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[ (thisport-&gt;<a class="code" href="group___uploader.html#ga75073512a14d809c8ed03df447815d09">rxBufPos</a>)++] = c;
<a name="l00676"></a>00676         thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a> = sf_crc16( thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a>, c );
<a name="l00677"></a>00677         <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga75073512a14d809c8ed03df447815d09">rxBufPos</a> == (thisport-&gt;<a class="code" href="group___uploader.html#ga1de477395cd5f7c06623860c2d8017e4">rxBufLen</a>+2) ) {
<a name="l00678"></a>00678             thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194afa9ba876432b572e8e33d9e3dbcbf08b">decode_crc1_e</a>;
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         retval = SSP_RX_RECEIVING;
<a name="l00681"></a>00681         <span class="keywordflow">break</span>;
<a name="l00682"></a>00682         <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194afa9ba876432b572e8e33d9e3dbcbf08b">decode_crc1_e</a>:
<a name="l00683"></a>00683         thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a> = sf_crc16( thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a>, c );
<a name="l00684"></a>00684         thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194aa6af9fe6c0ab0063f14e51d6918d4200">decode_crc2_e</a>;
<a name="l00685"></a>00685         retval = SSP_RX_RECEIVING;
<a name="l00686"></a>00686         <span class="keywordflow">break</span>;
<a name="l00687"></a>00687         <span class="keywordflow">case</span> <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194aa6af9fe6c0ab0063f14e51d6918d4200">decode_crc2_e</a>:
<a name="l00688"></a>00688         thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac64fcf93e639a47e18038aa68ba5212d">decode_idle_e</a>;
<a name="l00689"></a>00689         <span class="comment">// verify the CRC value for the packet</span>
<a name="l00690"></a>00690         <span class="keywordflow">if</span>( sf_crc16( thisport-&gt;<a class="code" href="group___uploader.html#ga6ad77d0d0cc02d7ce86e13041ef33c5e">crc</a>, c) == 0)   {
<a name="l00691"></a>00691             <span class="comment">// TODO shouldn&#39;t the return value of sf_ReceivePacket() be checked?</span>
<a name="l00692"></a>00692             sf_ReceivePacket();
<a name="l00693"></a>00693             retval = SSP_RX_COMPLETE;
<a name="l00694"></a>00694         } <span class="keywordflow">else</span> {
<a name="l00695"></a>00695             thisport-&gt;<a class="code" href="group___uploader.html#ga6d92cd4c24b14264e16528a599123db4">RxError</a>++;
<a name="l00696"></a>00696             retval = SSP_RX_IDLE;
<a name="l00697"></a>00697         }
<a name="l00698"></a>00698         <span class="keywordflow">break</span>;
<a name="l00699"></a>00699         <span class="keywordflow">default</span>:
<a name="l00700"></a>00700         thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a> = <a class="code" href="group___uploader.html#ggaca51c380bc924bd9e5d794ce37ec7194ac64fcf93e639a47e18038aa68ba5212d">decode_idle_e</a>;  <span class="comment">// unknown state so reset to idle state and wait for the next start of a packet.</span>
<a name="l00701"></a>00701         retval = SSP_RX_IDLE;
<a name="l00702"></a>00702         <span class="keywordflow">break</span>;
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704     <span class="keywordflow">return</span> retval;
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="comment">/************************************************************************************************************</span>
<a name="l00708"></a>00708 <span class="comment">*</span>
<a name="l00709"></a>00709 <span class="comment">*  NAME:             int16_t sf_ReceivePacket( )</span>
<a name="l00710"></a>00710 <span class="comment">*  DESCRIPTION:      Receive one packet, assumed that data is in rec.buff[]</span>
<a name="l00711"></a>00711 <span class="comment">*   ARGUMENTS:</span>
<a name="l00712"></a>00712 <span class="comment">*   RETURN:          0 . no new packet was received, could be ack or same packet</span>
<a name="l00713"></a>00713 <span class="comment">*                    1 . new packet received</span>
<a name="l00714"></a>00714 <span class="comment">*                    SSP_PACKET_?</span>
<a name="l00715"></a>00715 <span class="comment">*                    SSP_PACKET_COMPLETE</span>
<a name="l00716"></a>00716 <span class="comment">*                    SSP_PACKET_ACK</span>
<a name="l00717"></a>00717 <span class="comment">*   CREATED:         5/8/02</span>
<a name="l00718"></a>00718 <span class="comment">*</span>
<a name="l00719"></a>00719 <span class="comment">*************************************************************************************************************/</span>
<a name="l00731"></a>00731 int16_t qssp::sf_ReceivePacket()
<a name="l00732"></a>00732 {
<a name="l00733"></a>00733     int16_t value = FALSE;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="keywordflow">if</span>( ISBITSET(thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM], ACK_BIT ) ) {
<a name="l00736"></a>00736         <span class="comment">//  Received an ACK packet, need to check if it matches the previous sent packet</span>
<a name="l00737"></a>00737         <span class="keywordflow">if</span>( ( thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] &amp; 0x7F) == (thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> &amp; 0x7f)) {
<a name="l00738"></a>00738             <span class="comment">//  It matches the last packet sent by us</span>
<a name="l00739"></a>00739             SETBIT( thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>, ACK_BIT );
<a name="l00740"></a>00740             thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a> = SSP_ACKED;
<a name="l00741"></a>00741             value = FALSE;
<a name="l00742"></a>00742              <span class="keywordflow">if</span> (debug)
<a name="l00743"></a>00743                 qDebug()&lt;&lt;<span class="stringliteral">&quot;Received ACK:&quot;</span>&lt;&lt;(thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a> &amp; 0x7F);
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745         <span class="comment">// else ignore the ACK packet</span>
<a name="l00746"></a>00746     } <span class="keywordflow">else</span> {
<a name="l00747"></a>00747         <span class="comment">//  Received a &#39;data&#39; packet, figure out what type of packet we received...</span>
<a name="l00748"></a>00748         <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] == 0 ) {
<a name="l00749"></a>00749              <span class="keywordflow">if</span> (debug)
<a name="l00750"></a>00750                 qDebug()&lt;&lt;<span class="stringliteral">&quot;Received SYNC Request&quot;</span>;
<a name="l00751"></a>00751             <span class="comment">// Synchronize sequence number with host</span>
<a name="l00752"></a>00752 <span class="preprocessor">#ifdef ACTIVE_SYNCH</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span>            thisport-&gt;<a class="code" href="group___uploader.html#gafc6af17b7bd943cd40a0223eed26a0c3">sendSynch</a> = TRUE;
<a name="l00754"></a>00754 <span class="preprocessor">#endif</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span>            sf_SendAckPacket(thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] );
<a name="l00756"></a>00756             thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a> = 0;
<a name="l00757"></a>00757             value = FALSE;
<a name="l00758"></a>00758         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] == thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a> ) {
<a name="l00759"></a>00759             <span class="comment">// Already seen this packet, just ack it, don&#39;t act on the packet.</span>
<a name="l00760"></a>00760             sf_SendAckPacket(thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] );
<a name="l00761"></a>00761             value = FALSE;
<a name="l00762"></a>00762         } <span class="keywordflow">else</span> {
<a name="l00763"></a>00763             <span class="comment">//New Packet</span>
<a name="l00764"></a>00764             thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a> = thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM];
<a name="l00765"></a>00765             <span class="comment">// Let the application do something with the data/packet.</span>
<a name="l00766"></a>00766 
<a name="l00767"></a>00767             <span class="comment">// skip the first two bytes (length and seq. no.) in the buffer.</span>
<a name="l00768"></a>00768              <span class="keywordflow">if</span> (debug)
<a name="l00769"></a>00769                 qDebug()&lt;&lt;<span class="stringliteral">&quot;Received DATA PACKET seq=&quot;</span>&lt;&lt;thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a>&lt;&lt;<span class="stringliteral">&quot;Data=&quot;</span>&lt;&lt;(uint8_t)thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[2]&lt;&lt;(uint8_t)thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[3]&lt;&lt;(uint8_t)thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[4];
<a name="l00770"></a>00770             <a class="code" href="group___uploader.html#ga78a7ba52d304ce0352e013e99e98820d">pfCallBack</a>( &amp;(thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[2]), thisport-&gt;<a class="code" href="group___uploader.html#ga1de477395cd5f7c06623860c2d8017e4">rxBufLen</a>);
<a name="l00771"></a>00771 
<a name="l00772"></a>00772             <span class="comment">// after we send the ACK, it is possible for the host to send a new packet.</span>
<a name="l00773"></a>00773             <span class="comment">// Thus the application needs to copy the data and reset the receive buffer</span>
<a name="l00774"></a>00774             <span class="comment">// inside of thisport-&gt;pfCallBack()</span>
<a name="l00775"></a>00775             sf_SendAckPacket(thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>[SEQNUM] );
<a name="l00776"></a>00776             value = TRUE;
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     <span class="keywordflow">return</span> value;
<a name="l00780"></a>00780 }
<a name="l00781"></a><a class="code" href="group___uploader.html#ga6b7f70326e497709fc513c3d122379cb">00781</a> <a class="code" href="group___uploader.html#ga6b7f70326e497709fc513c3d122379cb">qssp::qssp</a>(<a class="code" href="classport.html">port</a> * info,<span class="keywordtype">bool</span> <a class="code" href="basevalidatinglineedit_8cpp.html#adf764cbdea00d65edcd07bb9953ad2b7a5be0fd270d9cbf6a0b7445db855089da">debug</a>):debug(debug)
<a name="l00782"></a>00782 {
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     thisport=info;
<a name="l00785"></a>00785     thisport-&gt;<a class="code" href="group___uploader.html#ga39fea4d573ab6d52b3b2df145d6d3f7a">maxRetryCount</a>     = info-&gt;<a class="code" href="group___uploader.html#ga6a20c78337e965260038e132527ba852">max_retry</a>;
<a name="l00786"></a>00786     thisport-&gt;<a class="code" href="group___uploader.html#gacad18aa8d7e13c6500409da966437d3d">timeoutLen</a>        = info-&gt;<a class="code" href="group___uploader.html#gacad18aa8d7e13c6500409da966437d3d">timeoutLen</a>;
<a name="l00787"></a>00787     thisport-&gt;<a class="code" href="group___uploader.html#ga108da44374d16b8153824a65fec5a7ae">txBufSize</a>     = info-&gt;<a class="code" href="group___uploader.html#ga108da44374d16b8153824a65fec5a7ae">txBufSize</a>;
<a name="l00788"></a>00788     thisport-&gt;<a class="code" href="group___uploader.html#ga640561a803c92539943ec445afba5e72">rxBufSize</a>         = info-&gt;<a class="code" href="group___uploader.html#ga640561a803c92539943ec445afba5e72">rxBufSize</a>;
<a name="l00789"></a>00789     thisport-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>         = info-&gt;<a class="code" href="group___uploader.html#gaf025f7e1a7f2a73bbc14602b9a5f1ee0">txBuf</a>;
<a name="l00790"></a>00790     thisport-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>         = info-&gt;<a class="code" href="group___uploader.html#ga934f922079e3cc67b83f3b27d377a1e4">rxBuf</a>;
<a name="l00791"></a>00791     thisport-&gt;<a class="code" href="group___uploader.html#gaa59e48abe3c6ec88333502c7abd9c309">retryCount</a>    = 0;
<a name="l00792"></a>00792     thisport-&gt;<a class="code" href="group___uploader.html#gafc6af17b7bd943cd40a0223eed26a0c3">sendSynch</a>         = FALSE;                <span class="comment">//TRUE;</span>
<a name="l00793"></a>00793     thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a>           = 255;
<a name="l00794"></a>00794     thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>           = 255;
<a name="l00795"></a>00795     thisport-&gt;<a class="code" href="group___uploader.html#ga9eaf6bf50865d1b4f8470110523b9f6b">SendState</a>         = SSP_IDLE;
<a name="l00796"></a>00796     thisport-&gt;<a class="code" href="group___uploader.html#ga4e66fb46404301e2985093c34ae57379">InputState</a>            =(<a class="code" href="group___uploader.html#gab10fc109fdda19fca8e7faf999d5a342">ReceiveState</a>)0;
<a name="l00797"></a>00797     thisport-&gt;<a class="code" href="group___uploader.html#gac689b116d4d7c80713d964bd631e9511">DecodeState</a>           =(<a class="code" href="group___uploader.html#gaca51c380bc924bd9e5d794ce37ec7194">decodeState_</a>)0;
<a name="l00798"></a>00798     thisport-&gt;<a class="code" href="group___uploader.html#ga9b23351e935a17b3a216b903dabac29c">TxError</a>               =0;
<a name="l00799"></a>00799     thisport-&gt;<a class="code" href="group___uploader.html#ga6d92cd4c24b14264e16528a599123db4">RxError</a>               =0;
<a name="l00800"></a>00800     thisport-&gt;<a class="code" href="group___uploader.html#ga9add555476b07ac554ed3371358848bb">txSeqNo</a>               =0;
<a name="l00801"></a>00801     thisport-&gt;<a class="code" href="group___uploader.html#ga82ee05e7b1de6f1b55b375364ce5bc83">rxSeqNo</a>               =0;
<a name="l00802"></a>00802 }
<a name="l00803"></a><a class="code" href="group___uploader.html#ga78a7ba52d304ce0352e013e99e98820d">00803</a> <span class="keywordtype">void</span> <a class="code" href="group___uploader.html#ga78a7ba52d304ce0352e013e99e98820d">qssp::pfCallBack</a>( uint8_t * buf, uint16_t size)
<a name="l00804"></a>00804 {
<a name="l00805"></a>00805     Q_UNUSED(size);
<a name="l00806"></a>00806 
<a name="l00807"></a>00807      <span class="keywordflow">if</span> (debug)
<a name="l00808"></a>00808          qDebug()&lt;&lt;<span class="stringliteral">&quot;receive callback&quot;</span>&lt;&lt;buf[0]&lt;&lt;buf[1]&lt;&lt;buf[2]&lt;&lt;buf[3]&lt;&lt;buf[4];
<a name="l00809"></a>00809 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="qssp_8cpp.html">qssp.cpp</a>      </li>

    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
