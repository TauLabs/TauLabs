<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>TauLabs: /home/jb/code/TauLabs/flight/PiOS/Common/pios_rfm22b.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="icon_128x128.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">TauLabs
   
   </div>
   <div id="projectbrief">TauLabsfirmware</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('pios__rfm22b_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/home/jb/code/TauLabs/flight/PiOS/Common/pios_rfm22b.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="pios__rfm22b_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00015"></a>00015 <span class="comment">/* </span>
<a name="l00016"></a>00016 <span class="comment"> * This program is free software; you can redistribute it and/or modify </span>
<a name="l00017"></a>00017 <span class="comment"> * it under the terms of the GNU General Public License as published by </span>
<a name="l00018"></a>00018 <span class="comment"> * the Free Software Foundation; either version 3 of the License, or </span>
<a name="l00019"></a>00019 <span class="comment"> * (at your option) any later version.</span>
<a name="l00020"></a>00020 <span class="comment"> * </span>
<a name="l00021"></a>00021 <span class="comment"> * This program is distributed in the hope that it will be useful, but </span>
<a name="l00022"></a>00022 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY </span>
<a name="l00023"></a>00023 <span class="comment"> * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License </span>
<a name="l00024"></a>00024 <span class="comment"> * for more details.</span>
<a name="l00025"></a>00025 <span class="comment"> * </span>
<a name="l00026"></a>00026 <span class="comment"> * You should have received a copy of the GNU General Public License along </span>
<a name="l00027"></a>00027 <span class="comment"> * with this program; if not, write to the Free Software Foundation, Inc., </span>
<a name="l00028"></a>00028 <span class="comment"> * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">// *****************************************************************</span>
<a name="l00032"></a>00032 <span class="comment">// RFM22B hardware layer</span>
<a name="l00033"></a>00033 <span class="comment">//</span>
<a name="l00034"></a>00034 <span class="comment">// This module uses the RFM22B&#39;s internal packet handling hardware to</span>
<a name="l00035"></a>00035 <span class="comment">// encapsulate our own packet data.</span>
<a name="l00036"></a>00036 <span class="comment">//</span>
<a name="l00037"></a>00037 <span class="comment">// The RFM22B internal hardware packet handler configuration is as follows ..</span>
<a name="l00038"></a>00038 <span class="comment">//</span>
<a name="l00039"></a>00039 <span class="comment">// 4-byte (32-bit) preamble .. alternating 0&#39;s &amp; 1&#39;s</span>
<a name="l00040"></a>00040 <span class="comment">// 4-byte (32-bit) sync</span>
<a name="l00041"></a>00041 <span class="comment">// 1-byte packet length (number of data bytes to follow)</span>
<a name="l00042"></a>00042 <span class="comment">// 0 to 255 user data bytes</span>
<a name="l00043"></a>00043 <span class="comment">//</span>
<a name="l00044"></a>00044 <span class="comment">// Our own packet data will also contain it&#39;s own header and 32-bit CRC</span>
<a name="l00045"></a>00045 <span class="comment">// as a single 16-bit CRC is not sufficient for wireless comms.</span>
<a name="l00046"></a>00046 <span class="comment">//</span>
<a name="l00047"></a>00047 <span class="comment">// *****************************************************************</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="comment">/* Project Includes */</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;pios.h&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#if defined(PIOS_INCLUDE_RFM22B)</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="pios__spi__priv_8h.html" title="SPI private definitions.">pios_spi_priv.h</a>&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;<a class="code" href="packet__handler_8h.html" title="A packet handler for handeling radio packet transmission.">packet_handler.h</a>&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="pios__rfm22b__priv_8h.html" title="RFM22B private definitions.">pios_rfm22b_priv.h</a>&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;<a class="code" href="ecc_8h.html">ecc.h</a>&gt;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/* Local Defines */</span>
<a name="l00060"></a>00060 <span class="preprocessor">#define STACK_SIZE_BYTES 200</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#define TASK_PRIORITY (tskIDLE_PRIORITY + 2)</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#define ISR_TIMEOUT 2 // ms</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span><span class="preprocessor">#define EVENT_QUEUE_SIZE 5</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#define RFM22B_DEFAULT_RX_DATARATE RFM22_datarate_9600</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#define RFM22B_DEFAULT_FREQUENCY 434000000</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#define RFM22B_DEFAULT_MIN_FREQUENCY (RFM22B_DEFAULT_FREQUENCY - 2000000)</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#define RFM22B_DEFAULT_MAX_FREQUENCY (RFM22B_DEFAULT_FREQUENCY + 2000000)</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#define RFM22B_DEFAULT_TX_POWER RFM22_tx_pwr_txpow_7</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#define RFM22B_LINK_QUALITY_THRESHOLD 20</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="comment">// The maximum amount of time since the last message received to consider the connection broken.</span>
<a name="l00072"></a>00072 <span class="preprocessor">#define DISCONNECT_TIMEOUT_MS 1000 // ms</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074 <span class="comment">// The maximum amount of time without activity before initiating a reset.</span>
<a name="l00075"></a>00075 <span class="preprocessor">#define PIOS_RFM22B_SUPERVISOR_TIMEOUT 100  // ms</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 <span class="comment">// The time between connection attempts when not connected</span>
<a name="l00078"></a>00078 <span class="preprocessor">#define CONNECT_ATTEMPT_PERIOD_MS 250 // ms</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a>00080 <span class="comment">// The time between updates for sending stats the radio link.</span>
<a name="l00081"></a>00081 <span class="preprocessor">#define RADIOSTATS_UPDATE_PERIOD_MS 250</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>
<a name="l00083"></a>00083 <span class="comment">// The number of stats updates that a modem can miss before it&#39;s considered disconnected</span>
<a name="l00084"></a>00084 <span class="preprocessor">#define MAX_RADIOSTATS_MISS_COUNT 3</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>
<a name="l00086"></a>00086 <span class="comment">// The time between PPM updates</span>
<a name="l00087"></a>00087 <span class="preprocessor">#define PPM_UPDATE_PERIOD_MS 40</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>
<a name="l00089"></a>00089 <span class="comment">// this is too adjust the RF module so that it is on frequency</span>
<a name="l00090"></a>00090 <span class="preprocessor">#define OSC_LOAD_CAP                            0x7F    // cap = 12.5pf .. default</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#define OSC_LOAD_CAP_1                          0x7D    // board 1</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#define OSC_LOAD_CAP_2                          0x7B    // board 2</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#define OSC_LOAD_CAP_3                          0x7E    // board 3</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#define OSC_LOAD_CAP_4                          0x7F    // board 4</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a>00096 <span class="comment">// ************************************</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="preprocessor">#define TX_PREAMBLE_NIBBLES                             12              // 7 to 511 (number of nibbles)</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">#define RX_PREAMBLE_NIBBLES                             6               // 5 to 31 (number of nibbles)</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101 <span class="comment">// the size of the rf modules internal FIFO buffers</span>
<a name="l00102"></a>00102 <span class="preprocessor">#define FIFO_SIZE       64</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a>00104 <span class="preprocessor">#define TX_FIFO_HI_WATERMARK                    62              // 0-63</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span><span class="preprocessor">#define TX_FIFO_LO_WATERMARK                    32              // 0-63</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>
<a name="l00107"></a>00107 <span class="preprocessor">#define RX_FIFO_HI_WATERMARK                    32              // 0-63</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>
<a name="l00109"></a>00109 <span class="preprocessor">#define PREAMBLE_BYTE                                   0x55    // preamble byte (preceeds SYNC_BYTE&#39;s)</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>
<a name="l00111"></a>00111 <span class="preprocessor">#define SYNC_BYTE_1                                             0x2D    // RF sync bytes (32-bit in all)</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span><span class="preprocessor">#define SYNC_BYTE_2                                             0xD4    //</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span><span class="preprocessor">#define SYNC_BYTE_3                                             0x4B    //</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span><span class="preprocessor">#define SYNC_BYTE_4                                             0x59    //</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>
<a name="l00116"></a>00116 <span class="preprocessor">#ifndef RX_LED_ON</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span><span class="preprocessor">#define RX_LED_ON</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span><span class="preprocessor">#define RX_LED_OFF</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span><span class="preprocessor">#define TX_LED_ON</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span><span class="preprocessor">#define TX_LED_OFF</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span><span class="preprocessor">#define LINK_LED_ON</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span><span class="preprocessor">#define LINK_LED_OFF</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">#define USB_LED_ON</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span><span class="preprocessor">#define USB_LED_OFF</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>
<a name="l00127"></a>00127 <span class="comment">// ************************************</span>
<a name="l00128"></a>00128 <span class="comment">// Normal data streaming</span>
<a name="l00129"></a>00129 <span class="comment">// GFSK modulation</span>
<a name="l00130"></a>00130 <span class="comment">// no manchester encoding</span>
<a name="l00131"></a>00131 <span class="comment">// data whitening</span>
<a name="l00132"></a>00132 <span class="comment">// FIFO mode</span>
<a name="l00133"></a>00133 <span class="comment">//  5-nibble rx preamble length detection</span>
<a name="l00134"></a>00134 <span class="comment">// 10-nibble tx preamble length</span>
<a name="l00135"></a>00135 <span class="comment">// AFC enabled</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="comment">/* Local type definitions */</span>
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="structpios__rfm22b__transition.html">00139</a> <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__transition.html">pios_rfm22b_transition</a> {
<a name="l00140"></a><a class="code" href="structpios__rfm22b__transition.html#ae70a8d2b5835fa8b0056185581d9cbeb">00140</a>         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> (*<a class="code" href="structpios__rfm22b__transition.html#ae70a8d2b5835fa8b0056185581d9cbeb">entry_fn</a>) (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00141"></a><a class="code" href="structpios__rfm22b__transition.html#a0ad51f078fbfc8b875e6a26efe0b218b">00141</a>         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaf31f5344b7afb099b3105bfff4debdca">pios_rfm22b_state</a> <a class="code" href="structpios__rfm22b__transition.html#a0ad51f078fbfc8b875e6a26efe0b218b">next_state</a>[<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>];
<a name="l00142"></a>00142 };
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="comment">// Must ensure these prefilled arrays match the define sizes</span>
<a name="l00145"></a>00145 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t FULL_PREAMBLE[FIFO_SIZE] = 
<a name="l00146"></a>00146         {PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00147"></a>00147         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00148"></a>00148         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00149"></a>00149         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00150"></a>00150         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00151"></a>00151         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00152"></a>00152         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00153"></a>00153         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00154"></a>00154         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00155"></a>00155         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00156"></a>00156         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00157"></a>00157         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,
<a name="l00158"></a>00158         PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE,PREAMBLE_BYTE}; <span class="comment">// 64 bytes</span>
<a name="l00159"></a>00159 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t HEADER[(TX_PREAMBLE_NIBBLES + 1)/2 + 2] = {PREAMBLE_BYTE, PREAMBLE_BYTE, PREAMBLE_BYTE, PREAMBLE_BYTE,PREAMBLE_BYTE, PREAMBLE_BYTE, SYNC_BYTE_1, SYNC_BYTE_2};
<a name="l00160"></a>00160 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t OUT_FF[64] = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00161"></a>00161         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00162"></a>00162         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00163"></a>00163         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00164"></a>00164         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00165"></a>00165         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00166"></a>00166         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00167"></a>00167         0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF};
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">/* Local function forwared declarations */</span>
<a name="l00170"></a>00170 <span class="keyword">static</span> <span class="keywordtype">void</span> PIOS_RFM22B_Task(<span class="keywordtype">void</span> *parameters);
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keywordtype">bool</span> rfm22_readStatus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00172"></a>00172 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_setDatarate(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaa3e170044f27a00c422ee75f98130ef1">rfm22b_datarate</a> <a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a>, <span class="keywordtype">bool</span> data_whitening);
<a name="l00173"></a>00173 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_init(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00174"></a>00174 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_setRxMode(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00175"></a>00175 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_detectPreamble(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00176"></a>00176 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_detectSync(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00177"></a>00177 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_rxData(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00178"></a>00178 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_rxFailure(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00179"></a>00179 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_receiveStatus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00180"></a>00180 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_receiveAck(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00181"></a>00181 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_receiveNack(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00182"></a>00182 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_sendAck(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00183"></a>00183 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_sendNack(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00184"></a>00184 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_requestConnection(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00185"></a>00185 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_initConnection(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00186"></a>00186 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_acceptConnection(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00187"></a>00187 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_txStart(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00188"></a>00188 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_txData(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_txFailure(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00190"></a>00190 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_process_state_transition(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event);
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_process_event(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event);
<a name="l00192"></a>00192 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_timeout(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00193"></a>00193 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_error(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00194"></a>00194 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_fatal_error(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00195"></a>00195 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_sendStatus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00196"></a>00196 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_sendPPM(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00197"></a>00197 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22b_add_rx_status(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga35600b81785134630f9193e4ff1478a3">pios_rfm22b_rx_packet_status</a> <a class="code" href="group___copter_control_b_l.html#ga2414697de79a243562514a0a4344a4dd">status</a>);
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keywordtype">bool</span> rfm22_receivePacket(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <a class="code" href="struct_p_h_packet.html">PHPacketHandle</a> p, uint16_t rx_len);
<a name="l00199"></a>00199 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_setNominalCarrierFrequency(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint32_t <a class="code" href="structpios__rfm22b__dev.html#a1b85d9c8c4c8dc7ebb1449ce2febee0e">frequency_hz</a>);
<a name="l00200"></a>00200 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_calculateLinkQuality(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00201"></a>00201 <span class="keyword">static</span> <span class="keywordtype">bool</span> rfm22_ready_to_send(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00202"></a>00202 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_setConnectionParameters(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00203"></a>00203 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_clearLEDs();
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">// SPI read/write functions</span>
<a name="l00206"></a>00206 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_assertCs(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00207"></a>00207 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_deassertCs(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00208"></a>00208 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_claimBus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00209"></a>00209 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_releaseBus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev);
<a name="l00210"></a>00210 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_write(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint8_t addr, uint8_t data);
<a name="l00211"></a>00211 <span class="keyword">static</span> uint8_t rfm22_read(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint8_t addr);
<a name="l00212"></a>00212 <span class="keyword">static</span> uint8_t rfm22_read_noclaim(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint8_t addr);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="comment">/* Te state transition table */</span>
<a name="l00215"></a>00215 <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__transition.html">pios_rfm22b_transition</a> rfm22b_transitions[<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc8445257d6ed1782b22c1ee2a46f206">RFM22B_STATE_NUM_STATES</a>] = {
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         <span class="comment">// Initialization thread</span>
<a name="l00218"></a>00218         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa435d2d141dac949cbbb311066ff1d84e">RFM22B_STATE_UNINITIALIZED</a>] = {
<a name="l00219"></a>00219                 .<a class="code" href="structpios__rfm22b__transition.html#ae70a8d2b5835fa8b0056185581d9cbeb">entry_fn</a> = 0,
<a name="l00220"></a>00220                 .next_state = {
<a name="l00221"></a>00221                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00222"></a>00222                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00223"></a>00223                 },
<a name="l00224"></a>00224         },
<a name="l00225"></a>00225         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>] = {
<a name="l00226"></a>00226                 .entry_fn = rfm22_init,
<a name="l00227"></a>00227                 .next_state = {
<a name="l00228"></a>00228                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ab2a453aeb15fd52d7ee950515ccc396c">RFM22B_EVENT_INITIALIZED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8bd0f5000b8fa7d043c3a9bcccd7ceb3">RFM22B_STATE_INITIATING_CONNECTION</a>,
<a name="l00229"></a>00229                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00230"></a>00230                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00231"></a>00231                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00232"></a>00232                 },
<a name="l00233"></a>00233         },
<a name="l00234"></a>00234         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8bd0f5000b8fa7d043c3a9bcccd7ceb3">RFM22B_STATE_INITIATING_CONNECTION</a>] = {
<a name="l00235"></a>00235                 .entry_fn = rfm22_initConnection,
<a name="l00236"></a>00236                 .next_state = {
<a name="l00237"></a>00237                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac19a6abb58f931e6475c592848d7d05a">RFM22B_EVENT_REQUEST_CONNECTION</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaceb982d73e068ba7631800977735b857">RFM22B_STATE_REQUESTING_CONNECTION</a>,
<a name="l00238"></a>00238                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a92444fc670fb008ab3e6df5fc7551209">RFM22B_EVENT_WAIT_FOR_CONNECTION</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa63a36dff1cddc703145598fab4e6bfec">RFM22B_STATE_RX_MODE</a>,
<a name="l00239"></a>00239                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00240"></a>00240                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00241"></a>00241                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00242"></a>00242                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00243"></a>00243                 },
<a name="l00244"></a>00244         },
<a name="l00245"></a>00245         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaceb982d73e068ba7631800977735b857">RFM22B_STATE_REQUESTING_CONNECTION</a>] = {
<a name="l00246"></a>00246                 .entry_fn = rfm22_requestConnection,
<a name="l00247"></a>00247                 .next_state = {
<a name="l00248"></a>00248                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00249"></a>00249                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00250"></a>00250                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00251"></a>00251                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00252"></a>00252                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00253"></a>00253                 },
<a name="l00254"></a>00254         },
<a name="l00255"></a>00255         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaa8e557f9dff9cf70d39cc40ee0e9c3e6">RFM22B_STATE_ACCEPTING_CONNECTION</a>] = {
<a name="l00256"></a>00256                 .entry_fn = rfm22_acceptConnection,
<a name="l00257"></a>00257                 .next_state = {
<a name="l00258"></a>00258                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a270353a6c8c619acd575015ed7acceb6">RFM22B_EVENT_CONNECTION_ACCEPTED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa4d5c74c46877772372fce099c4d10ad7">RFM22B_STATE_SENDING_ACK</a>,
<a name="l00259"></a>00259                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00260"></a>00260                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00261"></a>00261                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00262"></a>00262                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00263"></a>00263                 },
<a name="l00264"></a>00264         },
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa63a36dff1cddc703145598fab4e6bfec">RFM22B_STATE_RX_MODE</a>] = {
<a name="l00267"></a>00267                 .entry_fn = rfm22_setRxMode,
<a name="l00268"></a>00268                 .next_state = {
<a name="l00269"></a>00269                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaff1829e6659fb28cb9cc7e69d120924c">RFM22B_STATE_WAIT_PREAMBLE</a>,
<a name="l00270"></a>00270                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00271"></a>00271                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a94e81215f6aa0f647dfa646a8ffbb0b5">RFM22B_EVENT_ACK_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa0bb4551035b87363e95887adc4c87f44">RFM22B_STATE_RECEIVING_NACK</a>,
<a name="l00272"></a>00272                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8f421837505275bcb2fa262075e7793d">RFM22B_STATE_RX_FAILURE</a>,
<a name="l00273"></a>00273                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00274"></a>00274                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00275"></a>00275                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00276"></a>00276                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00277"></a>00277                 },
<a name="l00278"></a>00278         },
<a name="l00279"></a>00279         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaff1829e6659fb28cb9cc7e69d120924c">RFM22B_STATE_WAIT_PREAMBLE</a>] = {
<a name="l00280"></a>00280                 .entry_fn = rfm22_detectPreamble,
<a name="l00281"></a>00281                 .next_state = {
<a name="l00282"></a>00282                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ad7dfe2b62a899f8ac694d6ff415f8f4a">RFM22B_EVENT_PREAMBLE_DETECTED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa65a831997eef86bd160b26db0453cc5d">RFM22B_STATE_WAIT_SYNC</a>,
<a name="l00283"></a>00283                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00284"></a>00284                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a94e81215f6aa0f647dfa646a8ffbb0b5">RFM22B_EVENT_ACK_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa0bb4551035b87363e95887adc4c87f44">RFM22B_STATE_RECEIVING_NACK</a>,
<a name="l00285"></a>00285                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaff1829e6659fb28cb9cc7e69d120924c">RFM22B_STATE_WAIT_PREAMBLE</a>,
<a name="l00286"></a>00286                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8f421837505275bcb2fa262075e7793d">RFM22B_STATE_RX_FAILURE</a>,
<a name="l00287"></a>00287                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00288"></a>00288                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00289"></a>00289                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00290"></a>00290                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00291"></a>00291                 },
<a name="l00292"></a>00292         },
<a name="l00293"></a>00293         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa65a831997eef86bd160b26db0453cc5d">RFM22B_STATE_WAIT_SYNC</a>] = {
<a name="l00294"></a>00294                 .entry_fn = rfm22_detectSync,
<a name="l00295"></a>00295                 .next_state = {
<a name="l00296"></a>00296                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa65a831997eef86bd160b26db0453cc5d">RFM22B_STATE_WAIT_SYNC</a>,
<a name="l00297"></a>00297                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a997bf1f3409379b556abfeda294ff184">RFM22B_EVENT_SYNC_DETECTED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa309b3a0d3adf41d01687864e7b041740">RFM22B_STATE_RX_DATA</a>,
<a name="l00298"></a>00298                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8f421837505275bcb2fa262075e7793d">RFM22B_STATE_RX_FAILURE</a>,
<a name="l00299"></a>00299                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00300"></a>00300                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00301"></a>00301                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00302"></a>00302                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00303"></a>00303                 },
<a name="l00304"></a>00304         },
<a name="l00305"></a>00305         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa309b3a0d3adf41d01687864e7b041740">RFM22B_STATE_RX_DATA</a>] = {
<a name="l00306"></a>00306                 .entry_fn = rfm22_rxData,
<a name="l00307"></a>00307                 .next_state = {
<a name="l00308"></a>00308                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa309b3a0d3adf41d01687864e7b041740">RFM22B_STATE_RX_DATA</a>,
<a name="l00309"></a>00309                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc4252d32316b4bdff1c9b64e46e7f5a">RFM22B_EVENT_RX_COMPLETE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa4d5c74c46877772372fce099c4d10ad7">RFM22B_STATE_SENDING_ACK</a>,
<a name="l00310"></a>00310                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a35d784cf5079afeadda2640ee6b46f26">RFM22B_EVENT_RX_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaafb273fcaba2f21d05b48a72bf8ec0218">RFM22B_STATE_SENDING_NACK</a>,
<a name="l00311"></a>00311                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aaf8fcd36a96e9bc6fea158bc9f9b9ecd">RFM22B_EVENT_STATUS_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa2e446fb00d4991e2515e7b0ea2a41177">RFM22B_STATE_RECEIVING_STATUS</a>,
<a name="l00312"></a>00312                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa6b3b8a36ef2f5be8301355ebce89112">RFM22B_EVENT_CONNECTION_REQUESTED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaa8e557f9dff9cf70d39cc40ee0e9c3e6">RFM22B_STATE_ACCEPTING_CONNECTION</a>,
<a name="l00313"></a>00313                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a19e9383feac0c23ce398f7d9384c3059">RFM22B_EVENT_PACKET_ACKED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa31d4bd901d91fa70cd6b5265abb7342f">RFM22B_STATE_RECEIVING_ACK</a>,
<a name="l00314"></a>00314                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a725d3965af8e429a95709db317751eea">RFM22B_EVENT_PACKET_NACKED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa0bb4551035b87363e95887adc4c87f44">RFM22B_STATE_RECEIVING_NACK</a>,
<a name="l00315"></a>00315                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8f421837505275bcb2fa262075e7793d">RFM22B_STATE_RX_FAILURE</a>,
<a name="l00316"></a>00316                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00317"></a>00317                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00318"></a>00318                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00319"></a>00319                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00320"></a>00320                 },
<a name="l00321"></a>00321         },
<a name="l00322"></a>00322         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa8f421837505275bcb2fa262075e7793d">RFM22B_STATE_RX_FAILURE</a>] = {
<a name="l00323"></a>00323                 .entry_fn = rfm22_rxFailure,
<a name="l00324"></a>00324                 .next_state = {
<a name="l00325"></a>00325                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa63a36dff1cddc703145598fab4e6bfec">RFM22B_STATE_RX_MODE</a>,
<a name="l00326"></a>00326                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00327"></a>00327                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00328"></a>00328                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00329"></a>00329                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00330"></a>00330                 },
<a name="l00331"></a>00331         },
<a name="l00332"></a>00332         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa31d4bd901d91fa70cd6b5265abb7342f">RFM22B_STATE_RECEIVING_ACK</a>] = {
<a name="l00333"></a>00333                 .entry_fn = rfm22_receiveAck,
<a name="l00334"></a>00334                 .next_state = {
<a name="l00335"></a>00335                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00336"></a>00336                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa63a36dff1cddc703145598fab4e6bfec">RFM22B_STATE_RX_MODE</a>,
<a name="l00337"></a>00337                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00338"></a>00338                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00339"></a>00339                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00340"></a>00340                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00341"></a>00341                 },
<a name="l00342"></a>00342         },
<a name="l00343"></a>00343         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa0bb4551035b87363e95887adc4c87f44">RFM22B_STATE_RECEIVING_NACK</a>] = {
<a name="l00344"></a>00344                 .entry_fn = rfm22_receiveNack,
<a name="l00345"></a>00345                 .next_state = {
<a name="l00346"></a>00346                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00347"></a>00347                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00348"></a>00348                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00349"></a>00349                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00350"></a>00350                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00351"></a>00351                 },
<a name="l00352"></a>00352         },
<a name="l00353"></a>00353         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa2e446fb00d4991e2515e7b0ea2a41177">RFM22B_STATE_RECEIVING_STATUS</a>] = {
<a name="l00354"></a>00354                 .entry_fn = rfm22_receiveStatus,
<a name="l00355"></a>00355                 .next_state = {
<a name="l00356"></a>00356                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc4252d32316b4bdff1c9b64e46e7f5a">RFM22B_EVENT_RX_COMPLETE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa4d5c74c46877772372fce099c4d10ad7">RFM22B_STATE_SENDING_ACK</a>,
<a name="l00357"></a>00357                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00358"></a>00358                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00359"></a>00359                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00360"></a>00360                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00361"></a>00361                 },
<a name="l00362"></a>00362         },
<a name="l00363"></a>00363         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>] = {
<a name="l00364"></a>00364                 .entry_fn = rfm22_txStart,
<a name="l00365"></a>00365                 .next_state = {
<a name="l00366"></a>00366                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa961a924caf5750cb8830f00aeb40b665">RFM22B_STATE_TX_DATA</a>,
<a name="l00367"></a>00367                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa63a36dff1cddc703145598fab4e6bfec">RFM22B_STATE_RX_MODE</a>,
<a name="l00368"></a>00368                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00369"></a>00369                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00370"></a>00370                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00371"></a>00371                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00372"></a>00372                 },
<a name="l00373"></a>00373         },
<a name="l00374"></a>00374         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa961a924caf5750cb8830f00aeb40b665">RFM22B_STATE_TX_DATA</a>] = {
<a name="l00375"></a>00375                 .entry_fn = rfm22_txData,
<a name="l00376"></a>00376                 .next_state = {
<a name="l00377"></a>00377                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa961a924caf5750cb8830f00aeb40b665">RFM22B_STATE_TX_DATA</a>,
<a name="l00378"></a>00378                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa63a36dff1cddc703145598fab4e6bfec">RFM22B_STATE_RX_MODE</a>,
<a name="l00379"></a>00379                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaf1847b13cef0dfe40f78a5d093135b1b">RFM22B_STATE_TX_FAILURE</a>,
<a name="l00380"></a>00380                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00381"></a>00381                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00382"></a>00382                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00383"></a>00383                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00384"></a>00384                 },
<a name="l00385"></a>00385         },
<a name="l00386"></a>00386         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaaf1847b13cef0dfe40f78a5d093135b1b">RFM22B_STATE_TX_FAILURE</a>] = {
<a name="l00387"></a>00387                 .entry_fn = rfm22_txFailure,
<a name="l00388"></a>00388                 .next_state = {
<a name="l00389"></a>00389                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00390"></a>00390                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>,
<a name="l00391"></a>00391                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00392"></a>00392                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00393"></a>00393                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00394"></a>00394                 },
<a name="l00395"></a>00395         },
<a name="l00396"></a>00396         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa4d5c74c46877772372fce099c4d10ad7">RFM22B_STATE_SENDING_ACK</a>] = {
<a name="l00397"></a>00397                 .entry_fn = rfm22_sendAck,
<a name="l00398"></a>00398                 .next_state = {
<a name="l00399"></a>00399                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00400"></a>00400                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00401"></a>00401                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00402"></a>00402                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00403"></a>00403                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00404"></a>00404                 },
<a name="l00405"></a>00405         },
<a name="l00406"></a>00406         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaafb273fcaba2f21d05b48a72bf8ec0218">RFM22B_STATE_SENDING_NACK</a>] = {
<a name="l00407"></a>00407                 .entry_fn = rfm22_sendNack,
<a name="l00408"></a>00408                 .next_state = {
<a name="l00409"></a>00409                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00410"></a>00410                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00411"></a>00411                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00412"></a>00412                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00413"></a>00413                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00414"></a>00414                 },
<a name="l00415"></a>00415         },
<a name="l00416"></a>00416         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa94356a3bc173a01ef473c81f7f9f387c">RFM22B_STATE_TIMEOUT</a>] = {
<a name="l00417"></a>00417                 .entry_fn = rfm22_timeout,
<a name="l00418"></a>00418                 .next_state = {
<a name="l00419"></a>00419                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaacc32ba57d31d0786b6addb57d363e412">RFM22B_STATE_TX_START</a>,
<a name="l00420"></a>00420                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00421"></a>00421                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00422"></a>00422                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00423"></a>00423                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00424"></a>00424                 },
<a name="l00425"></a>00425         },
<a name="l00426"></a>00426         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>] = {
<a name="l00427"></a>00427                 .entry_fn = rfm22_error,
<a name="l00428"></a>00428                 .next_state = {
<a name="l00429"></a>00429                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00430"></a>00430                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa863dc3eeb6b9d6daea6718097e9afba0">RFM22B_STATE_ERROR</a>,
<a name="l00431"></a>00431                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>,
<a name="l00432"></a>00432                         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>] = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>,
<a name="l00433"></a>00433                 },
<a name="l00434"></a>00434         },
<a name="l00435"></a>00435         [<a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa29a48aa40064638700998b35b23ec72f">RFM22B_STATE_FATAL_ERROR</a>] = {
<a name="l00436"></a>00436                 .entry_fn = rfm22_fatal_error,
<a name="l00437"></a>00437                 .next_state = {
<a name="l00438"></a>00438                 },
<a name="l00439"></a>00439         },
<a name="l00440"></a>00440 };
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="comment">// xtal 10 ppm, 434MHz</span>
<a name="l00443"></a>00443 <span class="preprocessor">#define LOOKUP_SIZE      14</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> uint32_t            data_rate[] = {   500,  1000,  2000,  4000,  8000,  9600, 16000, 19200, 24000,  32000,  64000, 128000, 192000, 256000};
<a name="l00445"></a>00445 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t      modulation_index[] = {    16,     8,     4,     2,     1,     1,     1,     1,     1,      1,      1,      1,      1,      1};
<a name="l00446"></a>00446 <span class="keyword">static</span> <span class="keyword">const</span> uint32_t       freq_deviation[] = {  4000,  4000,  4000,  4000,  4000,  4800,  8000,  9600, 12000,  16000,  32000,  64000,  96000, 128000};
<a name="l00447"></a>00447 <span class="keyword">static</span> <span class="keyword">const</span> uint32_t         rx_bandwidth[] = { 17500, 17500, 17500, 17500, 17500, 19400, 32200, 38600, 51200,  64100, 137900, 269300, 420200, 518800};
<a name="l00448"></a>00448 <span class="keyword">static</span> <span class="keyword">const</span> int8_t        est_rx_sens_dBm[] = {  -118,  -118,  -117,  -116,  -115,  -115,  -112,  -112,  -110,   -109,   -106,   -103,   -101,   -100}; <span class="comment">// estimated receiver sensitivity for BER = 1E-3</span>
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_1C[] = {  0x37,  0x37,  0x37,  0x37,  0x3A,  0x3B,  0x26,  0x28,  0x2E,   0x16,   0x07,   0x83,   0x8A,   0x8C}; <span class="comment">// rfm22_if_filter_bandwidth</span>
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_1D[] = {  0x44,  0x44,  0x44,  0x44,  0x44,  0x44,  0x44,  0x44,  0x44,   0x44,   0x44,   0x44,   0x44,   0x44}; <span class="comment">// rfm22_afc_loop_gearshift_override</span>
<a name="l00453"></a>00453 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_1E[] = {  0x0A,  0x0A,  0x0A,  0x0A,  0x0A,  0x0A,  0x0A,  0x0A,  0x0A,   0x0A,   0x0A,   0x0A,   0x0A,   0x02}; <span class="comment">// rfm22_afc_timing_control</span>
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_1F[] = {  0x03,  0x03,  0x03,  0x03,  0x03,  0x03,  0x03,  0x03,  0x03,   0x03,   0x03,   0x03,   0x03,   0x03}; <span class="comment">// rfm22_clk_recovery_gearshift_override</span>
<a name="l00456"></a>00456 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_20[] = {  0xE8,  0xF4,  0xFA,  0x70,  0x3F,  0x34,  0x3F,  0x34,  0x2A,   0x3F,   0x3F,   0x5E,   0x3F,   0x2F}; <span class="comment">// rfm22_clk_recovery_oversampling_ratio</span>
<a name="l00457"></a>00457 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_21[] = {  0x60,  0x20,  0x00,  0x01,  0x02,  0x02,  0x02,  0x02,  0x03,   0x02,   0x02,   0x01,   0x02,   0x02}; <span class="comment">// rfm22_clk_recovery_offset2</span>
<a name="l00458"></a>00458 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_22[] = {  0x20,  0x41,  0x83,  0x06,  0x0C,  0x75,  0x0C,  0x75,  0x12,   0x0C,   0x0C,   0x5D,   0x0C,   0xBB}; <span class="comment">// rfm22_clk_recovery_offset1</span>
<a name="l00459"></a>00459 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_23[] = {  0xC5,  0x89,  0x12,  0x25,  0x4A,  0x25,  0x4A,  0x25,  0x6F,   0x4A,   0x4A,   0x86,   0x4A,   0x0D}; <span class="comment">// rfm22_clk_recovery_offset0</span>
<a name="l00460"></a>00460 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_24[] = {  0x00,  0x00,  0x00,  0x02,  0x07,  0x07,  0x07,  0x07,  0x07,   0x07,   0x07,   0x05,   0x07,   0x07}; <span class="comment">// rfm22_clk_recovery_timing_loop_gain1</span>
<a name="l00461"></a>00461 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_25[] = {  0x0A,  0x23,  0x85,  0x0E,  0xFF,  0xFF,  0xFF,  0xFF,  0xFF,   0xFF,   0xFF,   0x74,   0xFF,   0xFF}; <span class="comment">// rfm22_clk_recovery_timing_loop_gain0</span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_2A[] = {  0x0E,  0x0E,  0x0E,  0x0E,  0x0E,  0x0D,  0x0D,  0x0E,  0x12,   0x17,   0x31,   0x50,   0x50,   0x50}; <span class="comment">// rfm22_afc_limiter .. AFC_pull_in_range = �AFCLimiter[7:0] x (hbsel+1) x 625 Hz</span>
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_6E[] = {  0x04,  0x08,  0x10,  0x20,  0x41,  0x4E,  0x83,  0x9D,  0xC4,   0x08,   0x10,   0x20,   0x31,   0x41}; <span class="comment">// rfm22_tx_data_rate1</span>
<a name="l00466"></a>00466 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_6F[] = {  0x19,  0x31,  0x62,  0xC5,  0x89,  0xA5,  0x12,  0x49,  0x9C,   0x31,   0x62,   0xC5,   0x27,   0x89}; <span class="comment">// rfm22_tx_data_rate0</span>
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_70[] = {  0x2D,  0x2D,  0x2D,  0x2D,  0x2D,  0x2D,  0x2D,  0x2D,  0x2D,   0x0D,   0x0D,   0x0D,   0x0D,   0x0D}; <span class="comment">// rfm22_modulation_mode_control1</span>
<a name="l00469"></a>00469 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_71[] = {  0x23,  0x23,  0x23,  0x23,  0x23,  0x23,  0x23,  0x23,  0x23,   0x23,   0x23,   0x23,   0x23,   0x23}; <span class="comment">// rfm22_modulation_mode_control2</span>
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t                reg_72[] = {  0x06,  0x06,  0x06,  0x06,  0x06,  0x08,  0x0D,  0x0F,  0x13,   0x1A,   0x33,   0x66,   0x9A,   0xCD}; <span class="comment">// rfm22_frequency_deviation</span>
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="comment">// ************************************</span>
<a name="l00474"></a>00474 <span class="comment">// Scan Spectrum settings</span>
<a name="l00475"></a>00475 <span class="comment">// GFSK modulation</span>
<a name="l00476"></a>00476 <span class="comment">// no manchester encoding</span>
<a name="l00477"></a>00477 <span class="comment">// data whitening</span>
<a name="l00478"></a>00478 <span class="comment">// FIFO mode</span>
<a name="l00479"></a>00479 <span class="comment">//  5-nibble rx preamble length detection</span>
<a name="l00480"></a>00480 <span class="comment">// 10-nibble tx preamble length</span>
<a name="l00481"></a>00481 <span class="preprocessor">#define SS_LOOKUP_SIZE   2</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>
<a name="l00483"></a>00483 <span class="comment">// xtal 1 ppm, 434MHz</span>
<a name="l00484"></a>00484 <span class="keyword">static</span> <span class="keyword">const</span> uint32_t ss_rx_bandwidth[] = {  2600, 10600};
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_1C[] = {  0x51, 0x32}; <span class="comment">// rfm22_if_filter_bandwidth</span>
<a name="l00487"></a>00487 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_1D[] = {  0x00, 0x00}; <span class="comment">// rfm22_afc_loop_gearshift_override</span>
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_20[] = {  0xE8, 0x38}; <span class="comment">// rfm22_clk_recovery_oversampling_ratio</span>
<a name="l00490"></a>00490 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_21[] = {  0x60, 0x02}; <span class="comment">// rfm22_clk_recovery_offset2</span>
<a name="l00491"></a>00491 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_22[] = {  0x20, 0x4D}; <span class="comment">// rfm22_clk_recovery_offset1</span>
<a name="l00492"></a>00492 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_23[] = {  0xC5, 0xD3}; <span class="comment">// rfm22_clk_recovery_offset0</span>
<a name="l00493"></a>00493 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_24[] = {  0x00, 0x07}; <span class="comment">// rfm22_clk_recovery_timing_loop_gain1</span>
<a name="l00494"></a>00494 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_25[] = {  0x0F, 0xFF}; <span class="comment">// rfm22_clk_recovery_timing_loop_gain0</span>
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_2A[] = {  0xFF, 0xFF}; <span class="comment">// rfm22_afc_limiter .. AFC_pull_in_range = �AFCLimiter[7:0] x (hbsel+1) x 625 Hz</span>
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_70[] = {  0x24, 0x2D}; <span class="comment">// rfm22_modulation_mode_control1</span>
<a name="l00499"></a>00499 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ss_reg_71[] = {  0x2B, 0x23}; <span class="comment">// rfm22_modulation_mode_control2</span>
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="keyword">static</span> <span class="keyword">inline</span> uint32_t timeDifferenceMs(portTickType start_time, portTickType end_time)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504         <span class="keywordflow">if</span>(end_time &gt;= start_time)
<a name="l00505"></a>00505                 <span class="keywordflow">return</span> (end_time - start_time) * portTICK_RATE_MS;
<a name="l00506"></a>00506         <span class="comment">// Rollover</span>
<a name="l00507"></a>00507         <span class="keywordflow">return</span> ((portMAX_DELAY - start_time) + end_time) * portTICK_RATE_MS;
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 
<a name="l00510"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">00510</a> <span class="keywordtype">bool</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev)
<a name="l00511"></a>00511 {
<a name="l00512"></a>00512         <span class="keywordflow">return</span> (rfm22b_dev != NULL &amp;&amp; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acffebca4153749f86cd6237ac4482f3a">magic</a> == <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga25f646fb6abded1e9f076ca00e13cbeca465296d21d23694d7d9f2f7486929f77">PIOS_RFM22B_DEV_MAGIC</a>);
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 <span class="preprocessor">#if defined(PIOS_INCLUDE_FREERTOS)</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * PIOS_RFM22B_alloc(<span class="keywordtype">void</span>)
<a name="l00517"></a>00517 {
<a name="l00518"></a>00518         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520         rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)pvPortMalloc(<span class="keyword">sizeof</span>(*rfm22b_dev));
<a name="l00521"></a>00521         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> = 0;
<a name="l00522"></a>00522         <span class="keywordflow">if</span> (!rfm22b_dev) <span class="keywordflow">return</span>(NULL);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acffebca4153749f86cd6237ac4482f3a">magic</a> = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga25f646fb6abded1e9f076ca00e13cbeca465296d21d23694d7d9f2f7486929f77">PIOS_RFM22B_DEV_MAGIC</a>;
<a name="l00525"></a>00525         <span class="keywordflow">return</span>(rfm22b_dev);
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 <span class="preprocessor">#else</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> pios_rfm22b_devs[PIOS_RFM22B_MAX_DEVS];
<a name="l00529"></a>00529 <span class="keyword">static</span> uint8_t pios_rfm22b_num_devs;
<a name="l00530"></a>00530 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * PIOS_RFM22B_alloc(<span class="keywordtype">void</span>)
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (pios_rfm22b_num_devs &gt;= PIOS_RFM22B_MAX_DEVS)
<a name="l00535"></a>00535                 <span class="keywordflow">return</span> NULL;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537         rfm22b_dev = &amp;pios_rfm22b_devs[pios_rfm22b_num_devs++];
<a name="l00538"></a>00538         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acffebca4153749f86cd6237ac4482f3a">magic</a> = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga25f646fb6abded1e9f076ca00e13cbeca465296d21d23694d7d9f2f7486929f77">PIOS_RFM22B_DEV_MAGIC</a>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540         <span class="keywordflow">return</span> (rfm22b_dev);
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 <span class="preprocessor">#endif</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>
<a name="l00544"></a>00544 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * g_rfm22b_dev =  NULL;
<a name="l00545"></a>00545 
<a name="l00549"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga5d053a5a8be93e0b0d4c61061cc74464">00549</a> int32_t <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga5d053a5a8be93e0b0d4c61061cc74464">PIOS_RFM22B_Init</a>(uint32_t *rfm22b_id, uint32_t <a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, uint32_t <a class="code" href="structpios__rfm22b__dev.html#a4e0db01351dfac40720073969a7fafae">slave_num</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__cfg.html">pios_rfm22b_cfg</a> *<a class="code" href="structpios__rfm22b__dev.html#a2fc3047fbb17be7e546cab4e24ee2b28">cfg</a>)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551         PIOS_DEBUG_Assert(rfm22b_id);
<a name="l00552"></a>00552         PIOS_DEBUG_Assert(cfg);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">// Allocate the device structure.</span>
<a name="l00555"></a>00555         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *) PIOS_RFM22B_alloc();
<a name="l00556"></a>00556         <span class="keywordflow">if</span> (!rfm22b_dev)
<a name="l00557"></a>00557                 <span class="keywordflow">return</span>(-1);
<a name="l00558"></a>00558         *rfm22b_id = (uint32_t)rfm22b_dev;
<a name="l00559"></a>00559         g_rfm22b_dev = rfm22b_dev;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561         <span class="comment">// Store the SPI handle</span>
<a name="l00562"></a>00562         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4e0db01351dfac40720073969a7fafae">slave_num</a> = <a class="code" href="structpios__rfm22b__dev.html#a4e0db01351dfac40720073969a7fafae">slave_num</a>;
<a name="l00563"></a>00563         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> = <a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565         <span class="comment">// Initialize our configuration parameters</span>
<a name="l00566"></a>00566         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a37c2eab9f05656b3ef5690689b0e06c9">coordinator</a> = <span class="keyword">false</span>;
<a name="l00567"></a>00567         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a44f9d9da0b1740ea9f077873f766ee45">send_ppm</a> = <span class="keyword">false</span>;
<a name="l00568"></a>00568         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a> = RFM22B_DEFAULT_RX_DATARATE;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <span class="comment">// Initialize the com callbacks.</span>
<a name="l00571"></a>00571         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abed55ffe3e0e2832d958e692f9310b6e">com_config_cb</a> = NULL;
<a name="l00572"></a>00572         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac170322ec2f96932e0f060aa68b6bd12">rx_in_cb</a> = NULL;
<a name="l00573"></a>00573         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab861d6c14abc749f20e45226bd606840">tx_out_cb</a> = NULL;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         <span class="comment">// Initialize the stats.</span>
<a name="l00576"></a>00576         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a9ed3bba20847dcee3b0397c210b22d3d">packets_per_sec</a> = 0;
<a name="l00577"></a>00577         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa9b17c04f89e42496f776f7cac5b549d">rx_good</a> = 0;
<a name="l00578"></a>00578         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff132143dc1206acab2aa0972429aaba">rx_corrected</a> = 0;
<a name="l00579"></a>00579         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa732f9f0055fff25329e07f6b4cce221">rx_error</a> = 0;
<a name="l00580"></a>00580         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a10156bfde7480e15c39ba077da5f687f">rx_missed</a> = 0;
<a name="l00581"></a>00581         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a40ecedccb96317654da5118ca167bfe4">tx_dropped</a> = 0;
<a name="l00582"></a>00582         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aad4359c902f65048dd74b5b5a4d9482d">tx_resent</a> = 0;
<a name="l00583"></a>00583         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8d5014c62b137509e9a5a51fe9e1acae">resets</a> = 0;
<a name="l00584"></a>00584         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#ae710ec372ffa9365a23fcd2d8f9f8e0e">timeouts</a> = 0;
<a name="l00585"></a>00585         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8d32fed579e3be2fbc354ab176670af2">link_quality</a> = 0;
<a name="l00586"></a>00586         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#af292c65ed2be928fd2c5e4639c2cf025">rssi</a> = 0;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="comment">// Create the event queue</span>
<a name="l00589"></a>00589         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a0c5971f25ea4ab50328105098e54eda7">eventQueue</a> = xQueueCreate(EVENT_QUEUE_SIZE, <span class="keyword">sizeof</span>(<span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a>));
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="comment">// Bind the configuration to the device instance</span>
<a name="l00592"></a>00592         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2fc3047fbb17be7e546cab4e24ee2b28">cfg</a> = *<a class="code" href="structpios__rfm22b__dev.html#a2fc3047fbb17be7e546cab4e24ee2b28">cfg</a>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594         <span class="comment">// Create a semaphore to know if an ISR needs responding to</span>
<a name="l00595"></a>00595         vSemaphoreCreateBinary( rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9e681596408e8e6d5387ecdd43acfe62">isrPending</a> );
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         <span class="comment">// Create our (hopefully) unique 32 bit id from the processor serial number.</span>
<a name="l00598"></a>00598         uint8_t crcs[] = { 0, 0, 0, 0 };
<a name="l00599"></a>00599         {
<a name="l00600"></a>00600                 <span class="keywordtype">char</span> serial_no_str[33];
<a name="l00601"></a>00601                 <a class="code" href="group___p_i_o_s___s_y_s.html#ga06a0b401f67617fc771fa8b32d43e7da">PIOS_SYS_SerialNumberGet</a>(serial_no_str);
<a name="l00602"></a>00602                 <span class="comment">// Create a 32 bit value using 4 8 bit CRC values.</span>
<a name="l00603"></a>00603                 <span class="keywordflow">for</span> (uint8_t i = 0; serial_no_str[i] != 0; ++i)
<a name="l00604"></a>00604                         crcs[i % 4] = <a class="code" href="group___p_i_o_s___c_r_c.html#ga7a3781ede0c0bbd4c15f6513597e09f8">PIOS_CRC_updateByte</a>(crcs[i % 4], serial_no_str[i]);
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac608ccb62cbd144c8053aaacb8c14fcf">deviceID</a> = crcs[0] | crcs[1] &lt;&lt; 8 | crcs[2] &lt;&lt; 16 | crcs[3] &lt;&lt; 24;
<a name="l00607"></a>00607         DEBUG_PRINTF(2, <span class="stringliteral">&quot;RF device ID: %x\n\r&quot;</span>, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac608ccb62cbd144c8053aaacb8c14fcf">deviceID</a>);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609         <span class="comment">// Initialize the external interrupt.</span>
<a name="l00610"></a>00610         <a class="code" href="group___p_i_o_s___e_x_t_i.html#gaa35c400a680d3af7d1ec1a0a3f91d93f">PIOS_EXTI_Init</a>(cfg-&gt;<a class="code" href="structpios__rfm22b__cfg.html#af86691ce02d622888addd9f0474ef4ec">exti_cfg</a>);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         <span class="comment">// Register the watchdog timer for the radio driver task</span>
<a name="l00613"></a>00613 <span class="preprocessor">#ifdef PIOS_WDG_RFM22B</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span>        <a class="code" href="group___p_i_o_s___w_d_g.html#ga181128f13ffdec27ea07e13fc4a4e1ab" title="Register a module against the watchdog.">PIOS_WDG_RegisterFlag</a>(PIOS_WDG_RFM22B);
<a name="l00615"></a>00615 <span class="preprocessor">#endif </span><span class="comment">/* PIOS_WDG_RFM22B */</span>
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         <span class="comment">// Initialize the ECC library.</span>
<a name="l00618"></a>00618         <a class="code" href="ecc_8h.html#a8a34d4f9d615ce945b4e6a2c01f27fa8">initialize_ecc</a>();
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="comment">// Set the state to initializing.</span>
<a name="l00621"></a>00621         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a> = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa435d2d141dac949cbbb311066ff1d84e">RFM22B_STATE_UNINITIALIZED</a>;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         <span class="comment">// Initialize the radio device.</span>
<a name="l00624"></a>00624         <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga4327e22931b06353b8340bfc91abdc59">PIOS_RFM22B_InjectEvent</a>(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>, <span class="keyword">false</span>);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         <span class="comment">// Start the driver task.  This task controls the radio state machine and removed all of the IO from the IRQ handler.</span>
<a name="l00627"></a>00627         xTaskCreate(PIOS_RFM22B_Task, (<span class="keywordtype">signed</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;PIOS_RFM22B_Task&quot;</span>, STACK_SIZE_BYTES, (<span class="keywordtype">void</span>*)rfm22b_dev, TASK_PRIORITY, &amp;(rfm22b_dev-&gt;taskHandle));
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         <span class="keywordflow">return</span>(0);
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 
<a name="l00635"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga34f82a23ad429841e5f212fc0c221131">00635</a> <span class="keywordtype">bool</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga34f82a23ad429841e5f212fc0c221131">PIOS_RFM22_EXT_Int</a>(<span class="keywordtype">void</span>)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(g_rfm22b_dev))
<a name="l00638"></a>00638             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="comment">// Inject an interrupt event into the state machine.</span>
<a name="l00641"></a>00641         <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga4327e22931b06353b8340bfc91abdc59">PIOS_RFM22B_InjectEvent</a>(g_rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>, <span class="keyword">true</span>);
<a name="l00642"></a>00642         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00651"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga4327e22931b06353b8340bfc91abdc59">00651</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga4327e22931b06353b8340bfc91abdc59">PIOS_RFM22B_InjectEvent</a>(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event, <span class="keywordtype">bool</span> inISR)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         <span class="comment">// Store the event.</span>
<a name="l00655"></a>00655         <span class="keywordflow">if</span> (xQueueSend(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a0c5971f25ea4ab50328105098e54eda7">eventQueue</a>, &amp;event, portMAX_DELAY) != pdTRUE)
<a name="l00656"></a>00656                 <span class="keywordflow">return</span>;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         <span class="comment">// Signal the semaphore to wake up the handler thread.</span>
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (inISR) {
<a name="l00660"></a>00660                 portBASE_TYPE pxHigherPriorityTaskWoken;
<a name="l00661"></a>00661                 <span class="keywordflow">if</span> (xSemaphoreGiveFromISR(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9e681596408e8e6d5387ecdd43acfe62">isrPending</a>, &amp;pxHigherPriorityTaskWoken) != pdTRUE) {
<a name="l00662"></a>00662                         <span class="comment">// Something went fairly seriously wrong</span>
<a name="l00663"></a>00663                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a538dcdf62ddc3430e172d88eb252dc0d">errors</a>++;
<a name="l00664"></a>00664                 }
<a name="l00665"></a>00665                 portEND_SWITCHING_ISR(pxHigherPriorityTaskWoken);
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667         <span class="keywordflow">else</span>
<a name="l00668"></a>00668         {
<a name="l00669"></a>00669                 <span class="keywordflow">if</span> (xSemaphoreGive(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9e681596408e8e6d5387ecdd43acfe62">isrPending</a>) != pdTRUE) {
<a name="l00670"></a>00670                         <span class="comment">// Something went fairly seriously wrong</span>
<a name="l00671"></a>00671                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a538dcdf62ddc3430e172d88eb252dc0d">errors</a>++;
<a name="l00672"></a>00672                 }
<a name="l00673"></a>00673         }
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00681"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga48b5ed8668584cdfbbbec3e07156e5d8">00681</a> uint32_t <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga48b5ed8668584cdfbbbec3e07156e5d8">PIOS_RFM22B_DeviceID</a>(uint32_t rfm22b_id)
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00685"></a>00685                 <span class="keywordflow">return</span> rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac608ccb62cbd144c8053aaacb8c14fcf">deviceID</a>;
<a name="l00686"></a>00686         <span class="keywordflow">else</span>
<a name="l00687"></a>00687                 <span class="keywordflow">return</span> 0;
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00695"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2230c70e99a4c87dcad0ea19351ddc0a">00695</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2230c70e99a4c87dcad0ea19351ddc0a">PIOS_RFM22B_SetTxPower</a>(uint32_t rfm22b_id, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaad7a4f0b388c5c9323bb4ced4e9356cc">rfm22b_tx_power</a> tx_pwr)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00698"></a>00698         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00699"></a>00699                 <span class="keywordflow">return</span>;
<a name="l00700"></a>00700         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3ca116567675ce2311161483fe4c9ff4">tx_power</a> = tx_pwr;
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00709"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga6b7275549a5178f70500c1705d85e30a">00709</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga6b7275549a5178f70500c1705d85e30a">PIOS_RFM22B_SetFrequencyRange</a>(uint32_t rfm22b_id, uint32_t <a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a>, uint32_t <a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a>)
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00712"></a>00712         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00713"></a>00713                 <span class="keywordflow">return</span>;
<a name="l00714"></a>00714         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a> = <a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a>;
<a name="l00715"></a>00715         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a> = <a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a>;
<a name="l00716"></a>00716         rfm22_setNominalCarrierFrequency(rfm22b_dev, (max_frequency - min_frequency) / 2);
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00724"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2e2954db8900f7f997170fbc5047e748">00724</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2e2954db8900f7f997170fbc5047e748">PIOS_RFM22B_SetDestinationId</a>(uint32_t rfm22b_id, uint32_t dest_id)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00727"></a>00727         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00728"></a>00728                 <span class="keywordflow">return</span>;
<a name="l00729"></a>00729         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a> = (dest_id == 0) ? 0xffffffff : dest_id;
<a name="l00730"></a>00730         <span class="comment">// The first slot is reserved for our current pairID</span>
<a name="l00731"></a>00731         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[0].<a class="code" href="structrfm22b__pair__stats.html#aecbce2c6a0ece945bc66e3fc007a25e2">pairID</a> = dest_id;
<a name="l00732"></a>00732         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[0].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a> = -127;
<a name="l00733"></a>00733         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[0].<a class="code" href="structrfm22b__pair__stats.html#a370cbe1c41f8039f09e8f8f30d59591b">afc_correction</a> = 0;
<a name="l00734"></a>00734         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[0].<a class="code" href="structrfm22b__pair__stats.html#a54401550bc26e4923636667ba5df8d34">lastContact</a> = 0;
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00742"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaf27178ba026097c91627b50f862f388e">00742</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaf27178ba026097c91627b50f862f388e">PIOS_RFM22B_SetCoordinator</a>(uint32_t rfm22b_id, <span class="keywordtype">bool</span> <a class="code" href="structpios__rfm22b__dev.html#a37c2eab9f05656b3ef5690689b0e06c9">coordinator</a>)
<a name="l00743"></a>00743 {
<a name="l00744"></a>00744         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00745"></a>00745         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00746"></a>00746                 <span class="keywordflow">return</span>;
<a name="l00747"></a>00747         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a37c2eab9f05656b3ef5690689b0e06c9">coordinator</a> = <a class="code" href="structpios__rfm22b__dev.html#a37c2eab9f05656b3ef5690689b0e06c9">coordinator</a>;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <span class="comment">// Re-initialize the radio device.</span>
<a name="l00750"></a>00750         <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga4327e22931b06353b8340bfc91abdc59">PIOS_RFM22B_InjectEvent</a>(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>, <span class="keyword">false</span>);
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00759"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga74f4ab9cf6b2337fc517addf32e432d7">00759</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga74f4ab9cf6b2337fc517addf32e432d7">PIOS_RFM22B_SetRemoteComConfig</a>(uint32_t rfm22b_id, <a class="code" href="group___o_p_link_settings.html#ga1511abaff051d1cd559ddd52fea0bfa8">OPLinkSettingsOutputConnectionOptions</a> com_port, <a class="code" href="group___o_p_link_settings.html#gaf4886a2c0a8f8a79c93d27c94ee503ba">OPLinkSettingsComSpeedOptions</a> com_speed)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00762"></a>00762         <span class="keywordflow">if</span>(!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00763"></a>00763                 <span class="keywordflow">return</span>;
<a name="l00764"></a>00764         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>.<a class="code" href="struct_p_h_connection_packet.html#ae3b874c83f519f62b7ee56a805c527d5">port</a> = com_port;
<a name="l00765"></a>00765         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>.<a class="code" href="struct_p_h_connection_packet.html#aba21090aa4d393dc1d6e85406efa1c4b">com_speed</a> = com_speed;
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00773"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaa2f467cefea23fca9354817c336c2c7f">00773</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaa2f467cefea23fca9354817c336c2c7f">PIOS_RFM22B_SetComConfigCallback</a>(uint32_t rfm22b_id, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaa8a316480e010f5e383d29257c0686cd">PIOS_RFM22B_ComConfigCallback</a> cb)
<a name="l00774"></a>00774 {
<a name="l00775"></a>00775         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00776"></a>00776         <span class="keywordflow">if</span>(!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00777"></a>00777                 <span class="keywordflow">return</span>;
<a name="l00778"></a>00778         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abed55ffe3e0e2832d958e692f9310b6e">com_config_cb</a> = cb;
<a name="l00779"></a>00779 }
<a name="l00780"></a>00780 
<a name="l00786"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga7993764aede415744ac90bf71b2a84f5">00786</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga7993764aede415744ac90bf71b2a84f5">PIOS_RFM22B_GetStats</a>(uint32_t rfm22b_id, <span class="keyword">struct</span> <a class="code" href="structrfm22b__stats.html">rfm22b_stats</a> *<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>) {
<a name="l00787"></a>00787         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00788"></a>00788         <span class="keywordflow">if</span>(!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00789"></a>00789                 <span class="keywordflow">return</span>;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         <span class="comment">// Calculate the current link quality</span>
<a name="l00792"></a>00792         rfm22_calculateLinkQuality(rfm22b_dev);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <span class="comment">// We are connected if our destination ID is in the pair stats.</span>
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a> != 0xffffffff)
<a name="l00796"></a>00796                 <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; OPLINKSTATUS_PAIRIDS_NUMELEM; ++i)
<a name="l00797"></a>00797                 {
<a name="l00798"></a>00798                         <span class="keywordflow">if</span> ((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#aecbce2c6a0ece945bc66e3fc007a25e2">pairID</a> == rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a>) &amp;&amp;
<a name="l00799"></a>00799                             (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a> &gt; -127))
<a name="l00800"></a>00800                         {
<a name="l00801"></a>00801                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#af292c65ed2be928fd2c5e4639c2cf025">rssi</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a>;
<a name="l00802"></a>00802                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a5e40de4c13a984c6342307cb88d33675">afc_correction</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a370cbe1c41f8039f09e8f8f30d59591b">afc_correction</a>;
<a name="l00803"></a>00803                                 <span class="keywordflow">break</span>;
<a name="l00804"></a>00804                         }
<a name="l00805"></a>00805                 }
<a name="l00806"></a>00806         *stats = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>;
<a name="l00807"></a>00807 }
<a name="l00808"></a>00808 
<a name="l00816"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2c3963442036bf6e581c9c4e2e6447b9">00816</a> uint8_t <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2c3963442036bf6e581c9c4e2e6447b9">PIOS_RFM2B_GetPairStats</a>(uint32_t rfm22b_id, uint32_t *device_ids, int8_t *RSSIs, uint8_t max_pairs)
<a name="l00817"></a>00817 {
<a name="l00818"></a>00818         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00819"></a>00819         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00820"></a>00820                 <span class="keywordflow">return</span> 0;
<a name="l00821"></a>00821 
<a name="l00822"></a>00822         uint8_t mp = (max_pairs &gt;= OPLINKSTATUS_PAIRIDS_NUMELEM) ? max_pairs : OPLINKSTATUS_PAIRIDS_NUMELEM;
<a name="l00823"></a>00823         <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; mp; ++i)
<a name="l00824"></a>00824         {
<a name="l00825"></a>00825                 device_ids[i] = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#aecbce2c6a0ece945bc66e3fc007a25e2">pairID</a>;
<a name="l00826"></a>00826                 RSSIs[i] = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a>;
<a name="l00827"></a>00827         }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         <span class="keywordflow">return</span> mp;
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00837"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga5d2ba4c573bc63f53ccb80f3bdbbc8e4">00837</a> <span class="keywordtype">bool</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga5d2ba4c573bc63f53ccb80f3bdbbc8e4">PIOS_RFM22B_LinkStatus</a>(uint32_t rfm22b_id)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l00840"></a>00840         <span class="keywordflow">if</span>(!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00841"></a>00841                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00842"></a>00842         <span class="keywordflow">return</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> == <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>) &amp;&amp; (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8d32fed579e3be2fbc354ab176670af2">link_quality</a> &gt; RFM22B_LINK_QUALITY_THRESHOLD);
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 
<a name="l00848"></a>00848 <span class="keyword">static</span> <span class="keywordtype">void</span> PIOS_RFM22B_Task(<span class="keywordtype">void</span> *parameters)
<a name="l00849"></a>00849 {
<a name="l00850"></a>00850         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)parameters;
<a name="l00851"></a>00851         <span class="keywordflow">if</span> (!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l00852"></a>00852             <span class="keywordflow">return</span>;
<a name="l00853"></a>00853         portTickType lastEventTicks = xTaskGetTickCount();
<a name="l00854"></a>00854         portTickType lastStatusTicks = lastEventTicks;
<a name="l00855"></a>00855         portTickType lastPPMTicks = lastEventTicks;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         <span class="keywordflow">while</span>(1)
<a name="l00858"></a>00858         {
<a name="l00859"></a>00859 <span class="preprocessor">#ifdef PIOS_WDG_RFM22B</span>
<a name="l00860"></a>00860 <span class="preprocessor"></span>                <span class="comment">// Update the watchdog timer</span>
<a name="l00861"></a>00861                 <a class="code" href="group___p_i_o_s___w_d_g.html#ga4698d93015624e320b5c7c980c4edecd" title="Function called by modules to indicate they are still running.">PIOS_WDG_UpdateFlag</a>(PIOS_WDG_RFM22B);
<a name="l00862"></a>00862 <span class="preprocessor">#endif </span><span class="comment">/* PIOS_WDG_RFM22B */</span>
<a name="l00863"></a>00863 
<a name="l00864"></a>00864                 <span class="comment">// Wait for a signal indicating an external interrupt or a pending send/receive request.</span>
<a name="l00865"></a>00865                 <span class="keywordflow">if</span> (xSemaphoreTake(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9e681596408e8e6d5387ecdd43acfe62">isrPending</a>,  ISR_TIMEOUT / portTICK_RATE_MS) == pdTRUE) {
<a name="l00866"></a>00866                         lastEventTicks = xTaskGetTickCount();
<a name="l00867"></a>00867 
<a name="l00868"></a>00868                         <span class="comment">// Process events through the state machine.</span>
<a name="l00869"></a>00869                         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event;
<a name="l00870"></a>00870                         <span class="keywordflow">while</span> (xQueueReceive(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a0c5971f25ea4ab50328105098e54eda7">eventQueue</a>, &amp;event, 0) == pdTRUE)
<a name="l00871"></a>00871                         {
<a name="l00872"></a>00872                                 <span class="keywordflow">if</span> ((event == <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a3e4ec4cdace68a2fc496863553f1b21e">RFM22B_EVENT_INT_RECEIVED</a>) &amp;&amp;
<a name="l00873"></a>00873                                     ((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a> == <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa435d2d141dac949cbbb311066ff1d84e">RFM22B_STATE_UNINITIALIZED</a>) || (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a> == <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaf31f5344b7afb099b3105bfff4debdcaa7b299487dbe220f59e1684dd72672fd3">RFM22B_STATE_INITIALIZING</a>)))
<a name="l00874"></a>00874                                         <span class="keywordflow">continue</span>;
<a name="l00875"></a>00875                                 rfm22_process_event(rfm22b_dev, event);
<a name="l00876"></a>00876                         }
<a name="l00877"></a>00877                 }
<a name="l00878"></a>00878                 <span class="keywordflow">else</span>
<a name="l00879"></a>00879                 {
<a name="l00880"></a>00880                         <span class="comment">// Has it been too long since the last event?</span>
<a name="l00881"></a>00881                         portTickType curTicks = xTaskGetTickCount();
<a name="l00882"></a>00882                         <span class="keywordflow">if</span> (timeDifferenceMs(lastEventTicks, curTicks) &gt; PIOS_RFM22B_SUPERVISOR_TIMEOUT)
<a name="l00883"></a>00883                         {
<a name="l00884"></a>00884                                 <span class="comment">// Transsition through an error event.</span>
<a name="l00885"></a>00885                                 rfm22_process_event(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>);
<a name="l00886"></a>00886 
<a name="l00887"></a>00887                                 <span class="comment">// Clear the event queue.</span>
<a name="l00888"></a>00888                                 <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event;
<a name="l00889"></a>00889                                 <span class="keywordflow">while</span> (xQueueReceive(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a0c5971f25ea4ab50328105098e54eda7">eventQueue</a>, &amp;event, 0) == pdTRUE)
<a name="l00890"></a>00890                                         ;
<a name="l00891"></a>00891                                 lastEventTicks = xTaskGetTickCount();
<a name="l00892"></a>00892                         }
<a name="l00893"></a>00893                 }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895                 portTickType curTicks = xTaskGetTickCount();
<a name="l00896"></a>00896                 <span class="comment">// Have we been sending this packet too long?</span>
<a name="l00897"></a>00897                 <span class="keywordflow">if</span> ((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> &gt; 0) &amp;&amp; (timeDifferenceMs(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a>, curTicks) &gt; (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab09ddb5c90f5e40bfe8b4be488144ef6">max_packet_time</a> * 3)))
<a name="l00898"></a>00898                         rfm22_process_event(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc66d582f00b8536c5a13a7ba02acda2">RFM22B_EVENT_TIMEOUT</a>);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900                 <span class="comment">// Have it been too long since we received a packet</span>
<a name="l00901"></a>00901                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> &gt; 0) &amp;&amp; (timeDifferenceMs(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a>, curTicks) &gt; DISCONNECT_TIMEOUT_MS))
<a name="l00902"></a>00902                         rfm22_process_event(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2af4356b8b7a94d19dc7023bdc33e87b62">RFM22B_EVENT_ERROR</a>);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904                 <span class="keywordflow">else</span>
<a name="l00905"></a>00905                 {
<a name="l00906"></a>00906                                 
<a name="l00907"></a>00907                         <span class="comment">// Are we waiting for an ACK?</span>
<a name="l00908"></a>00908                         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a>)
<a name="l00909"></a>00909                         {
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                                 <span class="comment">// Should we resend the packet?</span>
<a name="l00912"></a>00912                                 <span class="keywordflow">if</span> (timeDifferenceMs(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#af71e33856164ba7654a523173441ecb3">tx_complete_ticks</a>, curTicks) &gt; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad0342540c88cd117f4c82035cedb1f10">max_ack_delay</a>)
<a name="l00913"></a>00913                                 {
<a name="l00914"></a>00914                                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#af71e33856164ba7654a523173441ecb3">tx_complete_ticks</a> = curTicks;
<a name="l00915"></a>00915                                         rfm22_process_event(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a94e81215f6aa0f647dfa646a8ffbb0b5">RFM22B_EVENT_ACK_TIMEOUT</a>);
<a name="l00916"></a>00916                                 }
<a name="l00917"></a>00917                         }
<a name="l00918"></a>00918                         <span class="keywordflow">else</span>
<a name="l00919"></a>00919                         {
<a name="l00920"></a>00920 
<a name="l00921"></a>00921                                 <span class="comment">// Queue up a PPM packet if it&#39;s time.</span>
<a name="l00922"></a>00922                                 <span class="keywordflow">if</span> (timeDifferenceMs(lastPPMTicks, curTicks) &gt; PPM_UPDATE_PERIOD_MS)
<a name="l00923"></a>00923                                 {
<a name="l00924"></a>00924                                         rfm22_sendPPM(rfm22b_dev);
<a name="l00925"></a>00925                                         lastPPMTicks = curTicks;
<a name="l00926"></a>00926                                 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928                                 <span class="comment">// Queue up a status packet if it&#39;s time.</span>
<a name="l00929"></a>00929                                 <span class="keywordflow">if</span> (timeDifferenceMs(lastStatusTicks, curTicks) &gt; RADIOSTATS_UPDATE_PERIOD_MS)
<a name="l00930"></a>00930                                 {
<a name="l00931"></a>00931                                         rfm22_sendStatus(rfm22b_dev);
<a name="l00932"></a>00932                                         lastStatusTicks = curTicks;
<a name="l00933"></a>00933                                 }
<a name="l00934"></a>00934                         }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936                 }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938                 <span class="comment">// Send a packet if it&#39;s our time slice</span>
<a name="l00939"></a>00939                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = (((curTicks - rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad552e65c59e3873f29312042109562cd">time_to_send_offset</a>) &amp; 0x6) == 0);
<a name="l00940"></a>00940 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l00941"></a>00941 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a>)
<a name="l00942"></a>00942                         D4_LED_ON;
<a name="l00943"></a>00943                 <span class="keywordflow">else</span>
<a name="l00944"></a>00944                         D4_LED_OFF;
<a name="l00945"></a>00945 <span class="preprocessor">#endif</span>
<a name="l00946"></a>00946 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a>)
<a name="l00947"></a>00947                         rfm22_process_event(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>);
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949 }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951 <span class="comment">// ************************************</span>
<a name="l00952"></a>00952 <span class="comment">// radio datarate about 19200 Baud</span>
<a name="l00953"></a>00953 <span class="comment">// radio frequency deviation 45kHz</span>
<a name="l00954"></a>00954 <span class="comment">// radio receiver bandwidth 67kHz.</span>
<a name="l00955"></a>00955 <span class="comment">//</span>
<a name="l00956"></a>00956 <span class="comment">// Carson&#39;s rule:</span>
<a name="l00957"></a>00957 <span class="comment">//  The signal bandwidth is about 2(Delta-f + fm) ..</span>
<a name="l00958"></a>00958 <span class="comment">//</span>
<a name="l00959"></a>00959 <span class="comment">// Delta-f = frequency deviation</span>
<a name="l00960"></a>00960 <span class="comment">// fm = maximum frequency of the signal</span>
<a name="l00961"></a>00961 <span class="comment">//</span>
<a name="l00962"></a>00962 <span class="comment">// This gives 2(45 + 9.6) = 109.2kHz.</span>
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_setDatarate(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaa3e170044f27a00c422ee75f98130ef1">rfm22b_datarate</a> <a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a>, <span class="keywordtype">bool</span> data_whitening)
<a name="l00965"></a>00965 {
<a name="l00966"></a>00966         uint32_t datarate_bps = data_rate[<a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a>];
<a name="l00967"></a>00967         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab09ddb5c90f5e40bfe8b4be488144ef6">max_packet_time</a> = (uint16_t)((<span class="keywordtype">float</span>)(PIOS_PH_MAX_PACKET * 8 * 1000) / (<span class="keywordtype">float</span>)(datarate_bps) + 0.5);
<a name="l00968"></a>00968         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> == <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l00969"></a>00969         {
<a name="l00970"></a>00970                 <span class="comment">// Generate a pseudo-random number from 0-8 to add to the delay</span>
<a name="l00971"></a>00971                 uint8_t random = <a class="code" href="group___p_i_o_s___c_r_c.html#ga7a3781ede0c0bbd4c15f6513597e09f8">PIOS_CRC_updateByte</a>(0, (uint8_t)(xTaskGetTickCount() &amp; 0xff)) &amp; 0x03;
<a name="l00972"></a>00972                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad0342540c88cd117f4c82035cedb1f10">max_ack_delay</a> = (uint16_t)((<span class="keywordtype">float</span>)(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_packet_header.html">PHPacketHeader</a>) * 8 * 1000) / (float)(datarate_bps) + 0.5) * 4 + random;
<a name="l00973"></a>00973         }
<a name="l00974"></a>00974         <span class="keywordflow">else</span>
<a name="l00975"></a>00975                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad0342540c88cd117f4c82035cedb1f10">max_ack_delay</a> = CONNECT_ATTEMPT_PERIOD_MS;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977         <span class="comment">// rfm22_if_filter_bandwidth</span>
<a name="l00978"></a>00978         rfm22_write(rfm22b_dev, 0x1C, reg_1C[datarate]);
<a name="l00979"></a>00979 
<a name="l00980"></a>00980         <span class="comment">// rfm22_afc_loop_gearshift_override</span>
<a name="l00981"></a>00981         rfm22_write(rfm22b_dev, 0x1D, reg_1D[datarate]);
<a name="l00982"></a>00982         <span class="comment">// RFM22_afc_timing_control</span>
<a name="l00983"></a>00983         rfm22_write(rfm22b_dev, 0x1E, reg_1E[datarate]);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="comment">// RFM22_clk_recovery_gearshift_override</span>
<a name="l00986"></a>00986         rfm22_write(rfm22b_dev, 0x1F, reg_1F[datarate]);
<a name="l00987"></a>00987         <span class="comment">// rfm22_clk_recovery_oversampling_ratio</span>
<a name="l00988"></a>00988         rfm22_write(rfm22b_dev, 0x20, reg_20[datarate]);
<a name="l00989"></a>00989         <span class="comment">// rfm22_clk_recovery_offset2</span>
<a name="l00990"></a>00990         rfm22_write(rfm22b_dev, 0x21, reg_21[datarate]);
<a name="l00991"></a>00991         <span class="comment">// rfm22_clk_recovery_offset1</span>
<a name="l00992"></a>00992         rfm22_write(rfm22b_dev, 0x22, reg_22[datarate]);
<a name="l00993"></a>00993         <span class="comment">// rfm22_clk_recovery_offset0</span>
<a name="l00994"></a>00994         rfm22_write(rfm22b_dev, 0x23, reg_23[datarate]);
<a name="l00995"></a>00995         <span class="comment">// rfm22_clk_recovery_timing_loop_gain1</span>
<a name="l00996"></a>00996         rfm22_write(rfm22b_dev, 0x24, reg_24[datarate]);
<a name="l00997"></a>00997         <span class="comment">// rfm22_clk_recovery_timing_loop_gain0</span>
<a name="l00998"></a>00998         rfm22_write(rfm22b_dev, 0x25, reg_25[datarate]);
<a name="l00999"></a>00999 
<a name="l01000"></a>01000         <span class="comment">// rfm22_afc_limiter</span>
<a name="l01001"></a>01001         rfm22_write(rfm22b_dev, 0x2A, reg_2A[datarate]);
<a name="l01002"></a>01002 
<a name="l01003"></a>01003         <span class="comment">// rfm22_tx_data_rate1</span>
<a name="l01004"></a>01004         rfm22_write(rfm22b_dev, 0x6E, reg_6E[datarate]);
<a name="l01005"></a>01005         <span class="comment">// rfm22_tx_data_rate0</span>
<a name="l01006"></a>01006         rfm22_write(rfm22b_dev, 0x6F, reg_6F[datarate]);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008         <span class="keywordflow">if</span> (!data_whitening)
<a name="l01009"></a>01009                 <span class="comment">// rfm22_modulation_mode_control1</span>
<a name="l01010"></a>01010                 rfm22_write(rfm22b_dev, 0x70, reg_70[datarate] &amp; ~RFM22_mmc1_enwhite);
<a name="l01011"></a>01011         <span class="keywordflow">else</span>
<a name="l01012"></a>01012                 <span class="comment">// rfm22_modulation_mode_control1</span>
<a name="l01013"></a>01013                 rfm22_write(rfm22b_dev, 0x70, reg_70[datarate] |  RFM22_mmc1_enwhite);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015         <span class="comment">// rfm22_modulation_mode_control2</span>
<a name="l01016"></a>01016         rfm22_write(rfm22b_dev, 0x71, reg_71[datarate]);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018         <span class="comment">// rfm22_frequency_deviation</span>
<a name="l01019"></a>01019         rfm22_write(rfm22b_dev, 0x72, reg_72[datarate]);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         rfm22_write(rfm22b_dev, RFM22_ook_counter_value1, 0x00);
<a name="l01022"></a>01022         rfm22_write(rfm22b_dev, RFM22_ook_counter_value2, 0x00);
<a name="l01023"></a>01023 }
<a name="l01024"></a>01024 
<a name="l01025"></a><a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga9f3c01f66fd57433e99bc863554a9a19">01025</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga9f3c01f66fd57433e99bc863554a9a19">PIOS_RFM22B_SetDatarate</a>(uint32_t rfm22b_id, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaa3e170044f27a00c422ee75f98130ef1">rfm22b_datarate</a> datarate, <span class="keywordtype">bool</span> data_whitening)
<a name="l01026"></a>01026 {
<a name="l01027"></a>01027         <span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> * rfm22b_dev = (<span class="keyword">struct </span><a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *)rfm22b_id;
<a name="l01028"></a>01028         <span class="keywordflow">if</span>(!<a class="code" href="group___p_i_o_s___r_f_m22_b.html#gadb74603103aaab46ac72a08665bf0047">PIOS_RFM22B_validate</a>(rfm22b_dev))
<a name="l01029"></a>01029                 <span class="keywordflow">return</span>;
<a name="l01030"></a>01030         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a> = <a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a>;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032         <span class="comment">// Re-initialize the radio device.</span>
<a name="l01033"></a>01033         <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga4327e22931b06353b8340bfc91abdc59">PIOS_RFM22B_InjectEvent</a>(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>, <span class="keyword">false</span>);
<a name="l01034"></a>01034 }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 <span class="comment">// ************************************</span>
<a name="l01037"></a>01037 <span class="comment">// SPI read/write</span>
<a name="l01038"></a>01038 
<a name="l01040"></a>01040 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_assertCs(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01041"></a>01041 {
<a name="l01042"></a>01042         <a class="code" href="group___p_i_o_s___d_e_l_a_y.html#ga70d41fcf58bbbd18a9b6cd365d0f2dab">PIOS_DELAY_WaituS</a>(1);
<a name="l01043"></a>01043         <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> != 0)
<a name="l01044"></a>01044                 <a class="code" href="group___p_i_o_s___s_p_i.html#gaae1c8b2fa4574c575994c1fd591233a6">PIOS_SPI_RC_PinSet</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4e0db01351dfac40720073969a7fafae">slave_num</a>, 0);
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01048"></a>01048 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_deassertCs(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050         <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> != 0)
<a name="l01051"></a>01051                 <a class="code" href="group___p_i_o_s___s_p_i.html#gaae1c8b2fa4574c575994c1fd591233a6">PIOS_SPI_RC_PinSet</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4e0db01351dfac40720073969a7fafae">slave_num</a>, 1);
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01055"></a>01055 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_claimBus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057         <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> != 0)
<a name="l01058"></a>01058                 <a class="code" href="group___p_i_o_s___s_p_i.html#ga307f60532c61b56c285ce5d680cb14c5">PIOS_SPI_ClaimBus</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>);
<a name="l01059"></a>01059 }
<a name="l01060"></a>01060 
<a name="l01062"></a>01062 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_releaseBus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064         <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> != 0)
<a name="l01065"></a>01065                 <a class="code" href="group___p_i_o_s___s_p_i.html#ga117fbed6d00c5404e9414ab72175e1c8">PIOS_SPI_ReleaseBus</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>);
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01073"></a>01073 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_write(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint8_t addr, uint8_t data)
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075         rfm22_claimBus(rfm22b_dev);
<a name="l01076"></a>01076         rfm22_assertCs(rfm22b_dev);
<a name="l01077"></a>01077         uint8_t buf[2] = {addr | 0x80, data};
<a name="l01078"></a>01078         <a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, buf, NULL, <span class="keyword">sizeof</span>(buf), NULL);
<a name="l01079"></a>01079         rfm22_deassertCs(rfm22b_dev);
<a name="l01080"></a>01080         rfm22_releaseBus(rfm22b_dev);
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01103"></a>01103 <span class="keyword">static</span> uint8_t rfm22_read(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint8_t addr)
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105         uint8_t in[2];  
<a name="l01106"></a>01106         uint8_t out[2] = {addr &amp; 0x7f, 0xFF};
<a name="l01107"></a>01107         rfm22_claimBus(rfm22b_dev);
<a name="l01108"></a>01108         rfm22_assertCs(rfm22b_dev);
<a name="l01109"></a>01109         <a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, out, in, <span class="keyword">sizeof</span>(out), NULL);
<a name="l01110"></a>01110         rfm22_deassertCs(rfm22b_dev);
<a name="l01111"></a>01111         rfm22_releaseBus(rfm22b_dev);
<a name="l01112"></a>01112         <span class="keywordflow">return</span> in[1];
<a name="l01113"></a>01113 }
<a name="l01114"></a>01114 
<a name="l01120"></a>01120 <span class="keyword">static</span> uint8_t rfm22_read_noclaim(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint8_t addr)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122         uint8_t out[2] = {addr &amp; 0x7F, 0xFF};
<a name="l01123"></a>01123         uint8_t in[2];
<a name="l01124"></a>01124         rfm22_assertCs(rfm22b_dev);
<a name="l01125"></a>01125         <a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, out, in, <span class="keyword">sizeof</span>(out), NULL);
<a name="l01126"></a>01126         rfm22_deassertCs(rfm22b_dev);
<a name="l01127"></a>01127         <span class="keywordflow">return</span> in[1];
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 <span class="comment">// ************************************</span>
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_process_state_transition(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event)
<a name="l01133"></a>01133 {
<a name="l01134"></a>01134 
<a name="l01135"></a>01135         <span class="comment">// No event</span>
<a name="l01136"></a>01136         <span class="keywordflow">if</span> (event == <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>)
<a name="l01137"></a>01137                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139         <span class="comment">// Don&#39;t transition if there is no transition defined</span>
<a name="l01140"></a>01140         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaf31f5344b7afb099b3105bfff4debdca">pios_rfm22b_state</a> next_state = rfm22b_transitions[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a>].<a class="code" href="structpios__rfm22b__transition.html#a0ad51f078fbfc8b875e6a26efe0b218b">next_state</a>[event];
<a name="l01141"></a>01141         <span class="keywordflow">if</span> (!next_state)
<a name="l01142"></a>01142                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144         <span class="comment">/*</span>
<a name="l01145"></a>01145 <span class="comment">         * Move to the next state</span>
<a name="l01146"></a>01146 <span class="comment">         *</span>
<a name="l01147"></a>01147 <span class="comment">         * This is done prior to calling the new state&#39;s entry function to </span>
<a name="l01148"></a>01148 <span class="comment">         * guarantee that the entry function never depends on the previous</span>
<a name="l01149"></a>01149 <span class="comment">         * state.  This way, it cannot ever know what the previous state was.</span>
<a name="l01150"></a>01150 <span class="comment">         */</span>
<a name="l01151"></a>01151         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gaf31f5344b7afb099b3105bfff4debdca">pios_rfm22b_state</a> prev_state = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a>;
<a name="l01152"></a>01152         <span class="keywordflow">if</span> (prev_state) ;
<a name="l01153"></a>01153 
<a name="l01154"></a>01154         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a> = next_state;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156         <span class="comment">/* Call the entry function (if any) for the next state. */</span>
<a name="l01157"></a>01157         <span class="keywordflow">if</span> (rfm22b_transitions[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a>].<a class="code" href="structpios__rfm22b__transition.html#ae70a8d2b5835fa8b0056185581d9cbeb">entry_fn</a>)
<a name="l01158"></a>01158                 <span class="keywordflow">return</span> rfm22b_transitions[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2725ce50c0aad0fae1e4cee8e29072f7">state</a>].<a class="code" href="structpios__rfm22b__transition.html#ae70a8d2b5835fa8b0056185581d9cbeb">entry_fn</a>(rfm22b_dev);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_process_event(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> event)
<a name="l01164"></a>01164 {
<a name="l01165"></a>01165         <span class="comment">// Process all state transitions.</span>
<a name="l01166"></a>01166         <span class="keywordflow">while</span>(event != <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>)
<a name="l01167"></a>01167                 <span class="keyword">event</span> = rfm22_process_state_transition(rfm22b_dev, event);
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 <span class="comment">// ************************************</span>
<a name="l01171"></a>01171 
<a name="l01172"></a>01172 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_setNominalCarrierFrequency(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, uint32_t <a class="code" href="structpios__rfm22b__dev.html#a1b85d9c8c4c8dc7ebb1449ce2febee0e">frequency_hz</a>)
<a name="l01173"></a>01173 {
<a name="l01174"></a>01174         <span class="keywordflow">if</span> (frequency_hz &lt; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a>)
<a name="l01175"></a>01175                 frequency_hz = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a>;
<a name="l01176"></a>01176         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frequency_hz &gt; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a>)
<a name="l01177"></a>01177                 frequency_hz = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a>;
<a name="l01178"></a>01178 
<a name="l01179"></a>01179         <span class="comment">// holds the hbsel (1 or 2)</span>
<a name="l01180"></a>01180         uint8_t hbsel;
<a name="l01181"></a>01181         <span class="keywordflow">if</span> (frequency_hz &lt; 480000000)
<a name="l01182"></a>01182                 hbsel = 1;
<a name="l01183"></a>01183         <span class="keywordflow">else</span>
<a name="l01184"></a>01184                 hbsel = 2;
<a name="l01185"></a>01185         uint8_t fb = (uint8_t)(frequency_hz / (10000000 * hbsel));
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         uint32_t fc = (uint32_t)(frequency_hz - (10000000 * hbsel * fb));
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         fc = (fc * 64u) / (10000ul * hbsel);
<a name="l01190"></a>01190         fb -= 24;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192         <span class="keywordflow">if</span> (hbsel &gt; 1)
<a name="l01193"></a>01193                 fb |= RFM22_fbs_hbsel;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195         fb |= RFM22_fbs_sbse;   <span class="comment">// is this the RX LO polarity?</span>
<a name="l01196"></a>01196 
<a name="l01197"></a>01197         <span class="comment">// frequency hopping channel (0-255)</span>
<a name="l01198"></a>01198         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8cc9611e61bcaf29852b83cffa87ccd6">frequency_step_size</a> = 156.25f * hbsel;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200         <span class="comment">// frequency hopping channel (0-255)</span>
<a name="l01201"></a>01201         rfm22_write(rfm22b_dev, RFM22_frequency_hopping_channel_select, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a27f8f42b03439de7810e39e4240cc9dc">frequency_hop_channel</a>);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         <span class="comment">// no frequency offset</span>
<a name="l01204"></a>01204         rfm22_write(rfm22b_dev, RFM22_frequency_offset1, 0);
<a name="l01205"></a>01205         <span class="comment">// no frequency offset</span>
<a name="l01206"></a>01206         rfm22_write(rfm22b_dev, RFM22_frequency_offset2, 0);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         <span class="comment">// set the carrier frequency</span>
<a name="l01209"></a>01209         rfm22_write(rfm22b_dev, RFM22_frequency_band_select, fb);
<a name="l01210"></a>01210         rfm22_write(rfm22b_dev, RFM22_nominal_carrier_frequency1, fc &gt;&gt; 8);
<a name="l01211"></a>01211         rfm22_write(rfm22b_dev, RFM22_nominal_carrier_frequency0, fc &amp; 0xff);
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 <span class="comment">/*</span>
<a name="l01215"></a>01215 <span class="comment">static void rfm22_setFreqHopChannel(uint8_t channel)</span>
<a name="l01216"></a>01216 <span class="comment">{       // set the frequency hopping channel</span>
<a name="l01217"></a>01217 <span class="comment">        g_rfm22b_dev-&gt;frequency_hop_channel = channel;</span>
<a name="l01218"></a>01218 <span class="comment">        rfm22_write(rfm22b_dev, RFM22_frequency_hopping_channel_select, channel);</span>
<a name="l01219"></a>01219 <span class="comment">}</span>
<a name="l01220"></a>01220 <span class="comment"></span>
<a name="l01221"></a>01221 <span class="comment">static uint32_t rfm22_freqHopSize(void)</span>
<a name="l01222"></a>01222 <span class="comment">{       // return the frequency hopping step size</span>
<a name="l01223"></a>01223 <span class="comment">        return ((uint32_t)g_rfm22b_dev-&gt;frequency_hop_step_size_reg * 10000);</span>
<a name="l01224"></a>01224 <span class="comment">}</span>
<a name="l01225"></a>01225 <span class="comment">*/</span>
<a name="l01226"></a>01226 
<a name="l01227"></a>01227 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_calculateLinkQuality(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01228"></a>01228 {
<a name="l01229"></a>01229         <span class="comment">// Add the RX packet statistics</span>
<a name="l01230"></a>01230         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa9b17c04f89e42496f776f7cac5b549d">rx_good</a> = 0;
<a name="l01231"></a>01231         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff132143dc1206acab2aa0972429aaba">rx_corrected</a> = 0;
<a name="l01232"></a>01232         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa732f9f0055fff25329e07f6b4cce221">rx_error</a> = 0;
<a name="l01233"></a>01233         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aad4359c902f65048dd74b5b5a4d9482d">tx_resent</a> = 0;
<a name="l01234"></a>01234         <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; RFM22B_RX_PACKET_STATS_LEN; ++i)
<a name="l01235"></a>01235         {
<a name="l01236"></a>01236                 uint32_t <a class="code" href="_s_t_m32_f10x_2pios__tim_8c.html#a757344f09097232d715d55cbf9d61a43">val</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[i];
<a name="l01237"></a>01237                 <span class="keywordflow">for</span> (uint8_t j = 0; j &lt; 16; ++j)
<a name="l01238"></a>01238                 {
<a name="l01239"></a>01239                         <span class="keywordflow">switch</span> ((val &gt;&gt; (j * 2)) &amp; 0x3)
<a name="l01240"></a>01240                         {
<a name="l01241"></a>01241                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3a70ea6e91308b4c2944276f919e07af30">RFM22B_GOOD_RX_PACKET</a>:
<a name="l01242"></a>01242                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa9b17c04f89e42496f776f7cac5b549d">rx_good</a>++;
<a name="l01243"></a>01243                                 <span class="keywordflow">break</span>;
<a name="l01244"></a>01244                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3ab785f920fd4d6b5091a150bbbea5dc3f">RFM22B_CORRECTED_RX_PACKET</a>:
<a name="l01245"></a>01245                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff132143dc1206acab2aa0972429aaba">rx_corrected</a>++;
<a name="l01246"></a>01246                                 <span class="keywordflow">break</span>;
<a name="l01247"></a>01247                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3a275f3866391d28d8a46a71a50d4fae12">RFM22B_ERROR_RX_PACKET</a>:
<a name="l01248"></a>01248                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa732f9f0055fff25329e07f6b4cce221">rx_error</a>++;
<a name="l01249"></a>01249                                 <span class="keywordflow">break</span>;
<a name="l01250"></a>01250                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3a69529f54139da530e2a9df40d6be5cf1">RFM22B_RESENT_TX_PACKET</a>:
<a name="l01251"></a>01251                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aad4359c902f65048dd74b5b5a4d9482d">tx_resent</a>++;
<a name="l01252"></a>01252                                 <span class="keywordflow">break</span>;
<a name="l01253"></a>01253                         }
<a name="l01254"></a>01254                 }
<a name="l01255"></a>01255         }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257         <span class="comment">// Calculate the link quality metric, which is related to the number of good packets in relation to the number of bad packets.</span>
<a name="l01258"></a>01258         <span class="comment">// Note: This assumes that the number of packets sampled for the stats is 64.</span>
<a name="l01259"></a>01259         <span class="comment">// Using this equation, error and resent packets are counted as -2, and corrected packets are counted as -1.</span>
<a name="l01260"></a>01260         <span class="comment">// The range is 0 (all error or resent packets) to 128 (all good packets).</span>
<a name="l01261"></a>01261         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8d32fed579e3be2fbc354ab176670af2">link_quality</a> = 64 + rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa9b17c04f89e42496f776f7cac5b549d">rx_good</a> - rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aa732f9f0055fff25329e07f6b4cce221">rx_error</a> - rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aad4359c902f65048dd74b5b5a4d9482d">tx_resent</a>;
<a name="l01262"></a>01262 }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264 <span class="comment">// ************************************</span>
<a name="l01265"></a>01265 
<a name="l01266"></a>01266 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_setRxMode(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01267"></a>01267 {
<a name="l01268"></a>01268         <span class="comment">// Are we already in Rx mode?</span>
<a name="l01269"></a>01269         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a5d1bb77d70e2da36174e66d08e42cac6">in_rx_mode</a>)
<a name="l01270"></a>01270                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01271"></a>01271 
<a name="l01272"></a>01272         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 0;
<a name="l01273"></a>01273 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l01274"></a>01274 <span class="preprocessor"></span>        D2_LED_ON;
<a name="l01275"></a>01275         D3_LED_TOGGLE;
<a name="l01276"></a>01276 <span class="preprocessor">#endif</span>
<a name="l01277"></a>01277 <span class="preprocessor"></span>
<a name="l01278"></a>01278         <span class="comment">// disable interrupts</span>
<a name="l01279"></a>01279         rfm22_write(rfm22b_dev, RFM22_interrupt_enable1, 0x00);
<a name="l01280"></a>01280         rfm22_write(rfm22b_dev, RFM22_interrupt_enable2, 0x00);
<a name="l01281"></a>01281 
<a name="l01282"></a>01282         <span class="comment">// Switch to TUNE mode</span>
<a name="l01283"></a>01283         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl1, RFM22_opfc1_pllon);
<a name="l01284"></a>01284 
<a name="l01285"></a>01285         RX_LED_OFF;
<a name="l01286"></a>01286         TX_LED_OFF;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288         <span class="comment">// empty the rx buffer</span>
<a name="l01289"></a>01289         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> = 0;
<a name="l01290"></a>01290 
<a name="l01291"></a>01291         <span class="comment">// Clear the TX buffer.</span>
<a name="l01292"></a>01292         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> = 0;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294         <span class="comment">// clear FIFOs</span>
<a name="l01295"></a>01295         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl2, RFM22_opfc2_ffclrrx | RFM22_opfc2_ffclrtx);
<a name="l01296"></a>01296         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl2, 0x00);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298         <span class="comment">// enable RX interrupts</span>
<a name="l01299"></a>01299         rfm22_write(rfm22b_dev, RFM22_interrupt_enable1, RFM22_ie1_encrcerror | RFM22_ie1_enpkvalid |
<a name="l01300"></a>01300                     RFM22_ie1_enrxffafull | RFM22_ie1_enfferr);
<a name="l01301"></a>01301         rfm22_write(rfm22b_dev, RFM22_interrupt_enable2, RFM22_ie2_enpreainval | RFM22_ie2_enpreaval |
<a name="l01302"></a>01302                     RFM22_ie2_enswdet);
<a name="l01303"></a>01303 
<a name="l01304"></a>01304         <span class="comment">// enable the receiver</span>
<a name="l01305"></a>01305         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl1, RFM22_opfc1_pllon | RFM22_opfc1_rxon);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="comment">// Indicate that we&#39;re in RX mode.</span>
<a name="l01308"></a>01308         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a5d1bb77d70e2da36174e66d08e42cac6">in_rx_mode</a> = <span class="keyword">true</span>;
<a name="l01309"></a>01309 
<a name="l01310"></a>01310         <span class="comment">// No event generated</span>
<a name="l01311"></a>01311         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01312"></a>01312 }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314 <span class="comment">// ************************************</span>
<a name="l01315"></a>01315 
<a name="l01316"></a>01316 <span class="keyword">static</span> <span class="keywordtype">bool</span> rfm22_ready_to_send(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01317"></a>01317 {
<a name="l01318"></a>01318         <span class="comment">// Is there a status of PPM packet ready to send?</span>
<a name="l01319"></a>01319         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a> || rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a44f9d9da0b1740ea9f077873f766ee45">send_ppm</a> || rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abf332b1a47bf1d07fbc580382acd4b95">send_status</a>)
<a name="l01320"></a>01320                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01321"></a>01321 
<a name="l01322"></a>01322         <span class="comment">// Is there some data ready to sent?</span>
<a name="l01323"></a>01323         <a class="code" href="struct_p_h_packet.html">PHPacketHandle</a> dp = &amp;rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19e3336c0f0c2da02404e828d688cbd3">data_packet</a>;
<a name="l01324"></a>01324         <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> &gt; 0)
<a name="l01325"></a>01325                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01326"></a>01326         <span class="keywordtype">bool</span> need_yield = <span class="keyword">false</span>;
<a name="l01327"></a>01327         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab861d6c14abc749f20e45226bd606840">tx_out_cb</a>)
<a name="l01328"></a>01328                 dp-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab861d6c14abc749f20e45226bd606840">tx_out_cb</a>)(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6d55d5cf2cee09fb6e56c1f918dc31ea">tx_out_context</a>, dp-&gt;<a class="code" href="struct_p_h_packet.html#ab75944547b63cd1feaaa0727b7505c52">data</a>, PH_MAX_DATA, NULL, &amp;need_yield);
<a name="l01329"></a>01329         <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> &gt; 0)
<a name="l01330"></a>01330                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_txStart(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01336"></a>01336 {
<a name="l01337"></a>01337         <a class="code" href="struct_p_h_packet.html">PHPacketHandle</a> p = NULL;
<a name="l01338"></a>01338 
<a name="l01339"></a>01339         <span class="comment">// Don&#39;t send if it&#39;s not our turn.</span>
<a name="l01340"></a>01340         <span class="keywordflow">if</span> (!rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a>)
<a name="l01341"></a>01341                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343         <span class="comment">// See if there&#39;s a packet ready to send.</span>
<a name="l01344"></a>01344         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>)
<a name="l01345"></a>01345                 p = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         <span class="comment">// Are we waiting for an ACK?</span>
<a name="l01348"></a>01348         <span class="keywordflow">else</span>
<a name="l01349"></a>01349         {
<a name="l01350"></a>01350 
<a name="l01351"></a>01351                 <span class="comment">// Don&#39;t send a packet if we&#39;re waiting for an ACK</span>
<a name="l01352"></a>01352                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a>)
<a name="l01353"></a>01353                         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355                 <span class="keywordflow">if</span> (!p &amp;&amp; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#afd7377cf7b2ada828b83887653e4d3c2">send_connection_request</a>)
<a name="l01356"></a>01356                 {
<a name="l01357"></a>01357                         p = (<a class="code" href="group___tau_labs_libraries.html#gaa252eac3dc3346fec375be8805fd8694">PHPacketHandle</a>)&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>);
<a name="l01358"></a>01358                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#afd7377cf7b2ada828b83887653e4d3c2">send_connection_request</a> = <span class="keyword">false</span>;
<a name="l01359"></a>01359                 }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361 <span class="preprocessor">#ifdef PIOS_PPM_RECEIVER</span>
<a name="l01362"></a>01362 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!p &amp;&amp; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a44f9d9da0b1740ea9f077873f766ee45">send_ppm</a>)
<a name="l01363"></a>01363                 {
<a name="l01364"></a>01364                         p = (<a class="code" href="group___tau_labs_libraries.html#gaa252eac3dc3346fec375be8805fd8694">PHPacketHandle</a>)&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>);
<a name="l01365"></a>01365                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a44f9d9da0b1740ea9f077873f766ee45">send_ppm</a> = <span class="keyword">false</span>;
<a name="l01366"></a>01366                 }
<a name="l01367"></a>01367 <span class="preprocessor">#endif</span>
<a name="l01368"></a>01368 <span class="preprocessor"></span>
<a name="l01369"></a>01369                 <span class="keywordflow">if</span> (!p &amp;&amp; rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abf332b1a47bf1d07fbc580382acd4b95">send_status</a>)
<a name="l01370"></a>01370                 {
<a name="l01371"></a>01371                         p = (<a class="code" href="group___tau_labs_libraries.html#gaa252eac3dc3346fec375be8805fd8694">PHPacketHandle</a>)&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>);
<a name="l01372"></a>01372                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abf332b1a47bf1d07fbc580382acd4b95">send_status</a> = <span class="keyword">false</span>;
<a name="l01373"></a>01373                 }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375                 <span class="keywordflow">if</span> (!p)
<a name="l01376"></a>01376                 {
<a name="l01377"></a>01377                         <span class="comment">// Try to get some data to send</span>
<a name="l01378"></a>01378                         <span class="keywordtype">bool</span> need_yield = <span class="keyword">false</span>;
<a name="l01379"></a>01379                         p = &amp;rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19e3336c0f0c2da02404e828d688cbd3">data_packet</a>;
<a name="l01380"></a>01380                         p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> = <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada2062477b6d9ae02203bcb2adfe989055">PACKET_TYPE_DATA</a>;
<a name="l01381"></a>01381                         p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a>;
<a name="l01382"></a>01382                         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab861d6c14abc749f20e45226bd606840">tx_out_cb</a> &amp;&amp; (p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> == 0))
<a name="l01383"></a>01383                                 p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ab861d6c14abc749f20e45226bd606840">tx_out_cb</a>)(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6d55d5cf2cee09fb6e56c1f918dc31ea">tx_out_context</a>, p-&gt;<a class="code" href="struct_p_h_packet.html#ab75944547b63cd1feaaa0727b7505c52">data</a>, PH_MAX_DATA, NULL, &amp;need_yield);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385                         <span class="comment">// Don&#39;t send any data until we&#39;re connected.</span>
<a name="l01386"></a>01386                         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> != <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l01387"></a>01387                                 p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = 0;
<a name="l01388"></a>01388                         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> == 0)
<a name="l01389"></a>01389                                 p = NULL;
<a name="l01390"></a>01390                 }
<a name="l01391"></a>01391 
<a name="l01392"></a>01392                 <span class="keywordflow">if</span> (p)
<a name="l01393"></a>01393                         p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a3d0a8a439dadc33b716f7e926a9546cf">seq_num</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8279ef420f8e1d3c6773b8cb528f5122">tx_seq</a>++;
<a name="l01394"></a>01394         }
<a name="l01395"></a>01395         <span class="keywordflow">if</span> (!p)
<a name="l01396"></a>01396                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>;
<a name="l01397"></a>01397 
<a name="l01398"></a>01398         <span class="comment">// We&#39;re transitioning out of Rx mode.</span>
<a name="l01399"></a>01399         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a5d1bb77d70e2da36174e66d08e42cac6">in_rx_mode</a> = <span class="keyword">false</span>;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l01402"></a>01402 <span class="preprocessor"></span>        D1_LED_ON;
<a name="l01403"></a>01403         D2_LED_OFF;
<a name="l01404"></a>01404         D3_LED_TOGGLE;
<a name="l01405"></a>01405 <span class="preprocessor">#endif</span>
<a name="l01406"></a>01406 <span class="preprocessor"></span>
<a name="l01407"></a>01407         <span class="comment">// Add the error correcting code.</span>
<a name="l01408"></a>01408         p-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a93bf1fc396b4d98f870fee75682423b7">source_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac608ccb62cbd144c8053aaacb8c14fcf">deviceID</a>;
<a name="l01409"></a>01409         <a class="code" href="ecc_8h.html#a33cac00a5b8d040514e163b6d4f97b90">encode_data</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)p, PHPacketSize(p), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)p);
<a name="l01410"></a>01410 
<a name="l01411"></a>01411         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> = p;
<a name="l01412"></a>01412         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = xTaskGetTickCount();
<a name="l01413"></a>01413         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> == 0)
<a name="l01414"></a>01414                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 1;
<a name="l01415"></a>01415 
<a name="l01416"></a>01416         <span class="comment">// disable interrupts</span>
<a name="l01417"></a>01417         rfm22_write(rfm22b_dev, RFM22_interrupt_enable1, 0x00);
<a name="l01418"></a>01418         rfm22_write(rfm22b_dev, RFM22_interrupt_enable2, 0x00);
<a name="l01419"></a>01419 
<a name="l01420"></a>01420         <span class="comment">// TUNE mode</span>
<a name="l01421"></a>01421         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl1, RFM22_opfc1_pllon);
<a name="l01422"></a>01422 
<a name="l01423"></a>01423         <span class="comment">// Queue the data up for sending</span>
<a name="l01424"></a>01424         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> = PH_PACKET_SIZE(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>);
<a name="l01425"></a>01425 
<a name="l01426"></a>01426         RX_LED_OFF;
<a name="l01427"></a>01427 
<a name="l01428"></a>01428         <span class="comment">// Set the destination address in the transmit header.</span>
<a name="l01429"></a>01429         <span class="comment">// The destination address is the first 4 bytes of the message.</span>
<a name="l01430"></a>01430         uint8_t *tx_buffer = (uint8_t*)(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>);
<a name="l01431"></a>01431         rfm22_write(rfm22b_dev, RFM22_transmit_header0, tx_buffer[0]);
<a name="l01432"></a>01432         rfm22_write(rfm22b_dev, RFM22_transmit_header1, tx_buffer[1]);
<a name="l01433"></a>01433         rfm22_write(rfm22b_dev, RFM22_transmit_header2, tx_buffer[2]);
<a name="l01434"></a>01434         rfm22_write(rfm22b_dev, RFM22_transmit_header3, tx_buffer[3]);
<a name="l01435"></a>01435 
<a name="l01436"></a>01436         <span class="comment">// FIFO mode, GFSK modulation</span>
<a name="l01437"></a>01437         uint8_t fd_bit = rfm22_read(rfm22b_dev, RFM22_modulation_mode_control2) &amp; RFM22_mmc2_fd;
<a name="l01438"></a>01438         rfm22_write(rfm22b_dev, RFM22_modulation_mode_control2, fd_bit | RFM22_mmc2_dtmod_fifo |
<a name="l01439"></a>01439                     RFM22_mmc2_modtyp_gfsk);
<a name="l01440"></a>01440 
<a name="l01441"></a>01441         <span class="comment">// set the tx power</span>
<a name="l01442"></a>01442         rfm22_write(rfm22b_dev, RFM22_tx_power, RFM22_tx_pwr_papeaken | RFM22_tx_pwr_papeaklvl_1 |
<a name="l01443"></a>01443                     RFM22_tx_pwr_papeaklvl_0 | RFM22_tx_pwr_lna_sw | rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3ca116567675ce2311161483fe4c9ff4">tx_power</a>);
<a name="l01444"></a>01444 
<a name="l01445"></a>01445         <span class="comment">// clear FIFOs</span>
<a name="l01446"></a>01446         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl2, RFM22_opfc2_ffclrrx | RFM22_opfc2_ffclrtx);
<a name="l01447"></a>01447         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl2, 0x00);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449         <span class="comment">// *******************</span>
<a name="l01450"></a>01450         <span class="comment">// add some data to the chips TX FIFO before enabling the transmitter</span>
<a name="l01451"></a>01451 
<a name="l01452"></a>01452         <span class="comment">// set the total number of data bytes we are going to transmit</span>
<a name="l01453"></a>01453         rfm22_write(rfm22b_dev, RFM22_transmit_packet_length, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a>);
<a name="l01454"></a>01454 
<a name="l01455"></a>01455         <span class="comment">// add some data</span>
<a name="l01456"></a>01456         rfm22_claimBus(rfm22b_dev);
<a name="l01457"></a>01457         rfm22_assertCs(rfm22b_dev);
<a name="l01458"></a>01458         <a class="code" href="group___p_i_o_s___s_p_i.html#gaa65b0b0a89e87c3e8f13c00ee0b91563">PIOS_SPI_TransferByte</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, RFM22_fifo_access | 0x80);
<a name="l01459"></a>01459         <span class="keywordtype">int</span> bytes_to_write = (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> - rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a>);
<a name="l01460"></a>01460         bytes_to_write = (bytes_to_write &gt; FIFO_SIZE) ? FIFO_SIZE:  bytes_to_write;
<a name="l01461"></a>01461         <a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, &amp;tx_buffer[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a>], NULL, bytes_to_write, NULL);
<a name="l01462"></a>01462         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> += bytes_to_write;
<a name="l01463"></a>01463         rfm22_deassertCs(rfm22b_dev);
<a name="l01464"></a>01464         rfm22_releaseBus(rfm22b_dev);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466         <span class="comment">// enable TX interrupts</span>
<a name="l01467"></a>01467         rfm22_write(rfm22b_dev, RFM22_interrupt_enable1, RFM22_ie1_enpksent | RFM22_ie1_entxffaem);
<a name="l01468"></a>01468 
<a name="l01469"></a>01469         <span class="comment">// enable the transmitter</span>
<a name="l01470"></a>01470         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl1, RFM22_opfc1_pllon | RFM22_opfc1_txon);
<a name="l01471"></a>01471 
<a name="l01472"></a>01472         TX_LED_ON;
<a name="l01473"></a>01473 
<a name="l01474"></a>01474         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_sendStatus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01478"></a>01478 {
<a name="l01479"></a>01479         <span class="comment">// Only send status if we&#39;re connected</span>
<a name="l01480"></a>01480         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> != <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l01481"></a>01481                 <span class="keywordflow">return</span>;
<a name="l01482"></a>01482 
<a name="l01483"></a>01483         <span class="comment">// Update the link quality metric.</span>
<a name="l01484"></a>01484         rfm22_calculateLinkQuality(rfm22b_dev);
<a name="l01485"></a>01485 
<a name="l01486"></a>01486         <span class="comment">// Queue the status message</span>
<a name="l01487"></a>01487         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> == <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l01488"></a>01488                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>.<a class="code" href="struct_p_h_status_packet.html#a01617aa2bca7a093aa2dd7a2e7edc47a">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a>;
<a name="l01489"></a>01489         <span class="keywordflow">else</span>
<a name="l01490"></a>01490                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>.<a class="code" href="struct_p_h_status_packet.html#a01617aa2bca7a093aa2dd7a2e7edc47a">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = 0xffffffff; <span class="comment">// Broadcast</span>
<a name="l01491"></a>01491         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>.<a class="code" href="struct_p_h_status_packet.html#a01617aa2bca7a093aa2dd7a2e7edc47a">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> = <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28adad83911cea88c149916cd281ec9ee5cee">PACKET_TYPE_STATUS</a>;
<a name="l01492"></a>01492         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>.<a class="code" href="struct_p_h_status_packet.html#a01617aa2bca7a093aa2dd7a2e7edc47a">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = PH_STATUS_DATA_SIZE(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>));
<a name="l01493"></a>01493         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>.<a class="code" href="struct_p_h_status_packet.html#ac78a8f872dbb6ece46016b5fdc901037">link_quality</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8d32fed579e3be2fbc354ab176670af2">link_quality</a>;
<a name="l01494"></a>01494         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a655ec6ecb5828af1262a9108c8fb25f7">status_packet</a>.<a class="code" href="struct_p_h_status_packet.html#a8dcb964e68ef8dbed6c28e6418dc3e2e">received_rssi</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7efa2c785a1c9feaff4db472c1f22805">rssi_dBm</a>;
<a name="l01495"></a>01495         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abf332b1a47bf1d07fbc580382acd4b95">send_status</a> = <span class="keyword">true</span>;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497         <span class="keywordflow">return</span>;
<a name="l01498"></a>01498 }
<a name="l01499"></a>01499 
<a name="l01500"></a>01500 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_sendPPM(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01501"></a>01501 {
<a name="l01502"></a>01502 <span class="preprocessor">#ifdef PIOS_PPM_RECEIVER</span>
<a name="l01503"></a>01503 <span class="preprocessor"></span>        <span class="comment">// Only send PPM if we&#39;re connected</span>
<a name="l01504"></a>01504         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> != <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l01505"></a>01505                 <span class="keywordflow">return</span>;
<a name="l01506"></a>01506 
<a name="l01507"></a>01507         <span class="comment">// Just return if the PPM receiver is not configured.</span>
<a name="l01508"></a>01508         <span class="keywordflow">if</span> (PIOS_PPM_RECEIVER == 0)
<a name="l01509"></a>01509                 <span class="keywordflow">return</span>;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511         <span class="comment">// See if we have any valid channels.</span>
<a name="l01512"></a>01512         <span class="keywordtype">bool</span> valid_input_detected = <span class="keyword">false</span>;
<a name="l01513"></a>01513         <span class="keywordflow">for</span> (uint8_t i = 1; i &lt;= PIOS_PPM_NUM_INPUTS; ++i)
<a name="l01514"></a>01514         {
<a name="l01515"></a>01515                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>.<a class="code" href="struct_p_h_ppm_packet.html#a47b34df90a9b106c7be077456b3ba1b2">channels</a>[i - 1] = <a class="code" href="group___p_i_o_s___r_c_v_r.html#ga91b274787094f69d6f10c29de5bac5cc" title="Reads an input channel from the appropriate driver.">PIOS_RCVR_Read</a>(PIOS_PPM_RECEIVER, i);
<a name="l01516"></a>01516                 <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>.<a class="code" href="struct_p_h_ppm_packet.html#a47b34df90a9b106c7be077456b3ba1b2">channels</a>[i - 1] != <a class="code" href="group___p_i_o_s___r_c_v_r.html#ggab3256a57f692c2f2784d914ad5a5895da2aa8c41419029589d123f942ceb9a0ed">PIOS_RCVR_TIMEOUT</a>)
<a name="l01517"></a>01517                         valid_input_detected = <span class="keyword">true</span>;
<a name="l01518"></a>01518         }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520         <span class="comment">// Send the PPM packet if it&#39;s valid</span>
<a name="l01521"></a>01521         <span class="keywordflow">if</span> (valid_input_detected)
<a name="l01522"></a>01522         {
<a name="l01523"></a>01523                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>.<a class="code" href="struct_p_h_ppm_packet.html#a6dbe9e28bb634aadd35b5c4501589532">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a>;
<a name="l01524"></a>01524                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>.<a class="code" href="struct_p_h_ppm_packet.html#a6dbe9e28bb634aadd35b5c4501589532">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> = <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28adad3e2cee14551c12b1123a659b4456d04">PACKET_TYPE_PPM</a>;
<a name="l01525"></a>01525                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>.<a class="code" href="struct_p_h_ppm_packet.html#a6dbe9e28bb634aadd35b5c4501589532">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = PH_PPM_DATA_SIZE(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abdfbc812f36087f9b8392e9303f28086">ppm_packet</a>));
<a name="l01526"></a>01526                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a44f9d9da0b1740ea9f077873f766ee45">send_ppm</a> = <span class="keyword">true</span>;
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528 <span class="preprocessor">#endif</span>
<a name="l01529"></a>01529 <span class="preprocessor"></span>}
<a name="l01530"></a>01530 
<a name="l01535"></a>01535 <span class="keyword">static</span> <span class="keywordtype">bool</span> rfm22_readStatus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01536"></a>01536 {
<a name="l01537"></a>01537 
<a name="l01538"></a>01538         <span class="comment">// 1. Read the interrupt statuses with burst read</span>
<a name="l01539"></a>01539         rfm22_claimBus(rfm22b_dev);  <span class="comment">// Set RC and the semaphore</span>
<a name="l01540"></a>01540         uint8_t write_buf[3] = {RFM22_interrupt_status1 &amp; 0x7f, 0xFF, 0xFF};
<a name="l01541"></a>01541         uint8_t read_buf[3];
<a name="l01542"></a>01542         rfm22_assertCs(rfm22b_dev);
<a name="l01543"></a>01543         <a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, write_buf, read_buf, <span class="keyword">sizeof</span>(write_buf), NULL);
<a name="l01544"></a>01544         rfm22_deassertCs(rfm22b_dev);
<a name="l01545"></a>01545         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> = read_buf[1];
<a name="l01546"></a>01546         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> = read_buf[2];
<a name="l01547"></a>01547         
<a name="l01548"></a>01548         <span class="comment">// Device status</span>
<a name="l01549"></a>01549         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa6ea2086a901b33a1f0f1535f378cdfc">device_status</a> = rfm22_read_noclaim(rfm22b_dev, RFM22_device_status);
<a name="l01550"></a>01550 
<a name="l01551"></a>01551         <span class="comment">// EzMAC status</span>
<a name="l01552"></a>01552         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ae89edb5d4197faaeab67b5f0b010f5f8">ezmac_status</a> = rfm22_read_noclaim(rfm22b_dev, RFM22_ezmac_status);
<a name="l01553"></a>01553 
<a name="l01554"></a>01554         <span class="comment">// Release the bus</span>
<a name="l01555"></a>01555         rfm22_releaseBus(rfm22b_dev);
<a name="l01556"></a>01556 
<a name="l01557"></a>01557         <span class="comment">// the RF module has gone and done a reset - we need to re-initialize the rf module</span>
<a name="l01558"></a>01558         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> &amp; RFM22_is2_ipor)
<a name="l01559"></a>01559                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01560"></a>01560 
<a name="l01561"></a>01561         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01562"></a>01562 }
<a name="l01563"></a>01563 
<a name="l01569"></a>01569 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22b_add_rx_status(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga35600b81785134630f9193e4ff1478a3">pios_rfm22b_rx_packet_status</a> <a class="code" href="group___copter_control_b_l.html#ga2414697de79a243562514a0a4344a4dd">status</a>)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571         <span class="comment">// Shift the status registers</span>
<a name="l01572"></a>01572         <span class="keywordflow">for</span> (uint8_t i = RFM22B_RX_PACKET_STATS_LEN - 1; i &gt; 0; --i)
<a name="l01573"></a>01573         {
<a name="l01574"></a>01574                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[i] = (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[i] &lt;&lt; 2) | (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[i - 1] &gt;&gt; 30);
<a name="l01575"></a>01575         }
<a name="l01576"></a>01576         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[0] = (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[0] &lt;&lt; 2) | status;
<a name="l01577"></a>01577 }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_detectPreamble(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01580"></a>01580 {
<a name="l01581"></a>01581         <span class="comment">// Read the device status registers</span>
<a name="l01582"></a>01582         <span class="keywordflow">if</span> (!rfm22_readStatus(rfm22b_dev))
<a name="l01583"></a>01583                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01584"></a>01584 
<a name="l01585"></a>01585         <span class="comment">// Valid preamble detected</span>
<a name="l01586"></a>01586         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> &amp; RFM22_is2_ipreaval)
<a name="l01587"></a>01587         {
<a name="l01588"></a>01588                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = xTaskGetTickCount();
<a name="l01589"></a>01589                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> == 0)
<a name="l01590"></a>01590                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 1;
<a name="l01591"></a>01591                 RX_LED_ON;
<a name="l01592"></a>01592 
<a name="l01593"></a>01593 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l01594"></a>01594 <span class="preprocessor"></span>                D3_LED_TOGGLE;
<a name="l01595"></a>01595 <span class="preprocessor">#endif</span>
<a name="l01596"></a>01596 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ad7dfe2b62a899f8ac694d6ff415f8f4a">RFM22B_EVENT_PREAMBLE_DETECTED</a>;
<a name="l01597"></a>01597         }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_detectSync(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01603"></a>01603 {
<a name="l01604"></a>01604 
<a name="l01605"></a>01605         <span class="comment">// Read the device status registers</span>
<a name="l01606"></a>01606         <span class="keywordflow">if</span> (!rfm22_readStatus(rfm22b_dev))
<a name="l01607"></a>01607                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01608"></a>01608 
<a name="l01609"></a>01609         <span class="comment">// Sync word detected</span>
<a name="l01610"></a>01610         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> &amp; RFM22_is2_iswdet)
<a name="l01611"></a>01611         {
<a name="l01612"></a>01612                 RX_LED_ON;
<a name="l01613"></a>01613 
<a name="l01614"></a>01614                 <span class="comment">// read the 10-bit signed afc correction value</span>
<a name="l01615"></a>01615                 <span class="comment">// bits 9 to 2</span>
<a name="l01616"></a>01616                 uint16_t afc_correction = (uint16_t)rfm22_read(rfm22b_dev, RFM22_afc_correction_read) &lt;&lt; 8;
<a name="l01617"></a>01617                 <span class="comment">// bits 1 &amp; 0</span>
<a name="l01618"></a>01618                 afc_correction |= (uint16_t)rfm22_read(rfm22b_dev, RFM22_ook_counter_value1) &amp; 0x00c0;
<a name="l01619"></a>01619                 afc_correction &gt;&gt;= 6;
<a name="l01620"></a>01620                 <span class="comment">// convert the afc value to Hz</span>
<a name="l01621"></a>01621                 int32_t afc_corr = (int32_t)(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8cc9611e61bcaf29852b83cffa87ccd6">frequency_step_size</a> * afc_correction + 0.5f);
<a name="l01622"></a>01622                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7ee3ea27898cb9341fcbfe9d4b7ad874">afc_correction_Hz</a> = (afc_corr &lt; -127) ? -127 : ((afc_corr &gt; 127) ? 127 : afc_corr);
<a name="l01623"></a>01623 
<a name="l01624"></a>01624                 <span class="comment">// read rx signal strength .. 45 = -100dBm, 205 = -20dBm</span>
<a name="l01625"></a>01625                 uint8_t rssi = rfm22_read(rfm22b_dev, RFM22_rssi);
<a name="l01626"></a>01626                 <span class="comment">// convert to dBm</span>
<a name="l01627"></a>01627                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7efa2c785a1c9feaff4db472c1f22805">rssi_dBm</a> = (int8_t)(rssi &gt;&gt; 1) - 122;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a997bf1f3409379b556abfeda294ff184">RFM22B_EVENT_SYNC_DETECTED</a>;
<a name="l01630"></a>01630         }
<a name="l01631"></a>01631         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> &amp; !RFM22_is2_ipreaval)
<a name="l01632"></a>01632                 <span class="comment">// Waiting for sync timed out.</span>
<a name="l01633"></a>01633                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01634"></a>01634 
<a name="l01635"></a>01635         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01636"></a>01636 }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638 <span class="keyword">static</span> <span class="keywordtype">bool</span> rfm22_receivePacket(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev, <a class="code" href="struct_p_h_packet.html">PHPacketHandle</a> p, uint16_t rx_len)
<a name="l01639"></a>01639 {
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <span class="comment">// Attempt to correct any errors in the packet.</span>
<a name="l01642"></a>01642         <a class="code" href="ecc_8h.html#a231146bc254c1a49a9d3cc94c84cfd4e">decode_data</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)p, rx_len);
<a name="l01643"></a>01643 
<a name="l01644"></a>01644         <span class="keywordtype">bool</span> good_packet = <a class="code" href="ecc_8h.html#a75555933650a50987a9c5b39aff2b26a">check_syndrome</a>() == 0;
<a name="l01645"></a>01645         <span class="keywordtype">bool</span> corrected_packet = <span class="keyword">false</span>;
<a name="l01646"></a>01646         <span class="comment">// We have an error.  Try to correct it.</span>
<a name="l01647"></a>01647         <span class="keywordflow">if</span>(!good_packet &amp;&amp; (<a class="code" href="berlekamp_8c.html#a6da28744dd026ab3b7deb96086c74f0d">correct_errors_erasures</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)p, rx_len, 0, 0) != 0))
<a name="l01648"></a>01648                 <span class="comment">// We corrected it</span>
<a name="l01649"></a>01649                 corrected_packet = <span class="keyword">true</span>;
<a name="l01650"></a>01650 
<a name="l01651"></a>01651         <span class="comment">// Add any missed packets into the stats.</span>
<a name="l01652"></a>01652         <span class="keywordtype">bool</span> <a class="code" href="structpios__rfm22b__dev.html#a57f8d0ab5171f50e634940b11cc402c1">ack_nack_packet</a> = ((p-&gt;header.type == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada6add2b6716957bc5e01de78127161c27">PACKET_TYPE_ACK</a>) || (p-&gt;header.type == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada77fe95b0ef25a7e060413a0175ac7747">PACKET_TYPE_ACK_RTS</a>) || (p-&gt;header.type == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada7b9680cb1a5b7a996450a1c19439779f">PACKET_TYPE_NACK</a>));
<a name="l01653"></a>01653         <span class="keywordflow">if</span> (!ack_nack_packet &amp;&amp; (good_packet || corrected_packet))
<a name="l01654"></a>01654         {
<a name="l01655"></a>01655                 uint16_t seq_num = p-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#a3d0a8a439dadc33b716f7e926a9546cf">seq_num</a>;
<a name="l01656"></a>01656                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> == <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l01657"></a>01657                 {
<a name="l01658"></a>01658                         <span class="keyword">static</span> <span class="keywordtype">bool</span> first_time = <span class="keyword">true</span>;
<a name="l01659"></a>01659                         uint16_t missed_packets = 0;
<a name="l01660"></a>01660                         <span class="keywordflow">if</span> (first_time)
<a name="l01661"></a>01661                                 first_time = <span class="keyword">false</span>;
<a name="l01662"></a>01662                         <span class="keywordflow">else</span>
<a name="l01663"></a>01663                         {
<a name="l01664"></a>01664                                 uint16_t prev_seq_num = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#ad73defbcdc26cc6438d0f28723a909e7">rx_seq</a>;
<a name="l01665"></a>01665                                 <span class="keywordflow">if</span> (seq_num &gt; prev_seq_num)
<a name="l01666"></a>01666                                         missed_packets = seq_num - prev_seq_num - 1;
<a name="l01667"></a>01667                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>((seq_num == prev_seq_num) &amp;&amp; (p-&gt;header.type == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada2062477b6d9ae02203bcb2adfe989055">PACKET_TYPE_DATA</a>))
<a name="l01668"></a>01668                                         p-&gt;header.type = <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada3392941f745533dd9f815c1d8e88003a">PACKET_TYPE_DUPLICATE_DATA</a>;
<a name="l01669"></a>01669                         }
<a name="l01670"></a>01670                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a10156bfde7480e15c39ba077da5f687f">rx_missed</a> += missed_packets;
<a name="l01671"></a>01671                 }
<a name="l01672"></a>01672                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#ad73defbcdc26cc6438d0f28723a909e7">rx_seq</a> = seq_num;
<a name="l01673"></a>01673         }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675         <span class="comment">// Set the packet status</span>
<a name="l01676"></a>01676         <span class="keywordflow">if</span> (good_packet)
<a name="l01677"></a>01677                 rfm22b_add_rx_status(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3a70ea6e91308b4c2944276f919e07af30">RFM22B_GOOD_RX_PACKET</a>);
<a name="l01678"></a>01678         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(corrected_packet)
<a name="l01679"></a>01679                 <span class="comment">// We corrected the error.</span>
<a name="l01680"></a>01680                 rfm22b_add_rx_status(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3ab785f920fd4d6b5091a150bbbea5dc3f">RFM22B_CORRECTED_RX_PACKET</a>);
<a name="l01681"></a>01681         <span class="keywordflow">else</span>
<a name="l01682"></a>01682                 <span class="comment">// We couldn&#39;t correct the error, so drop the packet.</span>
<a name="l01683"></a>01683                 rfm22b_add_rx_status(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3a275f3866391d28d8a46a71a50d4fae12">RFM22B_ERROR_RX_PACKET</a>);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685         <span class="keywordflow">return</span> (good_packet || corrected_packet);
<a name="l01686"></a>01686 }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_rxData(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01689"></a>01689 {
<a name="l01690"></a>01690         <span class="comment">// Swap in the next packet buffer if required.</span>
<a name="l01691"></a>01691         uint8_t *rx_buffer = (uint8_t*)&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>);
<a name="l01692"></a>01692 
<a name="l01693"></a>01693         <span class="comment">// Read the device status registers</span>
<a name="l01694"></a>01694         <span class="keywordflow">if</span> (!rfm22_readStatus(rfm22b_dev))
<a name="l01695"></a>01695                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         <span class="comment">// FIFO under/over flow error.  Restart RX mode.</span>
<a name="l01698"></a>01698         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_ifferr)
<a name="l01699"></a>01699                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701         <span class="comment">// RX FIFO almost full, it needs emptying</span>
<a name="l01702"></a>01702         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_irxffafull)
<a name="l01703"></a>01703         {
<a name="l01704"></a>01704                 <span class="comment">// read data from the rf chips FIFO buffer</span>
<a name="l01705"></a>01705                 <span class="comment">// read the total length of the packet data</span>
<a name="l01706"></a>01706                 uint16_t len = rfm22_read(rfm22b_dev, RFM22_received_packet_length);
<a name="l01707"></a>01707 
<a name="l01708"></a>01708                 <span class="comment">// The received packet is going to be larger than the specified length</span>
<a name="l01709"></a>01709                 <span class="keywordflow">if</span> ((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> + RX_FIFO_HI_WATERMARK) &gt; len)
<a name="l01710"></a>01710                         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01711"></a>01711 
<a name="l01712"></a>01712                 <span class="comment">// Another packet length error.</span>
<a name="l01713"></a>01713                 <span class="keywordflow">if</span> (((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> + RX_FIFO_HI_WATERMARK) &gt;= len) &amp;&amp; !(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_ipkvalid))
<a name="l01714"></a>01714                         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716                 <span class="comment">// Fetch the data from the RX FIFO</span>
<a name="l01717"></a>01717                 rfm22_claimBus(rfm22b_dev);
<a name="l01718"></a>01718                 rfm22_assertCs(rfm22b_dev);
<a name="l01719"></a>01719                 <a class="code" href="group___p_i_o_s___s_p_i.html#gaa65b0b0a89e87c3e8f13c00ee0b91563">PIOS_SPI_TransferByte</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>,RFM22_fifo_access &amp; 0x7F);
<a name="l01720"></a>01720                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> += (<a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a> ,OUT_FF, (uint8_t *)&amp;rx_buffer[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a>], RX_FIFO_HI_WATERMARK, NULL) == 0) ? RX_FIFO_HI_WATERMARK : 0;
<a name="l01721"></a>01721                 rfm22_deassertCs(rfm22b_dev);
<a name="l01722"></a>01722                 rfm22_releaseBus(rfm22b_dev);
<a name="l01723"></a>01723         }
<a name="l01724"></a>01724 
<a name="l01725"></a>01725         <span class="comment">// CRC error .. discard the received data</span>
<a name="l01726"></a>01726         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_icrerror)
<a name="l01727"></a>01727                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729         <span class="comment">// Valid packet received</span>
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_ipkvalid)
<a name="l01731"></a>01731         {
<a name="l01732"></a>01732 
<a name="l01733"></a>01733                 <span class="comment">// read the total length of the packet data</span>
<a name="l01734"></a>01734                 uint32_t len = rfm22_read(rfm22b_dev, RFM22_received_packet_length);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736                 <span class="comment">// their must still be data in the RX FIFO we need to get</span>
<a name="l01737"></a>01737                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> &lt; len)
<a name="l01738"></a>01738                 {
<a name="l01739"></a>01739                         int32_t bytes_to_read = len - rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a>;
<a name="l01740"></a>01740                         <span class="comment">// Fetch the data from the RX FIFO</span>
<a name="l01741"></a>01741                         rfm22_claimBus(rfm22b_dev);
<a name="l01742"></a>01742                         rfm22_assertCs(rfm22b_dev);
<a name="l01743"></a>01743                         <a class="code" href="group___p_i_o_s___s_p_i.html#gaa65b0b0a89e87c3e8f13c00ee0b91563">PIOS_SPI_TransferByte</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>,RFM22_fifo_access &amp; 0x7F);
<a name="l01744"></a>01744                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> += (<a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>,OUT_FF, (uint8_t *)&amp;rx_buffer[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a>], bytes_to_read, NULL) == 0) ? bytes_to_read : 0;
<a name="l01745"></a>01745                         rfm22_deassertCs(rfm22b_dev);
<a name="l01746"></a>01746                         rfm22_releaseBus(rfm22b_dev);
<a name="l01747"></a>01747                 }
<a name="l01748"></a>01748         
<a name="l01749"></a>01749                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> != len)
<a name="l01750"></a>01750                         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01751"></a>01751 
<a name="l01752"></a>01752                 <span class="comment">// we have a valid received packet</span>
<a name="l01753"></a>01753                 <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc4252d32316b4bdff1c9b64e46e7f5a">RFM22B_EVENT_RX_COMPLETE</a>;
<a name="l01754"></a>01754                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> &gt; 0)
<a name="l01755"></a>01755                 {
<a name="l01756"></a>01756                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a4a173cf22afe7f957dc268d65ab1833c">rx_byte_count</a> += rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a>;
<a name="l01757"></a>01757                         <span class="comment">// Check the packet for errors.</span>
<a name="l01758"></a>01758                         <span class="keywordflow">if</span> (rfm22_receivePacket(rfm22b_dev, &amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>), rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a>))
<a name="l01759"></a>01759                         {
<a name="l01760"></a>01760                                 <span class="keywordflow">switch</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a>)
<a name="l01761"></a>01761                                 {
<a name="l01762"></a>01762                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28adad83911cea88c149916cd281ec9ee5cee">PACKET_TYPE_STATUS</a>:
<a name="l01763"></a>01763                                         ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aaf8fcd36a96e9bc6fea158bc9f9b9ecd">RFM22B_EVENT_STATUS_RECEIVED</a>;
<a name="l01764"></a>01764                                         <span class="keywordflow">break</span>;
<a name="l01765"></a>01765                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada287243cb80381ee8175f3fdcb25b69de">PACKET_TYPE_CON_REQUEST</a>:
<a name="l01766"></a>01766                                         ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa6b3b8a36ef2f5be8301355ebce89112">RFM22B_EVENT_CONNECTION_REQUESTED</a>;
<a name="l01767"></a>01767                                         <span class="keywordflow">break</span>;
<a name="l01768"></a>01768                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada2062477b6d9ae02203bcb2adfe989055">PACKET_TYPE_DATA</a>:
<a name="l01769"></a>01769                                 {
<a name="l01770"></a>01770                                         <span class="comment">// Send the data to the com port</span>
<a name="l01771"></a>01771                                         <span class="keywordtype">bool</span> rx_need_yield;
<a name="l01772"></a>01772                                         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac170322ec2f96932e0f060aa68b6bd12">rx_in_cb</a>)
<a name="l01773"></a>01773                                                 (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac170322ec2f96932e0f060aa68b6bd12">rx_in_cb</a>)(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a70fce9f445ae6ec87f5a559b89e82169">rx_in_context</a>, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#ab75944547b63cd1feaaa0727b7505c52">data</a>, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a>, NULL, &amp;rx_need_yield);
<a name="l01774"></a>01774                                         <span class="keywordflow">break</span>;
<a name="l01775"></a>01775                                 }
<a name="l01776"></a>01776                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada3392941f745533dd9f815c1d8e88003a">PACKET_TYPE_DUPLICATE_DATA</a>:
<a name="l01777"></a>01777                                         <span class="keywordflow">break</span>;
<a name="l01778"></a>01778                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada6add2b6716957bc5e01de78127161c27">PACKET_TYPE_ACK</a>:
<a name="l01779"></a>01779                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada77fe95b0ef25a7e060413a0175ac7747">PACKET_TYPE_ACK_RTS</a>:
<a name="l01780"></a>01780                                         ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a19e9383feac0c23ce398f7d9384c3059">RFM22B_EVENT_PACKET_ACKED</a>;
<a name="l01781"></a>01781                                         <span class="keywordflow">break</span>;
<a name="l01782"></a>01782                                 <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada7b9680cb1a5b7a996450a1c19439779f">PACKET_TYPE_NACK</a>:
<a name="l01783"></a>01783                                         ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a725d3965af8e429a95709db317751eea">RFM22B_EVENT_PACKET_NACKED</a>;
<a name="l01784"></a>01784                                         <span class="keywordflow">break</span>;
<a name="l01785"></a>01785                                 <span class="keywordflow">default</span>:
<a name="l01786"></a>01786                                         <span class="keywordflow">break</span>;
<a name="l01787"></a>01787                                 }
<a name="l01788"></a>01788                         }
<a name="l01789"></a>01789                         <span class="keywordflow">else</span>
<a name="l01790"></a>01790                                 ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a35d784cf5079afeadda2640ee6b46f26">RFM22B_EVENT_RX_ERROR</a>;
<a name="l01791"></a>01791                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> = 0;
<a name="l01792"></a>01792                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> = xTaskGetTickCount();
<a name="l01793"></a>01793                         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> == 0)
<a name="l01794"></a>01794                                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> = 1;
<a name="l01795"></a>01795 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l01796"></a>01796 <span class="preprocessor"></span>                        D2_LED_OFF;
<a name="l01797"></a>01797                         D3_LED_TOGGLE;
<a name="l01798"></a>01798 <span class="preprocessor">#endif</span>
<a name="l01799"></a>01799 <span class="preprocessor"></span>                }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801                 <span class="comment">// We&#39;re finished with Rx mode</span>
<a name="l01802"></a>01802                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a5d1bb77d70e2da36174e66d08e42cac6">in_rx_mode</a> = <span class="keyword">false</span>;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804                 <span class="comment">// Start a new transaction</span>
<a name="l01805"></a>01805                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 0;
<a name="l01806"></a>01806                 <span class="keywordflow">return</span> ret_event;
<a name="l01807"></a>01807         }
<a name="l01808"></a>01808 
<a name="l01809"></a>01809         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01810"></a>01810 }
<a name="l01811"></a>01811 
<a name="l01812"></a>01812 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_rxFailure(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01813"></a>01813 {
<a name="l01814"></a>01814         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a4acb04b442511cd543677d8d8e7b4a81">rx_failure</a>++;
<a name="l01815"></a>01815         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> = 0;
<a name="l01816"></a>01816         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> = xTaskGetTickCount();
<a name="l01817"></a>01817         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a5d1bb77d70e2da36174e66d08e42cac6">in_rx_mode</a> = <span class="keyword">false</span>;
<a name="l01818"></a>01818         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> == 0)
<a name="l01819"></a>01819                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> = 1;
<a name="l01820"></a>01820         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>;
<a name="l01821"></a>01821 }
<a name="l01822"></a>01822 
<a name="l01823"></a>01823 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_txData(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01824"></a>01824 {
<a name="l01825"></a>01825         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aa1f8214c33b90c900f422b7e5c2b8f31">RFM22B_EVENT_NUM_EVENTS</a>;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827         <span class="comment">// Read the device status registers</span>
<a name="l01828"></a>01828         <span class="keywordflow">if</span> (!rfm22_readStatus(rfm22b_dev))
<a name="l01829"></a>01829                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a2465e4731727edd260b49e52dc85de56">RFM22B_EVENT_FAILURE</a>;
<a name="l01830"></a>01830 
<a name="l01831"></a>01831         <span class="comment">// FIFO under/over flow error.</span>
<a name="l01832"></a>01832         <span class="comment">//if (rfm22b_dev-&gt;int_status1 &amp; RFM22_is1_ifferr)</span>
<a name="l01833"></a>01833         <span class="comment">//return RFM22B_EVENT_FAILURE;</span>
<a name="l01834"></a>01834 
<a name="l01835"></a>01835         <span class="comment">// TX FIFO almost empty, it needs filling up</span>
<a name="l01836"></a>01836         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_ixtffaem)
<a name="l01837"></a>01837         {
<a name="l01838"></a>01838                 <span class="comment">// top-up the rf chips TX FIFO buffer</span>
<a name="l01839"></a>01839                 uint8_t *tx_buffer = (uint8_t*)(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>);
<a name="l01840"></a>01840                 uint16_t max_bytes = FIFO_SIZE - TX_FIFO_LO_WATERMARK - 1;
<a name="l01841"></a>01841                 rfm22_claimBus(rfm22b_dev);
<a name="l01842"></a>01842                 rfm22_assertCs(rfm22b_dev);
<a name="l01843"></a>01843                 <a class="code" href="group___p_i_o_s___s_p_i.html#gaa65b0b0a89e87c3e8f13c00ee0b91563">PIOS_SPI_TransferByte</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, RFM22_fifo_access | 0x80);
<a name="l01844"></a>01844                 <span class="keywordtype">int</span> bytes_to_write = (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> - rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a>);
<a name="l01845"></a>01845                 bytes_to_write = (bytes_to_write &gt; max_bytes) ? max_bytes:  bytes_to_write;
<a name="l01846"></a>01846                 <a class="code" href="group___p_i_o_s___s_p_i.html#ga7dc994b4889415502021540ebbd2fce3">PIOS_SPI_TransferBlock</a>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7fae761882f21a9a0088db1f81dd41da">spi_id</a>, &amp;tx_buffer[rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a>], NULL, bytes_to_write, NULL);
<a name="l01847"></a>01847                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> += bytes_to_write;
<a name="l01848"></a>01848                 rfm22_deassertCs(rfm22b_dev);
<a name="l01849"></a>01849                 rfm22_releaseBus(rfm22b_dev);
<a name="l01850"></a>01850         }
<a name="l01851"></a>01851 
<a name="l01852"></a>01852         <span class="comment">// Packet has been sent</span>
<a name="l01853"></a>01853         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> &amp; RFM22_is1_ipksent)
<a name="l01854"></a>01854         {
<a name="l01855"></a>01855                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a3f3b0ee5d6c3557da05b35b54102da71">tx_byte_count</a> += PH_PACKET_SIZE(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>);
<a name="l01856"></a>01856 
<a name="l01857"></a>01857                 <span class="comment">// Is this an ACK?</span>
<a name="l01858"></a>01858                 <span class="keywordtype">bool</span> is_ack = ((rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada6add2b6716957bc5e01de78127161c27">PACKET_TYPE_ACK</a>) || (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada77fe95b0ef25a7e060413a0175ac7747">PACKET_TYPE_ACK_RTS</a>));
<a name="l01859"></a>01859                 <span class="comment">//ret_event = is_ack ? RFM22B_EVENT_TX_START : RFM22B_EVENT_RX_MODE;</span>
<a name="l01860"></a>01860                 ret_event = <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>;
<a name="l01861"></a>01861                 <span class="keywordflow">if</span> (is_ack)
<a name="l01862"></a>01862                 {
<a name="l01863"></a>01863                         <span class="comment">// If this is an ACK for a connection request message we need to</span>
<a name="l01864"></a>01864                         <span class="comment">// configure this modem from the connection request message.</span>
<a name="l01865"></a>01865                         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada287243cb80381ee8175f3fdcb25b69de">PACKET_TYPE_CON_REQUEST</a>)
<a name="l01866"></a>01866                                 rfm22_setConnectionParameters(rfm22b_dev);
<a name="l01867"></a>01867 
<a name="l01868"></a>01868                 }
<a name="l01869"></a>01869                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> != <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada7b9680cb1a5b7a996450a1c19439779f">PACKET_TYPE_NACK</a>)
<a name="l01870"></a>01870                 {
<a name="l01871"></a>01871                         <span class="comment">// We need to wait for an ACK if this packet it not an ACK or NACK.</span>
<a name="l01872"></a>01872                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>;
<a name="l01873"></a>01873                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#af71e33856164ba7654a523173441ecb3">tx_complete_ticks</a> = xTaskGetTickCount();
<a name="l01874"></a>01874                 }
<a name="l01875"></a>01875                 <span class="comment">// Set the Tx period</span>
<a name="l01876"></a>01876                 portTickType curTicks = xTaskGetTickCount();
<a name="l01877"></a>01877                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada6add2b6716957bc5e01de78127161c27">PACKET_TYPE_ACK</a>)
<a name="l01878"></a>01878                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad552e65c59e3873f29312042109562cd">time_to_send_offset</a> = curTicks + 0x4;
<a name="l01879"></a>01879                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a>-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada77fe95b0ef25a7e060413a0175ac7747">PACKET_TYPE_ACK_RTS</a>)
<a name="l01880"></a>01880                         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad552e65c59e3873f29312042109562cd">time_to_send_offset</a> = curTicks;
<a name="l01881"></a>01881                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> = 0;
<a name="l01882"></a>01882                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> = 0;
<a name="l01883"></a>01883                 <span class="comment">// Start a new transaction</span>
<a name="l01884"></a>01884                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 0;
<a name="l01885"></a>01885 
<a name="l01886"></a>01886 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l01887"></a>01887 <span class="preprocessor"></span>                D1_LED_OFF;
<a name="l01888"></a>01888                 D3_LED_TOGGLE;
<a name="l01889"></a>01889 <span class="preprocessor">#endif</span>
<a name="l01890"></a>01890 <span class="preprocessor"></span>        }
<a name="l01891"></a>01891 
<a name="l01892"></a>01892         <span class="keywordflow">return</span> ret_event;
<a name="l01893"></a>01893 }
<a name="l01894"></a>01894 
<a name="l01895"></a>01895 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_txFailure(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01896"></a>01896 {
<a name="l01897"></a>01897         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#ae443df4225a025395b7fa6caea562a74">tx_failure</a>++;
<a name="l01898"></a>01898         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> = 0;
<a name="l01899"></a>01899         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l01900"></a>01900 }
<a name="l01901"></a>01901 
<a name="l01906"></a>01906 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_sendAck(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908         <a class="code" href="struct_p_h_ack_nack_packet.html">PHAckNackPacketHandle</a> aph = (<a class="code" href="group___tau_labs_libraries.html#gafd4ce42b4793fdd6ccdba127272056b4">PHAckNackPacketHandle</a>)(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a57f8d0ab5171f50e634940b11cc402c1">ack_nack_packet</a>));
<a name="l01909"></a>01909         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a93bf1fc396b4d98f870fee75682423b7">source_id</a>;
<a name="l01910"></a>01910         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> = rfm22_ready_to_send(rfm22b_dev) ? <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada77fe95b0ef25a7e060413a0175ac7747">PACKET_TYPE_ACK_RTS</a> : <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada6add2b6716957bc5e01de78127161c27">PACKET_TYPE_ACK</a>;
<a name="l01911"></a>01911         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = PH_ACK_NACK_DATA_SIZE(aph);
<a name="l01912"></a>01912         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#a3d0a8a439dadc33b716f7e926a9546cf">seq_num</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a3d0a8a439dadc33b716f7e926a9546cf">seq_num</a>;
<a name="l01913"></a>01913         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> = (<a class="code" href="group___tau_labs_libraries.html#gaa252eac3dc3346fec375be8805fd8694">PHPacketHandle</a>)aph;
<a name="l01914"></a>01914         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = <span class="keyword">true</span>;
<a name="l01915"></a>01915         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l01916"></a>01916 }
<a name="l01917"></a>01917 
<a name="l01922"></a>01922 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_sendNack(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01923"></a>01923 {
<a name="l01924"></a>01924         <a class="code" href="struct_p_h_ack_nack_packet.html">PHAckNackPacketHandle</a> aph = (<a class="code" href="group___tau_labs_libraries.html#gafd4ce42b4793fdd6ccdba127272056b4">PHAckNackPacketHandle</a>)(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a57f8d0ab5171f50e634940b11cc402c1">ack_nack_packet</a>));
<a name="l01925"></a>01925         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a93bf1fc396b4d98f870fee75682423b7">source_id</a>;
<a name="l01926"></a>01926         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> = <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada7b9680cb1a5b7a996450a1c19439779f">PACKET_TYPE_NACK</a>;
<a name="l01927"></a>01927         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = PH_ACK_NACK_DATA_SIZE(aph);
<a name="l01928"></a>01928         aph-&gt;<a class="code" href="struct_p_h_ack_nack_packet.html#aac07270becd441ff9dafa3e01945883c">header</a>.<a class="code" href="struct_p_h_packet_header.html#a3d0a8a439dadc33b716f7e926a9546cf">seq_num</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a3d0a8a439dadc33b716f7e926a9546cf">seq_num</a>;
<a name="l01929"></a>01929         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> = (<a class="code" href="group___tau_labs_libraries.html#gaa252eac3dc3346fec375be8805fd8694">PHPacketHandle</a>)aph;
<a name="l01930"></a>01930         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = <span class="keyword">true</span>;
<a name="l01931"></a>01931         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l01932"></a>01932 }
<a name="l01933"></a>01933 
<a name="l01938"></a>01938 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_receiveAck(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01939"></a>01939 {
<a name="l01940"></a>01940         <a class="code" href="struct_p_h_packet.html">PHPacketHandle</a> prev = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a>;
<a name="l01941"></a>01941         portTickType curTicks = xTaskGetTickCount();
<a name="l01942"></a>01942 
<a name="l01943"></a>01943         <span class="comment">// Clear the previous TX packet.</span>
<a name="l01944"></a>01944         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a> = NULL;
<a name="l01945"></a>01945 
<a name="l01946"></a>01946         <span class="comment">// Was this a connection request?</span>
<a name="l01947"></a>01947         <span class="keywordflow">switch</span> (prev-&gt;<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a>)
<a name="l01948"></a>01948         {
<a name="l01949"></a>01949         <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada287243cb80381ee8175f3fdcb25b69de">PACKET_TYPE_CON_REQUEST</a>:
<a name="l01950"></a>01950                 rfm22_setConnectionParameters(rfm22b_dev);
<a name="l01951"></a>01951                 <span class="keywordflow">break</span>;
<a name="l01952"></a>01952         <span class="keywordflow">case</span> <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada2062477b6d9ae02203bcb2adfe989055">PACKET_TYPE_DATA</a>:
<a name="l01953"></a>01953                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19e3336c0f0c2da02404e828d688cbd3">data_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = 0;
<a name="l01954"></a>01954                 <span class="keywordflow">break</span>;
<a name="l01955"></a>01955         }
<a name="l01956"></a>01956 
<a name="l01957"></a>01957         <span class="comment">// Should we try to start another TX?</span>
<a name="l01958"></a>01958         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> == <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada6add2b6716957bc5e01de78127161c27">PACKET_TYPE_ACK</a>)
<a name="l01959"></a>01959         {
<a name="l01960"></a>01960                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad552e65c59e3873f29312042109562cd">time_to_send_offset</a> = curTicks;
<a name="l01961"></a>01961                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = <span class="keyword">true</span>;
<a name="l01962"></a>01962                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l01963"></a>01963         }
<a name="l01964"></a>01964         <span class="keywordflow">else</span>
<a name="l01965"></a>01965         {
<a name="l01966"></a>01966                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad552e65c59e3873f29312042109562cd">time_to_send_offset</a> = curTicks + 0x4;
<a name="l01967"></a>01967                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a6fff9bee58987bb93a1771f29c3c1f23">RFM22B_EVENT_RX_MODE</a>;
<a name="l01968"></a>01968         }
<a name="l01969"></a>01969 }
<a name="l01970"></a>01970 
<a name="l01975"></a>01975 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_receiveNack(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01976"></a>01976 {
<a name="l01977"></a>01977         <span class="comment">// Resend the previous TX packet.</span>
<a name="l01978"></a>01978         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a>;
<a name="l01979"></a>01979         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a> = NULL;
<a name="l01980"></a>01980         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> == <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>)
<a name="l01981"></a>01981                 rfm22b_add_rx_status(rfm22b_dev, <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gga35600b81785134630f9193e4ff1478a3a69529f54139da530e2a9df40d6be5cf1">RFM22B_RESENT_TX_PACKET</a>);
<a name="l01982"></a>01982         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = <span class="keyword">true</span>;
<a name="l01983"></a>01983         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01990"></a>01990 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_receiveStatus(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l01991"></a>01991 {
<a name="l01992"></a>01992         <a class="code" href="struct_p_h_status_packet.html">PHStatusPacketHandle</a> status = (<a class="code" href="group___tau_labs_libraries.html#gaba4b593b2564f247de7ae01fe86e908a">PHStatusPacketHandle</a>)&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>);
<a name="l01993"></a>01993         int8_t rssi = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7efa2c785a1c9feaff4db472c1f22805">rssi_dBm</a>;
<a name="l01994"></a>01994         int8_t afc = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7ee3ea27898cb9341fcbfe9d4b7ad874">afc_correction_Hz</a>;
<a name="l01995"></a>01995         uint32_t <span class="keywordtype">id</span> = status-&gt;<a class="code" href="struct_p_h_status_packet.html#a01617aa2bca7a093aa2dd7a2e7edc47a">header</a>.<a class="code" href="struct_p_h_packet_header.html#a93bf1fc396b4d98f870fee75682423b7">source_id</a>;
<a name="l01996"></a>01996         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
<a name="l01997"></a>01997         <span class="comment">// Have we seen this device recently?</span>
<a name="l01998"></a>01998         uint8_t id_idx = 0;
<a name="l01999"></a>01999         <span class="keywordflow">for</span> ( ; id_idx &lt; OPLINKSTATUS_PAIRIDS_NUMELEM; ++id_idx)
<a name="l02000"></a>02000                 <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[id_idx].<a class="code" href="structrfm22b__pair__stats.html#aecbce2c6a0ece945bc66e3fc007a25e2">pairID</a> == <span class="keywordtype">id</span>)
<a name="l02001"></a>02001                 {
<a name="l02002"></a>02002                         found = <span class="keyword">true</span>;
<a name="l02003"></a>02003                         <span class="keywordflow">break</span>;
<a name="l02004"></a>02004                 }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006         <span class="comment">// If we have seen it, update the RSSI and reset the last contact couter</span>
<a name="l02007"></a>02007         <span class="keywordflow">if</span>(found)
<a name="l02008"></a>02008         {
<a name="l02009"></a>02009                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[id_idx].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a> = rssi;
<a name="l02010"></a>02010                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[id_idx].<a class="code" href="structrfm22b__pair__stats.html#a370cbe1c41f8039f09e8f8f30d59591b">afc_correction</a> = afc;
<a name="l02011"></a>02011                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[id_idx].<a class="code" href="structrfm22b__pair__stats.html#a54401550bc26e4923636667ba5df8d34">lastContact</a> = 0;
<a name="l02012"></a>02012         }
<a name="l02013"></a>02013 
<a name="l02014"></a>02014         <span class="comment">// If we haven&#39;t seen it, find a slot to put it in.</span>
<a name="l02015"></a>02015         <span class="keywordflow">if</span> (!found)
<a name="l02016"></a>02016         {
<a name="l02017"></a>02017                 uint8_t min_idx = 0;
<a name="l02018"></a>02018                 <span class="keywordflow">if</span>(<span class="keywordtype">id</span> != rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a>)
<a name="l02019"></a>02019                 {
<a name="l02020"></a>02020                         int8_t min_rssi = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[0].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a>;
<a name="l02021"></a>02021                         <span class="keywordflow">for</span> (id_idx = 1; id_idx &lt; OPLINKSTATUS_PAIRIDS_NUMELEM; ++id_idx)
<a name="l02022"></a>02022                         {
<a name="l02023"></a>02023                                 <span class="keywordflow">if</span>(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[id_idx].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a> &lt; min_rssi)
<a name="l02024"></a>02024                                 {
<a name="l02025"></a>02025                                         min_rssi = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[id_idx].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a>;
<a name="l02026"></a>02026                                         min_idx = id_idx;
<a name="l02027"></a>02027                                 }
<a name="l02028"></a>02028                         }
<a name="l02029"></a>02029                 }
<a name="l02030"></a>02030                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[min_idx].<a class="code" href="structrfm22b__pair__stats.html#aecbce2c6a0ece945bc66e3fc007a25e2">pairID</a> = <a class="code" href="uavobjectmanager_8c.html#abaabdc509cdaba7df9f56c6c76f3ae19">id</a>;
<a name="l02031"></a>02031                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[min_idx].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a> = rssi;
<a name="l02032"></a>02032                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[min_idx].<a class="code" href="structrfm22b__pair__stats.html#a370cbe1c41f8039f09e8f8f30d59591b">afc_correction</a> = afc;
<a name="l02033"></a>02033                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[min_idx].<a class="code" href="structrfm22b__pair__stats.html#a54401550bc26e4923636667ba5df8d34">lastContact</a> = 0;
<a name="l02034"></a>02034         }
<a name="l02035"></a>02035 
<a name="l02036"></a>02036         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2adc4252d32316b4bdff1c9b64e46e7f5a">RFM22B_EVENT_RX_COMPLETE</a>;
<a name="l02037"></a>02037 }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_initConnection(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02040"></a>02040 {
<a name="l02041"></a>02041         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a37c2eab9f05656b3ef5690689b0e06c9">coordinator</a>)
<a name="l02042"></a>02042                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac19a6abb58f931e6475c592848d7d05a">RFM22B_EVENT_REQUEST_CONNECTION</a>;
<a name="l02043"></a>02043         <span class="keywordflow">else</span>
<a name="l02044"></a>02044                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a92444fc670fb008ab3e6df5fc7551209">RFM22B_EVENT_WAIT_FOR_CONNECTION</a>;
<a name="l02045"></a>02045 }
<a name="l02046"></a>02046 
<a name="l02047"></a>02047 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_requestConnection(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049         <a class="code" href="struct_p_h_connection_packet.html">PHConnectionPacketHandle</a> cph = &amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>);
<a name="l02050"></a>02050 
<a name="l02051"></a>02051         <span class="comment">// Set our connection state to requesting connection.</span>
<a name="l02052"></a>02052         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> = <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa80b5e229116b30cffa2e84ce7275e8ae">OPLINKSTATUS_LINKSTATE_CONNECTING</a>;
<a name="l02053"></a>02053 
<a name="l02054"></a>02054         <span class="comment">// Fill in the connection request</span>
<a name="l02055"></a>02055         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a52261a934b08802064ddd177d22f5a1b">header</a>.<a class="code" href="struct_p_h_packet_header.html#a19915477b7c7c9c24b293ba4db7c6426">destination_id</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a>;
<a name="l02056"></a>02056         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a52261a934b08802064ddd177d22f5a1b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ad816b782c8c40b9e03bdf092fd37bb3c">type</a> = <a class="code" href="group___tau_labs_libraries.html#ggafc6fe85f3c89dabc11ae43c825fb28ada287243cb80381ee8175f3fdcb25b69de">PACKET_TYPE_CON_REQUEST</a>;
<a name="l02057"></a>02057         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a52261a934b08802064ddd177d22f5a1b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = PH_CONNECTION_DATA_SIZE(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>));
<a name="l02058"></a>02058         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#ac0efb46843892dc7b42a503eeea6d58c">datarate</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aff7a6133350534d9bdb99e8e4856dd6e">datarate</a>;
<a name="l02059"></a>02059         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a50a68f68b6f7f8d07f91f9076d638dbd">frequency_hz</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1b85d9c8c4c8dc7ebb1449ce2febee0e">frequency_hz</a>;
<a name="l02060"></a>02060         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a4e11c88e3be1dbcacc324aace217b7e6">min_frequency</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a>;
<a name="l02061"></a>02061         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a607b2aff285e735c41dee293f8144be0">max_frequency</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a>;
<a name="l02062"></a>02062         cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#aaeff460e39a62242df16ffce090b0760">max_tx_power</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3ca116567675ce2311161483fe4c9ff4">tx_power</a>;
<a name="l02063"></a>02063         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = <span class="keyword">true</span>;
<a name="l02064"></a>02064         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#afd7377cf7b2ada828b83887653e4d3c2">send_connection_request</a> = <span class="keyword">true</span>;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l02067"></a>02067 }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_setConnectionParameters(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02070"></a>02070 {
<a name="l02071"></a>02071         <a class="code" href="struct_p_h_connection_packet.html">PHConnectionPacketHandle</a> cph = &amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>);
<a name="l02072"></a>02072 
<a name="l02073"></a>02073         <span class="comment">// Set our connection state to connected</span>
<a name="l02074"></a>02074         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> = <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>;
<a name="l02075"></a>02075  
<a name="l02076"></a>02076         <span class="comment">// Configure this modem from the connection request message.</span>
<a name="l02077"></a>02077         rfm22_setDatarate(rfm22b_dev, cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#ac0efb46843892dc7b42a503eeea6d58c">datarate</a>, <span class="keyword">true</span>);
<a name="l02078"></a>02078         <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2230c70e99a4c87dcad0ea19351ddc0a">PIOS_RFM22B_SetTxPower</a>((uint32_t)rfm22b_dev, cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#aaeff460e39a62242df16ffce090b0760">max_tx_power</a>);
<a name="l02079"></a>02079         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a> = cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a4e11c88e3be1dbcacc324aace217b7e6">min_frequency</a>;
<a name="l02080"></a>02080         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a> = cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a607b2aff285e735c41dee293f8144be0">max_frequency</a>;
<a name="l02081"></a>02081         rfm22_setNominalCarrierFrequency(rfm22b_dev, cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#a50a68f68b6f7f8d07f91f9076d638dbd">frequency_hz</a>);
<a name="l02082"></a>02082 
<a name="l02083"></a>02083         <span class="comment">// Call the com port configuration function</span>
<a name="l02084"></a>02084         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abed55ffe3e0e2832d958e692f9310b6e">com_config_cb</a> &amp;&amp; !rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a37c2eab9f05656b3ef5690689b0e06c9">coordinator</a>)
<a name="l02085"></a>02085                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abed55ffe3e0e2832d958e692f9310b6e">com_config_cb</a>(cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#ae3b874c83f519f62b7ee56a805c527d5">port</a>, cph-&gt;<a class="code" href="struct_p_h_connection_packet.html#aba21090aa4d393dc1d6e85406efa1c4b">com_speed</a>);
<a name="l02086"></a>02086 }
<a name="l02087"></a>02087 
<a name="l02088"></a>02088 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_acceptConnection(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02089"></a>02089 {
<a name="l02090"></a>02090         <span class="comment">// Set our connection state to connected</span>
<a name="l02091"></a>02091         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> = <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3fa7de41967a6e8e9aa78e1c09186e6747e">OPLINKSTATUS_LINKSTATE_CONNECTED</a>;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093         <span class="comment">// Copy the connection packet</span>
<a name="l02094"></a>02094         <a class="code" href="struct_p_h_connection_packet.html">PHConnectionPacketHandle</a> cph = (<a class="code" href="group___tau_labs_libraries.html#ga2c36c280fa284ae25b54eba06a601805">PHConnectionPacketHandle</a>)(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6c8fb7a4ca0874d372ec084d2089f43c">rx_packet</a>));
<a name="l02095"></a>02095         <a class="code" href="struct_p_h_connection_packet.html">PHConnectionPacketHandle</a> lcph = (<a class="code" href="group___tau_labs_libraries.html#ga2c36c280fa284ae25b54eba06a601805">PHConnectionPacketHandle</a>)(&amp;(rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a8bfeaddca61583fad2b2396d61d4c459">con_packet</a>));
<a name="l02096"></a>02096         memcpy((uint8_t*)lcph, (uint8_t*)cph, PH_PACKET_SIZE((<a class="code" href="struct_p_h_packet.html">PHPacketHandle</a>)cph));
<a name="l02097"></a>02097 
<a name="l02098"></a>02098         <span class="comment">// Set the destination ID to the source of the connection request message.</span>
<a name="l02099"></a>02099         <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ga2e2954db8900f7f997170fbc5047e748">PIOS_RFM22B_SetDestinationId</a>((uint32_t)rfm22b_dev, cph-&gt;header.source_id);
<a name="l02100"></a>02100 
<a name="l02101"></a>02101         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a270353a6c8c619acd575015ed7acceb6">RFM22B_EVENT_CONNECTION_ACCEPTED</a>;
<a name="l02102"></a>02102 }
<a name="l02103"></a>02103 
<a name="l02104"></a>02104 <span class="comment">// ************************************</span>
<a name="l02105"></a>02105 <span class="comment">// Initialise this hardware layer module and the rf module</span>
<a name="l02106"></a>02106 
<a name="l02107"></a>02107 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_init(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02108"></a>02108 {
<a name="l02109"></a>02109 
<a name="l02110"></a>02110         <span class="comment">// Initialize the register values.</span>
<a name="l02111"></a>02111         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa6ea2086a901b33a1f0f1535f378cdfc">device_status</a> = 0;
<a name="l02112"></a>02112         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> = 0;
<a name="l02113"></a>02113         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> = 0;
<a name="l02114"></a>02114         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ae89edb5d4197faaeab67b5f0b010f5f8">ezmac_status</a> = 0;
<a name="l02115"></a>02115 
<a name="l02116"></a>02116         <span class="comment">// Clean the LEDs</span>
<a name="l02117"></a>02117         rfm22_clearLEDs();
<a name="l02118"></a>02118 
<a name="l02119"></a>02119         <span class="comment">// Initialize the detected device statistics.</span>
<a name="l02120"></a>02120         <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; OPLINKSTATUS_PAIRIDS_NUMELEM; ++i)
<a name="l02121"></a>02121         {
<a name="l02122"></a>02122                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#aecbce2c6a0ece945bc66e3fc007a25e2">pairID</a> = 0;
<a name="l02123"></a>02123                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a44c32f693c666d5f5e1d0bef314f47d7">rssi</a> = -127;
<a name="l02124"></a>02124                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a370cbe1c41f8039f09e8f8f30d59591b">afc_correction</a> = 0;
<a name="l02125"></a>02125                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6db8d809d116a414eb5c7a826c833bc5">pair_stats</a>[i].<a class="code" href="structrfm22b__pair__stats.html#a54401550bc26e4923636667ba5df8d34">lastContact</a> = 0;
<a name="l02126"></a>02126         }
<a name="l02127"></a>02127 
<a name="l02128"></a>02128         <span class="comment">// Initlize the link stats.</span>
<a name="l02129"></a>02129         <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; RFM22B_RX_PACKET_STATS_LEN; ++i)
<a name="l02130"></a>02130                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acae5126a75716a87ed65f6d354df1d6a">rx_packet_stats</a>[i] = 0;
<a name="l02131"></a>02131 
<a name="l02132"></a>02132         <span class="comment">// Initialize the state</span>
<a name="l02133"></a>02133         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#aff1fd3341c07dab52a2a666cb6d7ddd4">link_state</a> = <a class="code" href="group___o_p_link_status.html#gga603fbe1f667581b269d26bc7fdbe3d3facbcbc2aa8f16136dc6cf68fea518a275">OPLINKSTATUS_LINKSTATE_DISCONNECTED</a>;
<a name="l02134"></a>02134         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3ca116567675ce2311161483fe4c9ff4">tx_power</a> = RFM22B_DEFAULT_TX_POWER;
<a name="l02135"></a>02135         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ada47e039e7ba782c44b154fce01005eb">destination_id</a> = 0xffffffff;
<a name="l02136"></a>02136         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ab6b40e08577ff473d6a462f6e9ba47">time_to_send</a> = <span class="keyword">false</span>;
<a name="l02137"></a>02137         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ad552e65c59e3873f29312042109562cd">time_to_send_offset</a> = 0;
<a name="l02138"></a>02138         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abf332b1a47bf1d07fbc580382acd4b95">send_status</a> = <span class="keyword">false</span>;
<a name="l02139"></a>02139         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#afd7377cf7b2ada828b83887653e4d3c2">send_connection_request</a> = <span class="keyword">false</span>;
<a name="l02140"></a>02140 
<a name="l02141"></a>02141         <span class="comment">// Initialize the packets.</span>
<a name="l02142"></a>02142         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acf4806b2fb1db624e1fa47dad08ba447">rx_packet_len</a> = 0;
<a name="l02143"></a>02143         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> = NULL;
<a name="l02144"></a>02144         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a4c0368362858e8e4450ce094670e9b3d">prev_tx_packet</a> = NULL;
<a name="l02145"></a>02145         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8279ef420f8e1d3c6773b8cb528f5122">tx_seq</a> = 0;
<a name="l02146"></a>02146         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#ad73defbcdc26cc6438d0f28723a909e7">rx_seq</a> = 0;
<a name="l02147"></a>02147         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19e3336c0f0c2da02404e828d688cbd3">data_packet</a>.<a class="code" href="struct_p_h_packet.html#a930af3e24c9d3aa4a29fa0e72b62f12b">header</a>.<a class="code" href="struct_p_h_packet_header.html#ab8dbaddf1009694724c1f40b82bcb314">data_size</a> = 0;
<a name="l02148"></a>02148         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a5d1bb77d70e2da36174e66d08e42cac6">in_rx_mode</a> = <span class="keyword">false</span>;
<a name="l02149"></a>02149 
<a name="l02150"></a>02150         <span class="comment">// software reset the RF chip .. following procedure according to Si4x3x Errata (rev. B)</span>
<a name="l02151"></a>02151         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl1, RFM22_opfc1_swres);
<a name="l02152"></a>02152 
<a name="l02153"></a>02153         <span class="comment">// wait 26ms</span>
<a name="l02154"></a>02154         <a class="code" href="group___p_i_o_s___d_e_l_a_y.html#gacde17b263c115e410008da1357dd4ff8">PIOS_DELAY_WaitmS</a>(26);
<a name="l02155"></a>02155 
<a name="l02156"></a>02156         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 50; i &gt; 0; i--)
<a name="l02157"></a>02157         {
<a name="l02158"></a>02158                 <span class="comment">// wait 1ms</span>
<a name="l02159"></a>02159                 <a class="code" href="group___p_i_o_s___d_e_l_a_y.html#gacde17b263c115e410008da1357dd4ff8">PIOS_DELAY_WaitmS</a>(1);
<a name="l02160"></a>02160 
<a name="l02161"></a>02161                 <span class="comment">// read the status registers</span>
<a name="l02162"></a>02162                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> = rfm22_read(rfm22b_dev, RFM22_interrupt_status1);
<a name="l02163"></a>02163                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> = rfm22_read(rfm22b_dev, RFM22_interrupt_status2);
<a name="l02164"></a>02164                 <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> &amp; RFM22_is2_ichiprdy) <span class="keywordflow">break</span>;
<a name="l02165"></a>02165         }
<a name="l02166"></a>02166 
<a name="l02167"></a>02167         <span class="comment">// ****************</span>
<a name="l02168"></a>02168 
<a name="l02169"></a>02169         <span class="comment">// read status - clears interrupt</span>
<a name="l02170"></a>02170         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa6ea2086a901b33a1f0f1535f378cdfc">device_status</a> = rfm22_read(rfm22b_dev, RFM22_device_status);
<a name="l02171"></a>02171         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> = rfm22_read(rfm22b_dev, RFM22_interrupt_status1);
<a name="l02172"></a>02172         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> = rfm22_read(rfm22b_dev, RFM22_interrupt_status2);
<a name="l02173"></a>02173         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ae89edb5d4197faaeab67b5f0b010f5f8">ezmac_status</a> = rfm22_read(rfm22b_dev, RFM22_ezmac_status);
<a name="l02174"></a>02174 
<a name="l02175"></a>02175         <span class="comment">// disable all interrupts</span>
<a name="l02176"></a>02176         rfm22_write(rfm22b_dev, RFM22_interrupt_enable1, 0x00);
<a name="l02177"></a>02177         rfm22_write(rfm22b_dev, RFM22_interrupt_enable2, 0x00);
<a name="l02178"></a>02178 
<a name="l02179"></a>02179         <span class="comment">// ****************</span>
<a name="l02180"></a>02180 
<a name="l02181"></a>02181         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa6ea2086a901b33a1f0f1535f378cdfc">device_status</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a9a3b8dfbadc7d813f3f9a2e9a40373f7">int_status1</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a59c62fb8b9b007e94890dc8a9d9c72e3">int_status2</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ae89edb5d4197faaeab67b5f0b010f5f8">ezmac_status</a> = 0;
<a name="l02182"></a>02182 
<a name="l02183"></a>02183         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> = 0;
<a name="l02184"></a>02184 
<a name="l02185"></a>02185         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> = 0;
<a name="l02186"></a>02186 
<a name="l02187"></a>02187         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a27f8f42b03439de7810e39e4240cc9dc">frequency_hop_channel</a> = 0;
<a name="l02188"></a>02188 
<a name="l02189"></a>02189         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a7ee3ea27898cb9341fcbfe9d4b7ad874">afc_correction_Hz</a> = 0;
<a name="l02190"></a>02190 
<a name="l02191"></a>02191         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 0;
<a name="l02192"></a>02192         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#af71e33856164ba7654a523173441ecb3">tx_complete_ticks</a> = 0;
<a name="l02193"></a>02193         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1a3dc2a287da24ec20da3daba8182266">rx_complete_ticks</a> = 0;
<a name="l02194"></a>02194 
<a name="l02195"></a>02195         <span class="comment">// ****************</span>
<a name="l02196"></a>02196         <span class="comment">// read the RF chip ID bytes</span>
<a name="l02197"></a>02197 
<a name="l02198"></a>02198         <span class="comment">// read the device type</span>
<a name="l02199"></a>02199         uint8_t device_type = rfm22_read(rfm22b_dev, RFM22_DEVICE_TYPE) &amp; RFM22_DT_MASK;
<a name="l02200"></a>02200         <span class="comment">// read the device version</span>
<a name="l02201"></a>02201         uint8_t device_version = rfm22_read(rfm22b_dev, RFM22_DEVICE_VERSION) &amp; RFM22_DV_MASK;
<a name="l02202"></a>02202 
<a name="l02203"></a>02203 <span class="preprocessor">#if defined(RFM22_DEBUG)</span>
<a name="l02204"></a>02204 <span class="preprocessor"></span>        DEBUG_PRINTF(2, <span class="stringliteral">&quot;rf device type: %d\n\r&quot;</span>, device_type);
<a name="l02205"></a>02205         DEBUG_PRINTF(2, <span class="stringliteral">&quot;rf device version: %d\n\r&quot;</span>, device_version);
<a name="l02206"></a>02206 <span class="preprocessor">#endif</span>
<a name="l02207"></a>02207 <span class="preprocessor"></span>
<a name="l02208"></a>02208         <span class="keywordflow">if</span> (device_type != 0x08)
<a name="l02209"></a>02209         {
<a name="l02210"></a>02210 <span class="preprocessor">#if defined(RFM22_DEBUG)</span>
<a name="l02211"></a>02211 <span class="preprocessor"></span>                DEBUG_PRINTF(2, <span class="stringliteral">&quot;rf device type: INCORRECT - should be 0x08\n\r&quot;</span>);
<a name="l02212"></a>02212 <span class="preprocessor">#endif</span>
<a name="l02213"></a>02213 <span class="preprocessor"></span>                <span class="comment">// incorrect RF module type</span>
<a name="l02214"></a>02214                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>;
<a name="l02215"></a>02215         }
<a name="l02216"></a>02216         <span class="keywordflow">if</span> (device_version != RFM22_DEVICE_VERSION_B1 &amp;&amp; device_version != RFM22_DEVICE_VERSION_B2)
<a name="l02217"></a>02217         {
<a name="l02218"></a>02218 <span class="preprocessor">#if defined(RFM22_DEBUG)</span>
<a name="l02219"></a>02219 <span class="preprocessor"></span>                DEBUG_PRINTF(2, <span class="stringliteral">&quot;rf device version: INCORRECT\n\r&quot;</span>);
<a name="l02220"></a>02220 <span class="preprocessor">#endif</span>
<a name="l02221"></a>02221 <span class="preprocessor"></span>                <span class="comment">// incorrect RF module version</span>
<a name="l02222"></a>02222                 <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>;
<a name="l02223"></a>02223         }
<a name="l02224"></a>02224 
<a name="l02225"></a>02225         <span class="comment">// ****************</span>
<a name="l02226"></a>02226         <span class="comment">// set the minimum and maximum carrier frequency allowed</span>
<a name="l02227"></a>02227         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#acfd89dda5551722d12e887369e3e6616">min_frequency</a> = RFM22B_DEFAULT_MIN_FREQUENCY;
<a name="l02228"></a>02228         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a98085c05f6be6d71a6fbe868ee5f29ef">max_frequency</a> = RFM22B_DEFAULT_MAX_FREQUENCY;
<a name="l02229"></a>02229         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a1b85d9c8c4c8dc7ebb1449ce2febee0e">frequency_hz</a> = RFM22B_DEFAULT_FREQUENCY;
<a name="l02230"></a>02230 
<a name="l02231"></a>02231         <span class="comment">// ****************</span>
<a name="l02232"></a>02232         <span class="comment">// calibrate our RF module to be exactly on frequency .. different for every module</span>
<a name="l02233"></a>02233         rfm22_write(rfm22b_dev, RFM22_xtal_osc_load_cap, OSC_LOAD_CAP);
<a name="l02234"></a>02234 
<a name="l02235"></a>02235         <span class="comment">// ****************</span>
<a name="l02236"></a>02236 
<a name="l02237"></a>02237         <span class="comment">// disable Low Duty Cycle Mode</span>
<a name="l02238"></a>02238         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl2, 0x00);
<a name="l02239"></a>02239 
<a name="l02240"></a>02240         <span class="comment">// 1MHz clock output</span>
<a name="l02241"></a>02241         rfm22_write(rfm22b_dev, RFM22_cpu_output_clk, RFM22_coc_1MHz);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243         <span class="comment">// READY mode</span>
<a name="l02244"></a>02244         rfm22_write(rfm22b_dev, RFM22_op_and_func_ctrl1, RFM22_opfc1_xton);
<a name="l02245"></a>02245 
<a name="l02246"></a>02246         <span class="comment">// choose the 3 GPIO pin functions</span>
<a name="l02247"></a>02247         <span class="comment">// GPIO port use default value</span>
<a name="l02248"></a>02248         rfm22_write(rfm22b_dev, RFM22_io_port_config, RFM22_io_port_default);
<a name="l02249"></a>02249         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2fc3047fbb17be7e546cab4e24ee2b28">cfg</a>.<a class="code" href="structpios__rfm22b__cfg.html#ac8a55d600d26585b2fb4d58c4e197f9b">gpio_direction</a> == <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggaccc7d029df9e5a96151a68e64f4be7e2a87c92cb693852456c28e74d75b67b00a">GPIO0_TX_GPIO1_RX</a>) {
<a name="l02250"></a>02250                 rfm22_write(rfm22b_dev, RFM22_gpio0_config, RFM22_gpio0_config_drv3 | RFM22_gpio0_config_txstate);      <span class="comment">// GPIO0 = TX State (to control RF Switch)</span>
<a name="l02251"></a>02251                 rfm22_write(rfm22b_dev, RFM22_gpio1_config, RFM22_gpio1_config_drv3 | RFM22_gpio1_config_rxstate);      <span class="comment">// GPIO1 = RX State (to control RF Switch)</span>
<a name="l02252"></a>02252         } <span class="keywordflow">else</span> {
<a name="l02253"></a>02253                 rfm22_write(rfm22b_dev, RFM22_gpio0_config, RFM22_gpio0_config_drv3 | RFM22_gpio0_config_rxstate);      <span class="comment">// GPIO0 = TX State (to control RF Switch)</span>
<a name="l02254"></a>02254                 rfm22_write(rfm22b_dev, RFM22_gpio1_config, RFM22_gpio1_config_drv3 | RFM22_gpio1_config_txstate);      <span class="comment">// GPIO1 = RX State (to control RF Switch)              </span>
<a name="l02255"></a>02255         }
<a name="l02256"></a>02256         rfm22_write(rfm22b_dev, RFM22_gpio2_config, RFM22_gpio2_config_drv3 | RFM22_gpio2_config_cca);          <span class="comment">// GPIO2 = Clear Channel Assessment</span>
<a name="l02257"></a>02257 
<a name="l02258"></a>02258         <span class="comment">// ****************</span>
<a name="l02259"></a>02259 
<a name="l02260"></a>02260         <span class="comment">// initialize the frequency hopping step size</span>
<a name="l02261"></a>02261         uint32_t freq_hop_step_size = 50000;
<a name="l02262"></a>02262         freq_hop_step_size /= 10000;    <span class="comment">// in 10kHz increments</span>
<a name="l02263"></a>02263         <span class="keywordflow">if</span> (freq_hop_step_size &gt; 255) freq_hop_step_size = 255;
<a name="l02264"></a>02264         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ac3d7ab6d15ced50a36ffc03275b5ea">frequency_hop_step_size_reg</a> = freq_hop_step_size;
<a name="l02265"></a>02265 
<a name="l02266"></a>02266         <span class="comment">// FIFO mode, GFSK modulation</span>
<a name="l02267"></a>02267         uint8_t fd_bit = rfm22_read(rfm22b_dev, RFM22_modulation_mode_control2) &amp; RFM22_mmc2_fd;
<a name="l02268"></a>02268         rfm22_write(rfm22b_dev, RFM22_modulation_mode_control2, RFM22_mmc2_trclk_clk_none | RFM22_mmc2_dtmod_fifo | fd_bit | RFM22_mmc2_modtyp_gfsk);
<a name="l02269"></a>02269 
<a name="l02270"></a>02270         <span class="comment">// setup to read the internal temperature sensor</span>
<a name="l02271"></a>02271 
<a name="l02272"></a>02272         <span class="comment">// ADC used to sample the temperature sensor</span>
<a name="l02273"></a>02273         uint8_t adc_config = RFM22_ac_adcsel_temp_sensor | RFM22_ac_adcref_bg;
<a name="l02274"></a>02274         rfm22_write(rfm22b_dev, RFM22_adc_config, adc_config);
<a name="l02275"></a>02275 
<a name="l02276"></a>02276         <span class="comment">// adc offset</span>
<a name="l02277"></a>02277         rfm22_write(rfm22b_dev, RFM22_adc_sensor_amp_offset, 0);
<a name="l02278"></a>02278 
<a name="l02279"></a>02279         <span class="comment">// temp sensor calibration .. �40C to +64C 0.5C resolution</span>
<a name="l02280"></a>02280         rfm22_write(rfm22b_dev, RFM22_temp_sensor_calib, RFM22_tsc_tsrange0 | RFM22_tsc_entsoffs);
<a name="l02281"></a>02281 
<a name="l02282"></a>02282         <span class="comment">// temp sensor offset</span>
<a name="l02283"></a>02283         rfm22_write(rfm22b_dev, RFM22_temp_value_offset, 0);
<a name="l02284"></a>02284 
<a name="l02285"></a>02285         <span class="comment">// start an ADC conversion</span>
<a name="l02286"></a>02286         rfm22_write(rfm22b_dev, RFM22_adc_config, adc_config | RFM22_ac_adcstartbusy);
<a name="l02287"></a>02287 
<a name="l02288"></a>02288         <span class="comment">// set the RSSI threshold interrupt to about -90dBm</span>
<a name="l02289"></a>02289         rfm22_write(rfm22b_dev, RFM22_rssi_threshold_clear_chan_indicator, (-90 + 122) * 2);
<a name="l02290"></a>02290 
<a name="l02291"></a>02291         <span class="comment">// enable the internal Tx &amp; Rx packet handlers (without CRC)</span>
<a name="l02292"></a>02292         rfm22_write(rfm22b_dev, RFM22_data_access_control, RFM22_dac_enpacrx | RFM22_dac_enpactx);
<a name="l02293"></a>02293 
<a name="l02294"></a>02294         <span class="comment">// x-nibbles tx preamble</span>
<a name="l02295"></a>02295         rfm22_write(rfm22b_dev, RFM22_preamble_length, TX_PREAMBLE_NIBBLES);
<a name="l02296"></a>02296         <span class="comment">// x-nibbles rx preamble detection</span>
<a name="l02297"></a>02297         rfm22_write(rfm22b_dev, RFM22_preamble_detection_ctrl1, RX_PREAMBLE_NIBBLES &lt;&lt; 3);
<a name="l02298"></a>02298 
<a name="l02299"></a>02299 <span class="preprocessor">#ifdef PIOS_RFM22_NO_HEADER</span>
<a name="l02300"></a>02300 <span class="preprocessor"></span>        <span class="comment">// header control - we are not using the header</span>
<a name="l02301"></a>02301         rfm22_write(rfm22b_dev, RFM22_header_control1, RFM22_header_cntl1_bcen_none | RFM22_header_cntl1_hdch_none);
<a name="l02302"></a>02302 
<a name="l02303"></a>02303         <span class="comment">// no header bytes, synchronization word length 3, 2, 1 &amp; 0 used, packet length included in header.</span>
<a name="l02304"></a>02304         rfm22_write(rfm22b_dev, RFM22_header_control2, RFM22_header_cntl2_hdlen_none |
<a name="l02305"></a>02305                                                         RFM22_header_cntl2_synclen_3210 | ((TX_PREAMBLE_NIBBLES &gt;&gt; 8) &amp; 0x01));
<a name="l02306"></a>02306 <span class="preprocessor">#else</span>
<a name="l02307"></a>02307 <span class="preprocessor"></span>        <span class="comment">// header control - using a 4 by header with broadcast of 0xffffffff</span>
<a name="l02308"></a>02308         rfm22_write(rfm22b_dev, RFM22_header_control1,
<a name="l02309"></a>02309                                                         RFM22_header_cntl1_bcen_0 |
<a name="l02310"></a>02310                                                         RFM22_header_cntl1_bcen_1 |
<a name="l02311"></a>02311                                                         RFM22_header_cntl1_bcen_2 |
<a name="l02312"></a>02312                                                         RFM22_header_cntl1_bcen_3 |
<a name="l02313"></a>02313                                                         RFM22_header_cntl1_hdch_0 |
<a name="l02314"></a>02314                                                         RFM22_header_cntl1_hdch_1 |
<a name="l02315"></a>02315                                                         RFM22_header_cntl1_hdch_2 |
<a name="l02316"></a>02316                                                         RFM22_header_cntl1_hdch_3);
<a name="l02317"></a>02317         <span class="comment">// Check all bit of all bytes of the header</span>
<a name="l02318"></a>02318         rfm22_write(rfm22b_dev, RFM22_header_enable0, 0xff);
<a name="l02319"></a>02319         rfm22_write(rfm22b_dev, RFM22_header_enable1, 0xff);
<a name="l02320"></a>02320         rfm22_write(rfm22b_dev, RFM22_header_enable2, 0xff);
<a name="l02321"></a>02321         rfm22_write(rfm22b_dev, RFM22_header_enable3, 0xff);
<a name="l02322"></a>02322         <span class="comment">// Set the ID to be checked</span>
<a name="l02323"></a>02323         uint32_t <span class="keywordtype">id</span> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#ac608ccb62cbd144c8053aaacb8c14fcf">deviceID</a>;
<a name="l02324"></a>02324         rfm22_write(rfm22b_dev, RFM22_check_header0, <span class="keywordtype">id</span> &amp; 0xff);
<a name="l02325"></a>02325         rfm22_write(rfm22b_dev, RFM22_check_header1, (<span class="keywordtype">id</span> &gt;&gt; 8) &amp; 0xff);
<a name="l02326"></a>02326         rfm22_write(rfm22b_dev, RFM22_check_header2, (<span class="keywordtype">id</span> &gt;&gt; 16) &amp; 0xff);
<a name="l02327"></a>02327         rfm22_write(rfm22b_dev, RFM22_check_header3, (<span class="keywordtype">id</span> &gt;&gt; 24) &amp; 0xff);
<a name="l02328"></a>02328         <span class="comment">// 4 header bytes, synchronization word length 3, 2, 1 &amp; 0 used, packet length included in header.</span>
<a name="l02329"></a>02329         rfm22_write(rfm22b_dev, RFM22_header_control2,
<a name="l02330"></a>02330                                                         RFM22_header_cntl2_hdlen_3210 |
<a name="l02331"></a>02331                                                         RFM22_header_cntl2_synclen_3210 |
<a name="l02332"></a>02332                                                         ((TX_PREAMBLE_NIBBLES &gt;&gt; 8) &amp; 0x01));
<a name="l02333"></a>02333 <span class="preprocessor">#endif</span>
<a name="l02334"></a>02334 <span class="preprocessor"></span>
<a name="l02335"></a>02335         <span class="comment">// sync word</span>
<a name="l02336"></a>02336         rfm22_write(rfm22b_dev, RFM22_sync_word3, SYNC_BYTE_1);
<a name="l02337"></a>02337         rfm22_write(rfm22b_dev, RFM22_sync_word2, SYNC_BYTE_2);
<a name="l02338"></a>02338         rfm22_write(rfm22b_dev, RFM22_sync_word1, SYNC_BYTE_3);
<a name="l02339"></a>02339         rfm22_write(rfm22b_dev, RFM22_sync_word0, SYNC_BYTE_4);
<a name="l02340"></a>02340 
<a name="l02341"></a>02341         rfm22_write(rfm22b_dev, RFM22_agc_override1, RFM22_agc_ovr1_agcen);
<a name="l02342"></a>02342 
<a name="l02343"></a>02343         <span class="comment">// set frequency hopping channel step size (multiples of 10kHz)</span>
<a name="l02344"></a>02344         rfm22_write(rfm22b_dev, RFM22_frequency_hopping_step_size, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2ac3d7ab6d15ced50a36ffc03275b5ea">frequency_hop_step_size_reg</a>);
<a name="l02345"></a>02345 
<a name="l02346"></a>02346         <span class="comment">// set the tx power</span>
<a name="l02347"></a>02347         rfm22_write(rfm22b_dev, RFM22_tx_power, RFM22_tx_pwr_papeaken | RFM22_tx_pwr_papeaklvl_0 | RFM22_tx_pwr_lna_sw | rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3ca116567675ce2311161483fe4c9ff4">tx_power</a>);
<a name="l02348"></a>02348 
<a name="l02349"></a>02349         <span class="comment">// TX FIFO Almost Full Threshold (0 - 63)</span>
<a name="l02350"></a>02350         rfm22_write(rfm22b_dev, RFM22_tx_fifo_control1, TX_FIFO_HI_WATERMARK);
<a name="l02351"></a>02351 
<a name="l02352"></a>02352         <span class="comment">// TX FIFO Almost Empty Threshold (0 - 63)</span>
<a name="l02353"></a>02353         rfm22_write(rfm22b_dev, RFM22_tx_fifo_control2, TX_FIFO_LO_WATERMARK);
<a name="l02354"></a>02354 
<a name="l02355"></a>02355         <span class="comment">// RX FIFO Almost Full Threshold (0 - 63)</span>
<a name="l02356"></a>02356         rfm22_write(rfm22b_dev, RFM22_rx_fifo_control, RX_FIFO_HI_WATERMARK);
<a name="l02357"></a>02357 
<a name="l02358"></a>02358         <span class="comment">// Set the frequency calibration</span>
<a name="l02359"></a>02359         rfm22_write(rfm22b_dev, RFM22_xtal_osc_load_cap, rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a2fc3047fbb17be7e546cab4e24ee2b28">cfg</a>.<a class="code" href="structpios__rfm22b__cfg.html#a20784354b27515bed19c3fa02b880a10">RFXtalCap</a>);
<a name="l02360"></a>02360 
<a name="l02361"></a>02361         <span class="comment">// Initialize the frequency and datarate to te default.</span>
<a name="l02362"></a>02362         rfm22_setNominalCarrierFrequency(rfm22b_dev, RFM22B_DEFAULT_FREQUENCY);
<a name="l02363"></a>02363         rfm22_setDatarate(rfm22b_dev, RFM22B_DEFAULT_RX_DATARATE, <span class="keyword">true</span>);
<a name="l02364"></a>02364 
<a name="l02365"></a>02365         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ab2a453aeb15fd52d7ee950515ccc396c">RFM22B_EVENT_INITIALIZED</a>;
<a name="l02366"></a>02366 }
<a name="l02367"></a>02367 
<a name="l02368"></a>02368 <span class="keyword">static</span> <span class="keywordtype">void</span> rfm22_clearLEDs() {
<a name="l02369"></a>02369         LINK_LED_OFF;
<a name="l02370"></a>02370         RX_LED_OFF;
<a name="l02371"></a>02371         TX_LED_OFF;
<a name="l02372"></a>02372 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l02373"></a>02373 <span class="preprocessor"></span>        D1_LED_OFF;
<a name="l02374"></a>02374         D2_LED_OFF;
<a name="l02375"></a>02375         D3_LED_OFF;
<a name="l02376"></a>02376         D4_LED_OFF;
<a name="l02377"></a>02377 <span class="preprocessor">#endif</span>
<a name="l02378"></a>02378 <span class="preprocessor"></span>}
<a name="l02379"></a>02379 
<a name="l02380"></a>02380 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_timeout(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02381"></a>02381 {
<a name="l02382"></a>02382         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#ae710ec372ffa9365a23fcd2d8f9f8e0e">timeouts</a>++;
<a name="l02383"></a>02383         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#add7ce31439ee28ce51c07a4167666141">packet_start_ticks</a> = 0;
<a name="l02384"></a>02384         <span class="comment">// Release the Tx packet if it&#39;s set.</span>
<a name="l02385"></a>02385         <span class="keywordflow">if</span> (rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a3b7420bb896bb0b1504c4795c8af9087">tx_packet</a> != 0)
<a name="l02386"></a>02386         {
<a name="l02387"></a>02387                 rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a19f0507e484216186dab475d3d5f15a0">tx_data_rd</a> = rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#a6fa47c8dff475d9292a547732cbe4138">tx_data_wr</a> = 0;
<a name="l02388"></a>02388         }
<a name="l02389"></a>02389         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#aa31cc789855ee5b29487085603190aa3">rx_buffer_wr</a> = 0;
<a name="l02390"></a>02390         TX_LED_OFF;
<a name="l02391"></a>02391         RX_LED_OFF;
<a name="l02392"></a>02392 <span class="preprocessor">#ifdef PIOS_RFM22B_DEBUG_ON_TELEM</span>
<a name="l02393"></a>02393 <span class="preprocessor"></span>        D1_LED_OFF;
<a name="l02394"></a>02394         D2_LED_OFF;
<a name="l02395"></a>02395         D3_LED_OFF;
<a name="l02396"></a>02396         D4_LED_OFF;
<a name="l02397"></a>02397 <span class="preprocessor">#endif</span>
<a name="l02398"></a>02398 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2a705b1f62a633333da46845128deb24ee">RFM22B_EVENT_TX_START</a>;
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 
<a name="l02401"></a>02401 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_error(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02402"></a>02402 {
<a name="l02403"></a>02403         rfm22b_dev-&gt;<a class="code" href="structpios__rfm22b__dev.html#abb8511852ba38b8de9c19aaae6a495f0">stats</a>.<a class="code" href="structrfm22b__stats.html#a8d5014c62b137509e9a5a51fe9e1acae">resets</a>++;
<a name="l02404"></a>02404         rfm22_clearLEDs();
<a name="l02405"></a>02405         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2ac81159af4ef62745e2379cf638c4023e">RFM22B_EVENT_INITIALIZE</a>;
<a name="l02406"></a>02406 }
<a name="l02407"></a>02407 
<a name="l02414"></a>02414 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#gafefba9f85ea9fb8d2c610fe3759a00c2">pios_rfm22b_event</a> rfm22_fatal_error(<span class="keyword">struct</span> <a class="code" href="structpios__rfm22b__dev.html">pios_rfm22b_dev</a> *rfm22b_dev)
<a name="l02415"></a>02415 {
<a name="l02416"></a>02416         <span class="comment">// RF module error .. flash the LED&#39;s</span>
<a name="l02417"></a>02417         rfm22_clearLEDs();
<a name="l02418"></a>02418         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; 16; j++)
<a name="l02419"></a>02419         {
<a name="l02420"></a>02420                 USB_LED_ON;
<a name="l02421"></a>02421                 LINK_LED_ON;
<a name="l02422"></a>02422                 RX_LED_OFF;
<a name="l02423"></a>02423                 TX_LED_OFF;
<a name="l02424"></a>02424 
<a name="l02425"></a>02425                 <a class="code" href="group___p_i_o_s___d_e_l_a_y.html#gacde17b263c115e410008da1357dd4ff8">PIOS_DELAY_WaitmS</a>(200);
<a name="l02426"></a>02426 
<a name="l02427"></a>02427                 USB_LED_OFF;
<a name="l02428"></a>02428                 LINK_LED_OFF;
<a name="l02429"></a>02429                 RX_LED_ON;
<a name="l02430"></a>02430                 TX_LED_ON;
<a name="l02431"></a>02431 
<a name="l02432"></a>02432                 <a class="code" href="group___p_i_o_s___d_e_l_a_y.html#gacde17b263c115e410008da1357dd4ff8">PIOS_DELAY_WaitmS</a>(200);
<a name="l02433"></a>02433         }
<a name="l02434"></a>02434 
<a name="l02435"></a>02435         <a class="code" href="group___p_i_o_s___d_e_l_a_y.html#gacde17b263c115e410008da1357dd4ff8">PIOS_DELAY_WaitmS</a>(1000);
<a name="l02436"></a>02436 
<a name="l02437"></a>02437         PIOS_Assert(0);
<a name="l02438"></a>02438 
<a name="l02439"></a>02439         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___r_f_m22_b.html#ggafefba9f85ea9fb8d2c610fe3759a00c2aed906179c93278bdedaa584719416009">RFM22B_EVENT_FATAL_ERROR</a>;
<a name="l02440"></a>02440 }
<a name="l02441"></a>02441 
<a name="l02442"></a>02442 <span class="comment">// ************************************</span>
<a name="l02443"></a>02443 
<a name="l02444"></a>02444 <span class="preprocessor">#endif</span>
<a name="l02445"></a>02445 <span class="preprocessor"></span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="pios__rfm22b_8c.html">pios_rfm22b.c</a>      </li>

    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
