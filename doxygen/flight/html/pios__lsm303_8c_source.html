<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>TauLabs: /home/jb/code/TauLabs/flight/PiOS/Common/pios_lsm303.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="icon_128x128.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">TauLabs
   
   </div>
   <div id="projectbrief">TauLabsfirmware</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('pios__lsm303_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/home/jb/code/TauLabs/flight/PiOS/Common/pios_lsm303.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="pios__lsm303_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00011"></a>00011 <span class="comment">/*</span>
<a name="l00012"></a>00012 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00013"></a>00013 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00014"></a>00014 <span class="comment"> * the Free Software Foundation; either version 3 of the License, or</span>
<a name="l00015"></a>00015 <span class="comment"> * (at your option) any later version.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00018"></a>00018 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<a name="l00019"></a>00019 <span class="comment"> * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> * for more details.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * You should have received a copy of the GNU General Public License along</span>
<a name="l00023"></a>00023 <span class="comment"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<a name="l00024"></a>00024 <span class="comment"> * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="comment">/* Project Includes */</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;pios.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;physical_constants.h&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#if defined(PIOS_INCLUDE_LSM303)</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>
<a name="l00033"></a>00033 <span class="comment">/* Private constants */</span>
<a name="l00034"></a>00034 <span class="preprocessor">#define LSM303_TASK_PRIORITY    (tskIDLE_PRIORITY + configMAX_PRIORITIES - 1)   // max priority</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#define LSM303_TASK_STACK               (512 / 4)</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="fifo__buffer_8h.html" title="GPIO functions header.">fifo_buffer.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">/* Global Variables */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#ga541e751cf6c930fc56ab31e10b857a74">00041</a> <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ga541e751cf6c930fc56ab31e10b857a74">pios_lsm303_dev_magic</a> {
<a name="l00042"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#gga541e751cf6c930fc56ab31e10b857a74a41c2c7ef1afe6e72780e4cbc0eb274d6">00042</a>     <a class="code" href="group___p_i_o_s___l_s_m303.html#gga541e751cf6c930fc56ab31e10b857a74a41c2c7ef1afe6e72780e4cbc0eb274d6">PIOS_LSM303_DEV_MAGIC</a> = 0xef8e9e1d,
<a name="l00043"></a>00043 };
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#define PIOS_LSM303_MAX_QUEUESIZE 2</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="structlsm303__dev.html">00047</a> <span class="keyword">struct </span><a class="code" href="structlsm303__dev.html">lsm303_dev</a> {
<a name="l00048"></a><a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">00048</a>         uint32_t <a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>;
<a name="l00049"></a><a class="code" href="structlsm303__dev.html#a43a431687ad3d1280504751dd67b99ad">00049</a>         uint8_t <a class="code" href="structlsm303__dev.html#a43a431687ad3d1280504751dd67b99ad">i2c_addr_accel</a>;
<a name="l00050"></a><a class="code" href="structlsm303__dev.html#a43b3cb1f2405df34e8542d968e9eb321">00050</a>         uint8_t <a class="code" href="structlsm303__dev.html#a43b3cb1f2405df34e8542d968e9eb321">i2c_addr_mag</a>;
<a name="l00051"></a><a class="code" href="structlsm303__dev.html#a925acad41a5880d09927a1d63130e055">00051</a>         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gafbb0e59427f40a8d9b0e901af02bb7b3">pios_lsm303_accel_range</a> <a class="code" href="structlsm303__dev.html#a925acad41a5880d09927a1d63130e055">accel_range</a>;
<a name="l00052"></a><a class="code" href="structlsm303__dev.html#a9c4089c3f5674a6fc5d51d06d90501cc">00052</a>         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ga24737af5b503329ca628b921e32ec8d8">pios_lsm303_mag_range</a> <a class="code" href="structlsm303__dev.html#a9c4089c3f5674a6fc5d51d06d90501cc">mag_range</a>;
<a name="l00053"></a><a class="code" href="structlsm303__dev.html#aadc09417d06ef07b4f4eb39b74f947a0">00053</a>         xQueueHandle <a class="code" href="structlsm303__dev.html#aadc09417d06ef07b4f4eb39b74f947a0">queue_accel</a>;
<a name="l00054"></a><a class="code" href="structlsm303__dev.html#a4801df95b04cdb58185c818dca8ae4ef">00054</a>         xQueueHandle <a class="code" href="structlsm303__dev.html#a4801df95b04cdb58185c818dca8ae4ef">queue_mag</a>;
<a name="l00055"></a><a class="code" href="structlsm303__dev.html#aa53f45353583c54556c8fd920144726a">00055</a>         xTaskHandle <a class="code" href="structlsm303__dev.html#aa53f45353583c54556c8fd920144726a">TaskHandle</a>;
<a name="l00056"></a><a class="code" href="structlsm303__dev.html#ab14a7b6518eb1699835c6d284425a6bb">00056</a>         xSemaphoreHandle <a class="code" href="structlsm303__dev.html#ab14a7b6518eb1699835c6d284425a6bb">data_ready_sema</a>;
<a name="l00057"></a><a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">00057</a>         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpios__lsm303__cfg.html">pios_lsm303_cfg</a> *<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>;
<a name="l00058"></a><a class="code" href="structlsm303__dev.html#a70f59374a7f9e9a6297167795f5b8bdf">00058</a>         <span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ga541e751cf6c930fc56ab31e10b857a74">pios_lsm303_dev_magic</a> <a class="code" href="structlsm303__dev.html#a70f59374a7f9e9a6297167795f5b8bdf">magic</a>;
<a name="l00059"></a>00059 };
<a name="l00060"></a>00060 
<a name="l00062"></a><a class="code" href="structpios__lsm303__accel__data.html">00062</a> <span class="keyword">struct </span><a class="code" href="structpios__lsm303__accel__data.html" title="Internal representation of unscaled accelerometer data.">pios_lsm303_accel_data</a> {
<a name="l00063"></a><a class="code" href="structpios__lsm303__accel__data.html#aec4209992177ea4a76d150164ab90f9e">00063</a>         int16_t <a class="code" href="structpios__lsm303__accel__data.html#aec4209992177ea4a76d150164ab90f9e">accel_x</a>;
<a name="l00064"></a><a class="code" href="structpios__lsm303__accel__data.html#a7ffd1885ce614cf3163ee96ef56ace76">00064</a>         int16_t <a class="code" href="structpios__lsm303__accel__data.html#a7ffd1885ce614cf3163ee96ef56ace76">accel_y</a>;
<a name="l00065"></a><a class="code" href="structpios__lsm303__accel__data.html#a426a988b03d546ea4036551041bf00d1">00065</a>         int16_t <a class="code" href="structpios__lsm303__accel__data.html#a426a988b03d546ea4036551041bf00d1">accel_z</a>;
<a name="l00066"></a>00066 };
<a name="l00067"></a>00067 
<a name="l00069"></a><a class="code" href="structpios__lsm303__mag__data.html">00069</a> <span class="keyword">struct </span><a class="code" href="structpios__lsm303__mag__data.html" title="Internal representation of unscaled magnetometer data.">pios_lsm303_mag_data</a> {
<a name="l00070"></a><a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">00070</a>         int16_t <a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">mag_x</a>;
<a name="l00071"></a><a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">00071</a>         int16_t <a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">mag_y</a>;
<a name="l00072"></a><a class="code" href="structpios__lsm303__mag__data.html#a2989fa1111551a8ec9135c7446bb0a03">00072</a>         int16_t <a class="code" href="structpios__lsm303__mag__data.html#a2989fa1111551a8ec9135c7446bb0a03">mag_z</a>;
<a name="l00073"></a>00073 };
<a name="l00074"></a>00074 
<a name="l00076"></a>00076 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structlsm303__dev.html">lsm303_dev</a> *pios_lsm303_dev;
<a name="l00077"></a>00077 
<a name="l00079"></a>00079 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structlsm303__dev.html">lsm303_dev</a> *PIOS_LSM303_alloc(<span class="keywordtype">void</span>);
<a name="l00080"></a>00080 <span class="keyword">static</span> int32_t PIOS_LSM303_Validate(<span class="keyword">struct</span> <a class="code" href="structlsm303__dev.html">lsm303_dev</a> *dev);
<a name="l00081"></a>00081 <span class="keyword">static</span> <span class="keywordtype">void</span> PIOS_LSM303_Config(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structpios__lsm303__cfg.html">pios_lsm303_cfg</a> *<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>);
<a name="l00082"></a>00082 <span class="keyword">static</span> int32_t PIOS_LSM303_Accel_SetReg(uint8_t address, uint8_t buffer);
<a name="l00083"></a>00083 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_SetReg(uint8_t address, uint8_t buffer);
<a name="l00084"></a>00084 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_GetReg(uint8_t address);
<a name="l00085"></a>00085 <span class="keyword">static</span> int32_t PIOS_LSM303_Accel_ReadData(<span class="keyword">struct</span> <a class="code" href="structpios__lsm303__accel__data.html" title="Internal representation of unscaled accelerometer data.">pios_lsm303_accel_data</a> *data);
<a name="l00086"></a>00086 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_ReadData(<span class="keyword">struct</span> <a class="code" href="structpios__lsm303__mag__data.html" title="Internal representation of unscaled magnetometer data.">pios_lsm303_mag_data</a> *data);
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> PIOS_LSM303_Task(<span class="keywordtype">void</span> *parameters);
<a name="l00088"></a>00088 
<a name="l00092"></a>00092 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structlsm303__dev.html">lsm303_dev</a> *PIOS_LSM303_alloc(<span class="keywordtype">void</span>)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094         <span class="keyword">struct </span><a class="code" href="structlsm303__dev.html">lsm303_dev</a> *<a class="code" href="structlsm303__dev.html">lsm303_dev</a>;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         lsm303_dev = (<span class="keyword">struct </span>lsm303_dev *)pvPortMalloc(<span class="keyword">sizeof</span>(*lsm303_dev));
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <span class="keywordflow">if</span> (!lsm303_dev) <span class="keywordflow">return</span> (NULL);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a70f59374a7f9e9a6297167795f5b8bdf">magic</a> = <a class="code" href="group___p_i_o_s___l_s_m303.html#gga541e751cf6c930fc56ab31e10b857a74a41c2c7ef1afe6e72780e4cbc0eb274d6">PIOS_LSM303_DEV_MAGIC</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#aadc09417d06ef07b4f4eb39b74f947a0">queue_accel</a> = xQueueCreate(PIOS_LSM303_MAX_QUEUESIZE, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpios__sensor__accel__data.html" title="Pios sensor structure for generic accel data.">pios_sensor_accel_data</a>));
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="keywordflow">if</span> (lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#aadc09417d06ef07b4f4eb39b74f947a0">queue_accel</a> == NULL) {
<a name="l00105"></a>00105                 vPortFree(lsm303_dev);
<a name="l00106"></a>00106                 <span class="keywordflow">return</span> NULL;
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a4801df95b04cdb58185c818dca8ae4ef">queue_mag</a> = xQueueCreate(PIOS_LSM303_MAX_QUEUESIZE, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structpios__sensor__mag__data.html" title="Pios sensor structure for generic mag data.">pios_sensor_mag_data</a>));
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a4801df95b04cdb58185c818dca8ae4ef">queue_mag</a> == NULL) {
<a name="l00112"></a>00112                 vPortFree(lsm303_dev);
<a name="l00113"></a>00113                 <span class="keywordflow">return</span> NULL;
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ab14a7b6518eb1699835c6d284425a6bb">data_ready_sema</a> = xSemaphoreCreateMutex();
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <span class="keywordflow">if</span> (lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ab14a7b6518eb1699835c6d284425a6bb">data_ready_sema</a> == NULL) {
<a name="l00119"></a>00119                 vPortFree(lsm303_dev);
<a name="l00120"></a>00120                 <span class="keywordflow">return</span> NULL;
<a name="l00121"></a>00121         }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keywordflow">return</span>(lsm303_dev);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00130"></a>00130 <span class="keyword">static</span> int32_t PIOS_LSM303_Validate(<span class="keyword">struct</span> lsm303_dev *dev)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132         <span class="keywordflow">if</span> (dev == NULL)
<a name="l00133"></a>00133                 <span class="keywordflow">return</span> -1;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structlsm303__dev.html#a70f59374a7f9e9a6297167795f5b8bdf">magic</a> != <a class="code" href="group___p_i_o_s___l_s_m303.html#gga541e751cf6c930fc56ab31e10b857a74a41c2c7ef1afe6e72780e4cbc0eb274d6">PIOS_LSM303_DEV_MAGIC</a>)
<a name="l00136"></a>00136                 <span class="keywordflow">return</span> -2;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a> == 0)
<a name="l00139"></a>00139                 <span class="keywordflow">return</span> -3;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="keywordflow">return</span> 0;
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00148"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#ga14f9c78fed7bf58de8e69e585cd67769">00148</a> int32_t <a class="code" href="group___p_i_o_s___l_s_m303.html#ga14f9c78fed7bf58de8e69e585cd67769" title="Initialize the LSM303 3-axis gyro sensor.">PIOS_LSM303_Init</a>(uint32_t <a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structpios__lsm303__cfg.html">pios_lsm303_cfg</a> *<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150         pios_lsm303_dev = PIOS_LSM303_alloc();
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         <span class="keywordflow">if</span> (pios_lsm303_dev == NULL)
<a name="l00153"></a>00153                 <span class="keywordflow">return</span> -1;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a> = <a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157         <span class="keywordflow">switch</span> (cfg-&gt;<a class="code" href="structpios__lsm303__cfg.html#a5b16505db880f6b6b0c22b4dedb532bf">devicetype</a>) {
<a name="l00158"></a>00158         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga2657cfa22c98bd2d84ea7fed74fac52aacabdc696724de7b296add69c5460a3d3">PIOS_LSM303DLHC_DEVICE</a>:
<a name="l00159"></a>00159                 pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43a431687ad3d1280504751dd67b99ad">i2c_addr_accel</a> = 0x19;
<a name="l00160"></a>00160                 pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43b3cb1f2405df34e8542d968e9eb321">i2c_addr_mag</a> = 0x1e;
<a name="l00161"></a>00161                 <span class="keywordflow">break</span>;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="keywordflow">default</span>:
<a name="l00164"></a>00164                 <span class="comment">//not implemented</span>
<a name="l00165"></a>00165                 PIOS_Assert(<span class="keyword">false</span>);
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a> = <a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="comment">/* Configure the LSM303 Sensor */</span>
<a name="l00171"></a>00171         PIOS_LSM303_Config(cfg);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="keywordtype">int</span> result = xTaskCreate(PIOS_LSM303_Task, (<span class="keyword">const</span> <span class="keywordtype">signed</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;pios_lsm303&quot;</span>,
<a name="l00174"></a>00174                                  LSM303_TASK_STACK, NULL, LSM303_TASK_PRIORITY,
<a name="l00175"></a>00175                                  &amp;pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#aa53f45353583c54556c8fd920144726a">TaskHandle</a>);
<a name="l00176"></a>00176         PIOS_Assert(result == pdPASS);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="comment">/* Set up EXTI line */</span>
<a name="l00179"></a>00179         <a class="code" href="group___p_i_o_s___e_x_t_i.html#gaa35c400a680d3af7d1ec1a0a3f91d93f">PIOS_EXTI_Init</a>(cfg-&gt;<a class="code" href="structpios__lsm303__cfg.html#a90c0ca7937453279f276d8adc5b7e82c">exti_cfg</a>);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <a class="code" href="group___p_i_o_s___s_e_n_s_o_r_s.html#gadd19368ecca5b7d027ce475e3677692b" title="Register a sensor with the PIOS_SENSORS interface.">PIOS_SENSORS_Register</a>(<a class="code" href="group___p_i_o_s___s_e_n_s_o_r_s.html#ggadad1b67d985a6c9c150a70d23aac96a0a0b386dcd14ce22a4ec0f296727338876">PIOS_SENSOR_ACCEL</a>, pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#aadc09417d06ef07b4f4eb39b74f947a0">queue_accel</a>);
<a name="l00182"></a>00182         <a class="code" href="group___p_i_o_s___s_e_n_s_o_r_s.html#gadd19368ecca5b7d027ce475e3677692b" title="Register a sensor with the PIOS_SENSORS interface.">PIOS_SENSORS_Register</a>(<a class="code" href="group___p_i_o_s___s_e_n_s_o_r_s.html#ggadad1b67d985a6c9c150a70d23aac96a0a5a4ddf59e023cf155e5af7f8304e644f">PIOS_SENSOR_MAG</a>, pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a4801df95b04cdb58185c818dca8ae4ef">queue_mag</a>);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">return</span> 0;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00193"></a>00193 <span class="keyword">static</span> <span class="keywordtype">void</span> PIOS_LSM303_Config(<span class="keyword">struct</span> <a class="code" href="structpios__lsm303__cfg.html">pios_lsm303_cfg</a> <span class="keyword">const</span> *<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195         <span class="comment">/*</span>
<a name="l00196"></a>00196 <span class="comment">         * accel</span>
<a name="l00197"></a>00197 <span class="comment">         */</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         <span class="comment">// Reset</span>
<a name="l00200"></a>00200         <span class="keywordflow">while</span> (PIOS_LSM303_Accel_SetReg(PIOS_LSM303_CTRL_REG5_A, PIOS_LSM303_CTRL5_BOOT) != 0);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="comment">// This register enables the channels and sets the bandwidth</span>
<a name="l00203"></a>00203         <span class="keywordflow">while</span> (PIOS_LSM303_Accel_SetReg(PIOS_LSM303_CTRL_REG1_A,
<a name="l00204"></a>00204                                         PIOS_LSM303_CTRL1_400HZ |
<a name="l00205"></a>00205                                         PIOS_LSM303_CTRL1_ZEN |
<a name="l00206"></a>00206                                         PIOS_LSM303_CTRL1_YEN |
<a name="l00207"></a>00207                                         PIOS_LSM303_CTRL1_XEN) != 0);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="comment">// Disable the high pass filters</span>
<a name="l00210"></a>00210         <span class="keywordflow">while</span> (PIOS_LSM303_Accel_SetReg(PIOS_LSM303_CTRL_REG2_A, 0) != 0);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="comment">// Set INT1 to go high on data ready</span>
<a name="l00213"></a>00213         <span class="keywordflow">while</span> (PIOS_LSM303_Accel_SetReg(PIOS_LSM303_CTRL_REG3_A, PIOS_LSM303_CTRL3_I1_DRDY1) != 0);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="comment">// Set High Resolution mode</span>
<a name="l00216"></a>00216         <span class="keywordflow">while</span> (PIOS_LSM303_Accel_SetReg(PIOS_LSM303_CTRL_REG4_A, PIOS_LSM303_CTRL4_HR) != 0);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         <span class="comment">// Set the accel scale</span>
<a name="l00219"></a>00219         <a class="code" href="group___p_i_o_s___l_s_m303.html#ga8b8011cf8463e2ae40eae82b2bf78251">PIOS_LSM303_Accel_SetRange</a>(<a class="code" href="group___p_i_o_s___l_s_m303.html#ggafbb0e59427f40a8d9b0e901af02bb7b3a9535d578ca9f6242eab4d401727a209d">PIOS_LSM303_ACCEL_8G</a>);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="comment">// Enabling the FIFO reduces resolution to 10-bits. It&#39;s default behaviour is disabled.</span>
<a name="l00222"></a>00222         <span class="comment">// This was found through trial and error. Is not documented in datasheet.</span>
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="comment">/*</span>
<a name="l00225"></a>00225 <span class="comment">         * mag</span>
<a name="l00226"></a>00226 <span class="comment">         */</span>
<a name="l00227"></a>00227         <span class="comment">// set the mag bandwidth</span>
<a name="l00228"></a>00228         <span class="keywordflow">while</span> (PIOS_LSM303_Mag_SetReg(PIOS_LSM303_CRA_REG_M, PIOS_LSM303_CRA_220HZ) != 0);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="comment">// set mag to continuous operation</span>
<a name="l00231"></a>00231         <span class="keywordflow">while</span> (PIOS_LSM303_Mag_SetReg(PIOS_LSM303_MR_REG_M, PIOS_LSM303_MR_CONTINUOUS) != 0);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <span class="comment">// Set the mag range</span>
<a name="l00234"></a>00234         <a class="code" href="group___p_i_o_s___l_s_m303.html#gae1c05338828d7ced47c189ed3e73a24a">PIOS_LSM303_Mag_SetRange</a>(<a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a4f6e30669e9fe7926bb28fb4e3192262">PIOS_LSM303_MAG_1_9GA</a>);
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00246"></a>00246 <span class="keyword">static</span> int32_t PIOS_LSM303_Accel_Read(uint8_t address, uint8_t *buffer, uint8_t len)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00249"></a>00249                 <span class="keywordflow">return</span> -1;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         uint8_t addr_buffer[] = {
<a name="l00252"></a>00252                 len &lt;= 1 ? address : (address | 0x80),
<a name="l00253"></a>00253         };
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpios__i2c__txn.html">pios_i2c_txn</a> txn_list[] = {
<a name="l00256"></a>00256                 {
<a name="l00257"></a>00257                         .<a class="code" href="structpios__i2c__txn.html#a202db3e74679d070f4f3d27c1dcb0f39">info</a> = __func__,
<a name="l00258"></a>00258                         .addr = pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43a431687ad3d1280504751dd67b99ad">i2c_addr_accel</a>,
<a name="l00259"></a>00259                         .rw = <a class="code" href="group___p_i_o_s___i2_c.html#gga317e7ea68e21f759a0326df96f278a2ba46f0bf6cbe98473562192f85efa6dfca">PIOS_I2C_TXN_WRITE</a>,
<a name="l00260"></a>00260                         .len = <span class="keyword">sizeof</span>(addr_buffer),
<a name="l00261"></a>00261                         .<a class="code" href="structpios__i2c__txn.html#a0d544e19d0f73acb6bf43743bc5e1480">buf</a> = addr_buffer,
<a name="l00262"></a>00262                 },
<a name="l00263"></a>00263                 {
<a name="l00264"></a>00264                         .info = __func__,
<a name="l00265"></a>00265                         .addr = pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43a431687ad3d1280504751dd67b99ad">i2c_addr_accel</a>,
<a name="l00266"></a>00266                         .rw = <a class="code" href="group___p_i_o_s___i2_c.html#gga317e7ea68e21f759a0326df96f278a2bad792429208f1a6cfeccea519a221c4c2">PIOS_I2C_TXN_READ</a>,
<a name="l00267"></a>00267                         .len = <a class="code" href="structpios__i2c__txn.html#af238133c1e4df913933e48fc29c5510b">len</a>,
<a name="l00268"></a>00268                         .buf = buffer,
<a name="l00269"></a>00269                 }
<a name="l00270"></a>00270         };
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___i2_c.html#ga82be0a46a98ad8ed6609e4f2dd27ae46" title="Perform a series of I2C transactions.">PIOS_I2C_Transfer</a>(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>, txn_list, NELEMENTS(txn_list));
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 
<a name="l00283"></a>00283 <span class="keyword">static</span> int32_t PIOS_LSM303_Accel_Write(uint8_t address, uint8_t buffer)
<a name="l00284"></a>00284 {
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00286"></a>00286                 <span class="keywordflow">return</span> -1;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         uint8_t data[] = {
<a name="l00289"></a>00289                 address,
<a name="l00290"></a>00290                 buffer,
<a name="l00291"></a>00291         };
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpios__i2c__txn.html">pios_i2c_txn</a> txn_list[] = {
<a name="l00294"></a>00294                 {
<a name="l00295"></a>00295                         .<a class="code" href="structpios__i2c__txn.html#a202db3e74679d070f4f3d27c1dcb0f39">info</a> = __func__,
<a name="l00296"></a>00296                         .addr = pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43a431687ad3d1280504751dd67b99ad">i2c_addr_accel</a>,
<a name="l00297"></a>00297                         .rw = <a class="code" href="group___p_i_o_s___i2_c.html#gga317e7ea68e21f759a0326df96f278a2ba46f0bf6cbe98473562192f85efa6dfca">PIOS_I2C_TXN_WRITE</a>,
<a name="l00298"></a>00298                         .len = <span class="keyword">sizeof</span>(data),
<a name="l00299"></a>00299                         .<a class="code" href="structpios__i2c__txn.html#a0d544e19d0f73acb6bf43743bc5e1480">buf</a> = data,
<a name="l00300"></a>00300                 },
<a name="l00301"></a>00301         };
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___i2_c.html#ga82be0a46a98ad8ed6609e4f2dd27ae46" title="Perform a series of I2C transactions.">PIOS_I2C_Transfer</a>(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>, txn_list, NELEMENTS(txn_list));
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00315"></a>00315 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_Read(uint8_t address, uint8_t *buffer, uint8_t len)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00318"></a>00318                 <span class="keywordflow">return</span> -1;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         uint8_t addr_buffer[] = {
<a name="l00321"></a>00321                 len &lt;= 1 ? address : (address | 0x80),
<a name="l00322"></a>00322         };
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpios__i2c__txn.html">pios_i2c_txn</a> txn_list[] = {
<a name="l00325"></a>00325                 {
<a name="l00326"></a>00326                         .<a class="code" href="structpios__i2c__txn.html#a202db3e74679d070f4f3d27c1dcb0f39">info</a> = __func__,
<a name="l00327"></a>00327                         .addr = pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43b3cb1f2405df34e8542d968e9eb321">i2c_addr_mag</a>,
<a name="l00328"></a>00328                         .rw = <a class="code" href="group___p_i_o_s___i2_c.html#gga317e7ea68e21f759a0326df96f278a2ba46f0bf6cbe98473562192f85efa6dfca">PIOS_I2C_TXN_WRITE</a>,
<a name="l00329"></a>00329                         .len = <span class="keyword">sizeof</span>(addr_buffer),
<a name="l00330"></a>00330                         .<a class="code" href="structpios__i2c__txn.html#a0d544e19d0f73acb6bf43743bc5e1480">buf</a> = addr_buffer,
<a name="l00331"></a>00331                 },
<a name="l00332"></a>00332                 {
<a name="l00333"></a>00333                         .info = __func__,
<a name="l00334"></a>00334                         .addr = pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43b3cb1f2405df34e8542d968e9eb321">i2c_addr_mag</a>,
<a name="l00335"></a>00335                         .rw = <a class="code" href="group___p_i_o_s___i2_c.html#gga317e7ea68e21f759a0326df96f278a2bad792429208f1a6cfeccea519a221c4c2">PIOS_I2C_TXN_READ</a>,
<a name="l00336"></a>00336                         .len = <a class="code" href="structpios__i2c__txn.html#af238133c1e4df913933e48fc29c5510b">len</a>,
<a name="l00337"></a>00337                         .buf = buffer,
<a name="l00338"></a>00338                 }
<a name="l00339"></a>00339         };
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___i2_c.html#ga82be0a46a98ad8ed6609e4f2dd27ae46" title="Perform a series of I2C transactions.">PIOS_I2C_Transfer</a>(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>, txn_list, NELEMENTS(txn_list));
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00352"></a>00352 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_Write(uint8_t address, uint8_t buffer)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00355"></a>00355                 <span class="keywordflow">return</span> -1;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         uint8_t data[] = {
<a name="l00358"></a>00358                 address,
<a name="l00359"></a>00359                 buffer,
<a name="l00360"></a>00360         };
<a name="l00361"></a>00361 
<a name="l00362"></a>00362         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpios__i2c__txn.html">pios_i2c_txn</a> txn_list[] = {
<a name="l00363"></a>00363                 {
<a name="l00364"></a>00364                         .<a class="code" href="structpios__i2c__txn.html#a202db3e74679d070f4f3d27c1dcb0f39">info</a> = __func__,
<a name="l00365"></a>00365                         .addr = pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a43b3cb1f2405df34e8542d968e9eb321">i2c_addr_mag</a>,
<a name="l00366"></a>00366                         .rw = <a class="code" href="group___p_i_o_s___i2_c.html#gga317e7ea68e21f759a0326df96f278a2ba46f0bf6cbe98473562192f85efa6dfca">PIOS_I2C_TXN_WRITE</a>,
<a name="l00367"></a>00367                         .len = <span class="keyword">sizeof</span>(data),
<a name="l00368"></a>00368                         .<a class="code" href="structpios__i2c__txn.html#a0d544e19d0f73acb6bf43743bc5e1480">buf</a> = data,
<a name="l00369"></a>00369                 },
<a name="l00370"></a>00370         };
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="keywordflow">return</span> <a class="code" href="group___p_i_o_s___i2_c.html#ga82be0a46a98ad8ed6609e4f2dd27ae46" title="Perform a series of I2C transactions.">PIOS_I2C_Transfer</a>(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a30d3092e0b3541399e2901bf71a0e6c2">i2c_id</a>, txn_list, NELEMENTS(txn_list));
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00383"></a>00383 <span class="keyword">static</span> int32_t PIOS_LSM303_Accel_SetReg(uint8_t reg, uint8_t data)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385         <span class="keywordflow">return</span> PIOS_LSM303_Accel_Write(reg, data);
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00393"></a>00393 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_GetReg(uint8_t reg)
<a name="l00394"></a>00394 {
<a name="l00395"></a>00395         uint8_t data;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         int32_t retval = PIOS_LSM303_Mag_Read(reg, &amp;data, <span class="keyword">sizeof</span>(data));
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <span class="keywordflow">if</span> (retval != 0)
<a name="l00400"></a>00400                 <span class="keywordflow">return</span> retval;
<a name="l00401"></a>00401         <span class="keywordflow">else</span>
<a name="l00402"></a>00402                 <span class="keywordflow">return</span> data;
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00413"></a>00413 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_SetReg(uint8_t reg, uint8_t data)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415         <span class="keywordflow">return</span> PIOS_LSM303_Mag_Write(reg, data);
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00423"></a>00423 <span class="keyword">static</span> int32_t PIOS_LSM303_Accel_ReadData(<span class="keyword">struct</span> <a class="code" href="structpios__lsm303__accel__data.html" title="Internal representation of unscaled accelerometer data.">pios_lsm303_accel_data</a> *data)
<a name="l00424"></a>00424 {
<a name="l00425"></a>00425         <span class="keywordflow">if</span> (PIOS_LSM303_Accel_Read(PIOS_LSM303_OUT_X_L_A, (uint8_t *)data, <span class="keyword">sizeof</span>(*data)) &lt; 0) {
<a name="l00426"></a>00426                 <span class="keywordflow">return</span> -2;
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429         <span class="keywordflow">return</span> 0;
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00437"></a>00437 <span class="keyword">static</span> int32_t PIOS_LSM303_Mag_ReadData(<span class="keyword">struct</span> <a class="code" href="structpios__lsm303__mag__data.html" title="Internal representation of unscaled magnetometer data.">pios_lsm303_mag_data</a> *data)
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439         uint8_t temp[6];
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         <span class="keywordflow">if</span> (PIOS_LSM303_Mag_Read(PIOS_LSM303_OUT_X_H_M, temp, <span class="keyword">sizeof</span>(temp)) &lt; 0) {
<a name="l00442"></a>00442                 <span class="keywordflow">return</span> -2;
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         data-&gt;<a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">mag_x</a> = temp[0] &lt;&lt; 8 | temp[1];
<a name="l00446"></a>00446         data-&gt;<a class="code" href="structpios__lsm303__mag__data.html#a2989fa1111551a8ec9135c7446bb0a03">mag_z</a> = temp[2] &lt;&lt; 8 | temp[3];
<a name="l00447"></a>00447         data-&gt;<a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">mag_y</a> = temp[4] &lt;&lt; 8 | temp[5];
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         <span class="keywordflow">return</span> 0;
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="comment">/*</span>
<a name="l00453"></a>00453 <span class="comment"> * @brief Read the identification bytes from the LSM303 sensor</span>
<a name="l00454"></a>00454 <span class="comment"> * \return ID read from LSM303 or -1 if failure</span>
<a name="l00455"></a>00455 <span class="comment">*/</span>
<a name="l00456"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#gae7f600d0c2cfc85affb21312eef1b4ce">00456</a> int32_t <a class="code" href="group___p_i_o_s___l_s_m303.html#gae7f600d0c2cfc85affb21312eef1b4ce">PIOS_LSM303_Mag_ReadID</a>()
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458         uint8_t <span class="keywordtype">id</span>[3];
<a name="l00459"></a>00459         int32_t retval = PIOS_LSM303_Mag_Read(PIOS_LSM303_IRA_REG_M, <span class="keywordtype">id</span>, <span class="keyword">sizeof</span>(<span class="keywordtype">id</span>));
<a name="l00460"></a>00460 
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (retval != 0)
<a name="l00462"></a>00462                 <span class="keywordflow">return</span> retval;
<a name="l00463"></a>00463         <span class="keywordflow">else</span>
<a name="l00464"></a>00464                 <span class="keywordflow">return</span> (<span class="keywordtype">id</span>[0] &lt;&lt; 16 | <span class="keywordtype">id</span>[1] &lt;&lt; 8 | <span class="keywordtype">id</span>[2]);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00470"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#ga8b8011cf8463e2ae40eae82b2bf78251">00470</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ga8b8011cf8463e2ae40eae82b2bf78251">PIOS_LSM303_Accel_SetRange</a>(<span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gafbb0e59427f40a8d9b0e901af02bb7b3">pios_lsm303_accel_range</a> accel_range)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00473"></a>00473                 <span class="keywordflow">return</span>;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         uint8_t <a class="code" href="structpios__i2c__txn.html#a0d544e19d0f73acb6bf43743bc5e1480">buf</a>;
<a name="l00476"></a>00476         PIOS_LSM303_Accel_Read(PIOS_LSM303_CTRL_REG4_A, &amp;buf, 1);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478         <span class="comment">// We reset the scale bits, so when OR&#39;ing new value it won&#39;t get OR&#39;d with old scale</span>
<a name="l00479"></a>00479         buf &amp;= 0xCF;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="keywordflow">while</span> (PIOS_LSM303_Accel_SetReg(PIOS_LSM303_CTRL_REG4_A, accel_range | buf) != 0);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483         pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a925acad41a5880d09927a1d63130e055">accel_range</a> = accel_range;
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00489"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#gae1c05338828d7ced47c189ed3e73a24a">00489</a> <span class="keywordtype">void</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gae1c05338828d7ced47c189ed3e73a24a">PIOS_LSM303_Mag_SetRange</a>(<span class="keyword">enum</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ga24737af5b503329ca628b921e32ec8d8">pios_lsm303_mag_range</a> mag_range)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00492"></a>00492                 <span class="keywordflow">return</span>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="keywordflow">while</span> (PIOS_LSM303_Mag_SetReg(PIOS_LSM303_CRB_REG_M, mag_range) != 0);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496         pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a9c4089c3f5674a6fc5d51d06d90501cc">mag_range</a> = mag_range;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="keyword">static</span> <span class="keywordtype">float</span> PIOS_LSM303_Accel_GetScale()
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501         <span class="comment">// Not validating device here for efficiency</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <span class="keywordflow">switch</span> (pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a925acad41a5880d09927a1d63130e055">accel_range</a>) {
<a name="l00504"></a>00504         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggafbb0e59427f40a8d9b0e901af02bb7b3a27dfa9deebf2dde3af39a5befaec680b">PIOS_LSM303_ACCEL_2G</a>:
<a name="l00505"></a>00505                 <span class="keywordflow">return</span> GRAVITY / (16 * 1000.0f);    <span class="comment">//1mg/LSB, left shifted by four bits</span>
<a name="l00506"></a>00506         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggafbb0e59427f40a8d9b0e901af02bb7b3a17ae55c78fa45d2ce30ed46e9e2f9a00">PIOS_LSM303_ACCEL_4G</a>:
<a name="l00507"></a>00507                 <span class="keywordflow">return</span> GRAVITY / (16 * 500.0f);     <span class="comment">//2mg/LSB, left shifted by four bits</span>
<a name="l00508"></a>00508         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggafbb0e59427f40a8d9b0e901af02bb7b3a9535d578ca9f6242eab4d401727a209d">PIOS_LSM303_ACCEL_8G</a>:
<a name="l00509"></a>00509                 <span class="keywordflow">return</span> GRAVITY / (16 * 250.0f);     <span class="comment">//4mg/LSB, left shifted by four bits</span>
<a name="l00510"></a>00510         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggafbb0e59427f40a8d9b0e901af02bb7b3a964aeb7da75de6e7dd39e0007b3385b9">PIOS_LSM303_ACCEL_16G</a>:
<a name="l00511"></a>00511                 <span class="keywordflow">return</span> GRAVITY / (16 * 250.0f / 3); <span class="comment">//12mg/LSB, left shifted by four bits</span>
<a name="l00512"></a>00512         }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514         <span class="keywordflow">return</span> 0;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="keyword">static</span> <span class="keywordtype">float</span> PIOS_LSM303_Mag_GetScaleXY()
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519         <span class="comment">// Not validating device here for efficiency</span>
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <span class="keywordflow">switch</span> (pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a9c4089c3f5674a6fc5d51d06d90501cc">mag_range</a>) {
<a name="l00522"></a>00522         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a78d5f0759823530a8bc4b6ad007ca51a">PIOS_LSM303_MAG_1_3GA</a>:
<a name="l00523"></a>00523                 <span class="keywordflow">return</span> 1000.0f / 1100.0f; <span class="comment">//[mg/LSB]</span>
<a name="l00524"></a>00524         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a4f6e30669e9fe7926bb28fb4e3192262">PIOS_LSM303_MAG_1_9GA</a>:
<a name="l00525"></a>00525                 <span class="keywordflow">return</span> 1000.0f / 855.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00526"></a>00526         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8aa3503800030f5377ad55bce47498f260">PIOS_LSM303_MAG_2_5GA</a>:
<a name="l00527"></a>00527                 <span class="keywordflow">return</span> 1000.0f / 670.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00528"></a>00528         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a3a95154f97aab91f26efaa1a2fd8992f">PIOS_LSM303_MAG_4_0GA</a>:
<a name="l00529"></a>00529                 <span class="keywordflow">return</span> 1000.0f / 450.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00530"></a>00530         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a3d37bcb89bd4512b249617ec810bb6cb">PIOS_LSM303_MAG_4_7GA</a>:
<a name="l00531"></a>00531                 <span class="keywordflow">return</span> 1000.0f / 400.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00532"></a>00532         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8ab66a621ddc7001e12f46831f09887b42">PIOS_LSM303_MAG_5_6GA</a>:
<a name="l00533"></a>00533                 <span class="keywordflow">return</span> 1000.0f / 330.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00534"></a>00534         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8ac0e0008a503ac4616b070659a6772261">PIOS_LSM303_MAG_8_1GA</a>:
<a name="l00535"></a>00535                 <span class="keywordflow">return</span> 1000.0f / 230.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         <span class="keywordflow">return</span> 0;
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 <span class="keyword">static</span> <span class="keywordtype">float</span> PIOS_LSM303_Mag_GetScaleZ()
<a name="l00542"></a>00542 {
<a name="l00543"></a>00543         <span class="comment">// Not validating device here for efficiency</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545         <span class="keywordflow">switch</span> (pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a9c4089c3f5674a6fc5d51d06d90501cc">mag_range</a>) {
<a name="l00546"></a>00546         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a78d5f0759823530a8bc4b6ad007ca51a">PIOS_LSM303_MAG_1_3GA</a>:
<a name="l00547"></a>00547                 <span class="keywordflow">return</span> 1000.0f / 980.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00548"></a>00548         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a4f6e30669e9fe7926bb28fb4e3192262">PIOS_LSM303_MAG_1_9GA</a>:
<a name="l00549"></a>00549                 <span class="keywordflow">return</span> 1000.0f / 760.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00550"></a>00550         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8aa3503800030f5377ad55bce47498f260">PIOS_LSM303_MAG_2_5GA</a>:
<a name="l00551"></a>00551                 <span class="keywordflow">return</span> 1000.0f / 600.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00552"></a>00552         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a3a95154f97aab91f26efaa1a2fd8992f">PIOS_LSM303_MAG_4_0GA</a>:
<a name="l00553"></a>00553                 <span class="keywordflow">return</span> 1000.0f / 400.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00554"></a>00554         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8a3d37bcb89bd4512b249617ec810bb6cb">PIOS_LSM303_MAG_4_7GA</a>:
<a name="l00555"></a>00555                 <span class="keywordflow">return</span> 1000.0f / 355.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00556"></a>00556         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8ab66a621ddc7001e12f46831f09887b42">PIOS_LSM303_MAG_5_6GA</a>:
<a name="l00557"></a>00557                 <span class="keywordflow">return</span> 1000.0f / 295.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00558"></a>00558         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gga24737af5b503329ca628b921e32ec8d8ac0e0008a503ac4616b070659a6772261">PIOS_LSM303_MAG_8_1GA</a>:
<a name="l00559"></a>00559                 <span class="keywordflow">return</span> 1000.0f / 205.0f;  <span class="comment">//[mg/LSB]</span>
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562         <span class="keywordflow">return</span> 0;
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00570"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#ga6cead4a99372061bc1b1a9a08a0eb183">00570</a> int32_t <a class="code" href="group___p_i_o_s___l_s_m303.html#ga6cead4a99372061bc1b1a9a08a0eb183" title="Run self-test operation.">PIOS_LSM303_Accel_Test</a>(<span class="keywordtype">void</span>)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572         <span class="keyword">struct </span><a class="code" href="structpios__lsm303__accel__data.html" title="Internal representation of unscaled accelerometer data.">pios_lsm303_accel_data</a> data;
<a name="l00573"></a>00573         <span class="keywordflow">return</span> PIOS_LSM303_Accel_ReadData(&amp;data);
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 
<a name="l00581"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#ga02c4d8ca4981e2ced505a7ea3bd13a72">00581</a> int32_t <a class="code" href="group___p_i_o_s___l_s_m303.html#ga02c4d8ca4981e2ced505a7ea3bd13a72" title="Run self-test operation.">PIOS_LSM303_Mag_Test</a>(<span class="keywordtype">void</span>)
<a name="l00582"></a>00582 {
<a name="l00583"></a>00583         int32_t <span class="keywordtype">id</span> = <a class="code" href="group___p_i_o_s___l_s_m303.html#gae7f600d0c2cfc85affb21312eef1b4ce">PIOS_LSM303_Mag_ReadID</a>();
<a name="l00584"></a>00584 
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (<span class="keywordtype">id</span> != 0x483433)     <span class="comment">// &quot;H43&quot;</span>
<a name="l00586"></a>00586                 <span class="keywordflow">return</span> -1;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keyword">struct </span><a class="code" href="structpios__lsm303__mag__data.html" title="Internal representation of unscaled magnetometer data.">pios_lsm303_mag_data</a> data;
<a name="l00589"></a>00589         <span class="keywordflow">return</span> PIOS_LSM303_Mag_ReadData(&amp;data);
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00595"></a><a class="code" href="group___p_i_o_s___l_s_m303.html#gac6bc0a694ea85c9644a96c5558b75a7d">00595</a> <span class="keywordtype">bool</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#gac6bc0a694ea85c9644a96c5558b75a7d" title="IRQ Handler. Read all the data from onboard buffer.">PIOS_LSM303_IRQHandler</a>(<span class="keywordtype">void</span>)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597         <span class="keywordflow">if</span> (PIOS_LSM303_Validate(pios_lsm303_dev) != 0)
<a name="l00598"></a>00598                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         portBASE_TYPE xHigherPriorityTaskWoken = pdFALSE;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         xSemaphoreGiveFromISR(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ab14a7b6518eb1699835c6d284425a6bb">data_ready_sema</a>, &amp;xHigherPriorityTaskWoken);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="keywordflow">return</span> xHigherPriorityTaskWoken == pdTRUE;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="keyword">static</span> <span class="keywordtype">void</span> PIOS_LSM303_Task(<span class="keywordtype">void</span> *parameters)
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609         <span class="keywordflow">while</span> (1) {
<a name="l00610"></a>00610                 <span class="comment">//Wait for data ready interrupt</span>
<a name="l00611"></a>00611                 <span class="keywordflow">if</span> (xSemaphoreTake(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ab14a7b6518eb1699835c6d284425a6bb">data_ready_sema</a>, 5 * portTICK_RATE_MS) != pdTRUE) {
<a name="l00612"></a>00612                         <span class="comment">// If this expires kick start the sensor</span>
<a name="l00613"></a>00613                         <span class="keyword">struct </span><a class="code" href="structpios__lsm303__accel__data.html" title="Internal representation of unscaled accelerometer data.">pios_lsm303_accel_data</a> data;
<a name="l00614"></a>00614                         PIOS_LSM303_Accel_ReadData(&amp;data);
<a name="l00615"></a>00615                         <span class="keywordflow">continue</span>;
<a name="l00616"></a>00616                 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618                 <span class="comment">/*</span>
<a name="l00619"></a>00619 <span class="comment">                 * Process accel data</span>
<a name="l00620"></a>00620 <span class="comment">                 */</span>
<a name="l00621"></a>00621                 {
<a name="l00622"></a>00622                         <span class="keyword">struct </span><a class="code" href="structpios__lsm303__accel__data.html" title="Internal representation of unscaled accelerometer data.">pios_lsm303_accel_data</a> data;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624                         <span class="keywordflow">if</span> (PIOS_LSM303_Accel_ReadData(&amp;data) &lt; 0) {
<a name="l00625"></a>00625                                 <span class="keywordflow">continue</span>;
<a name="l00626"></a>00626                         }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628                         <span class="keywordtype">float</span> accel_scale = PIOS_LSM303_Accel_GetScale();
<a name="l00629"></a>00629 
<a name="l00630"></a>00630                         <span class="keyword">struct </span><a class="code" href="structpios__sensor__accel__data.html" title="Pios sensor structure for generic accel data.">pios_sensor_accel_data</a> normalized_data;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632                         <span class="keywordflow">switch</span> (pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>-&gt;<a class="code" href="structpios__lsm303__cfg.html#a53a64d5c1d513bda3033f35b41a5afcc">orientation</a>) {
<a name="l00633"></a>00633                         <span class="keywordflow">default</span>:
<a name="l00634"></a>00634                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfcab7b9ad1a88b543eb6f98397977e0581e">PIOS_LSM303_TOP_0DEG</a>:
<a name="l00635"></a>00635                                 normalized_data.x = +data.accel_x * accel_scale;
<a name="l00636"></a>00636                                 normalized_data.y = -data.accel_y * accel_scale;
<a name="l00637"></a>00637                                 <span class="keywordflow">break</span>;
<a name="l00638"></a>00638                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfca55c31b966726d9b7177e8e25db2357d5">PIOS_LSM303_TOP_90DEG</a>:
<a name="l00639"></a>00639                                 normalized_data.x = +data.accel_y * accel_scale;
<a name="l00640"></a>00640                                 normalized_data.y = +data.accel_x * accel_scale;
<a name="l00641"></a>00641                                 <span class="keywordflow">break</span>;
<a name="l00642"></a>00642                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfcab4b68df0f50b413ab7d2910d55da299a">PIOS_LSM303_TOP_180DEG</a>:
<a name="l00643"></a>00643                                 normalized_data.x = -data.accel_x * accel_scale;
<a name="l00644"></a>00644                                 normalized_data.y = +data.accel_y * accel_scale;
<a name="l00645"></a>00645                                 <span class="keywordflow">break</span>;
<a name="l00646"></a>00646                         <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfca7b58cc3793a2a9107f9b29de98ebc463">PIOS_LSM303_TOP_270DEG</a>:
<a name="l00647"></a>00647                                 normalized_data.x = -data.accel_y * accel_scale;
<a name="l00648"></a>00648                                 normalized_data.y = -data.accel_x * accel_scale;
<a name="l00649"></a>00649                                 <span class="keywordflow">break</span>;
<a name="l00650"></a>00650                         }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652                         normalized_data.z = -data.accel_z * accel_scale;
<a name="l00653"></a>00653                         normalized_data.temperature = 0;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655                         xQueueSendToBack(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#aadc09417d06ef07b4f4eb39b74f947a0">queue_accel</a>, (<span class="keywordtype">void</span> *)&amp;normalized_data, 0);
<a name="l00656"></a>00656                 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658                 <span class="comment">/*</span>
<a name="l00659"></a>00659 <span class="comment">                 * Process mag data</span>
<a name="l00660"></a>00660 <span class="comment">                 */</span>
<a name="l00661"></a>00661                 {
<a name="l00662"></a>00662                         <span class="keywordflow">if</span> ((PIOS_LSM303_Mag_GetReg(PIOS_LSM303_SR_REG_M) &amp; PIOS_LSM303_SR_DRDY) != 0) {
<a name="l00663"></a>00663                                 <span class="keyword">struct </span><a class="code" href="structpios__lsm303__mag__data.html" title="Internal representation of unscaled magnetometer data.">pios_lsm303_mag_data</a> data;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665                                 <span class="keywordflow">if</span> (PIOS_LSM303_Mag_ReadData(&amp;data) &lt; 0) {
<a name="l00666"></a>00666                                         <span class="keywordflow">continue</span>;
<a name="l00667"></a>00667                                 }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669                                 <span class="keywordtype">float</span> mag_scale_xy = PIOS_LSM303_Mag_GetScaleXY();
<a name="l00670"></a>00670                                 <span class="keywordtype">float</span> mag_scale_z = PIOS_LSM303_Mag_GetScaleZ();
<a name="l00671"></a>00671                                 <span class="keyword">struct </span><a class="code" href="structpios__sensor__mag__data.html" title="Pios sensor structure for generic mag data.">pios_sensor_mag_data</a> normalized_data;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673                                 <span class="keywordflow">switch</span> (pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#ad5dc8f3a8d9729f36b59e641a907c232">cfg</a>-&gt;<a class="code" href="structpios__lsm303__cfg.html#a53a64d5c1d513bda3033f35b41a5afcc">orientation</a>) {
<a name="l00674"></a>00674                                 <span class="keywordflow">default</span>:
<a name="l00675"></a>00675                                 <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfcab7b9ad1a88b543eb6f98397977e0581e">PIOS_LSM303_TOP_0DEG</a>:
<a name="l00676"></a>00676                                         normalized_data.x = +data.<a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">mag_x</a> * mag_scale_xy;
<a name="l00677"></a>00677                                         normalized_data.y = -data.<a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">mag_y</a> * mag_scale_xy;
<a name="l00678"></a>00678                                         <span class="keywordflow">break</span>;
<a name="l00679"></a>00679                                 <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfca55c31b966726d9b7177e8e25db2357d5">PIOS_LSM303_TOP_90DEG</a>:
<a name="l00680"></a>00680                                         normalized_data.x = +data.<a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">mag_y</a> * mag_scale_xy;
<a name="l00681"></a>00681                                         normalized_data.y = +data.<a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">mag_x</a> * mag_scale_xy;
<a name="l00682"></a>00682                                         <span class="keywordflow">break</span>;
<a name="l00683"></a>00683                                 <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfcab4b68df0f50b413ab7d2910d55da299a">PIOS_LSM303_TOP_180DEG</a>:
<a name="l00684"></a>00684                                         normalized_data.x = -data.<a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">mag_x</a> * mag_scale_xy;
<a name="l00685"></a>00685                                         normalized_data.y = +data.<a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">mag_y</a> * mag_scale_xy;
<a name="l00686"></a>00686                                         <span class="keywordflow">break</span>;
<a name="l00687"></a>00687                                 <span class="keywordflow">case</span> <a class="code" href="group___p_i_o_s___l_s_m303.html#ggaf21acd6da6d1a83963ba1b7a45937cfca7b58cc3793a2a9107f9b29de98ebc463">PIOS_LSM303_TOP_270DEG</a>:
<a name="l00688"></a>00688                                         normalized_data.x = -data.<a class="code" href="structpios__lsm303__mag__data.html#a3365812478c4eab5da066f69f10ceacf">mag_y</a> * mag_scale_xy;
<a name="l00689"></a>00689                                         normalized_data.y = -data.<a class="code" href="structpios__lsm303__mag__data.html#ae632e8723dee3280f6672412cf5b67f1">mag_x</a> * mag_scale_xy;
<a name="l00690"></a>00690                                         <span class="keywordflow">break</span>;
<a name="l00691"></a>00691                                 }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693                                 normalized_data.z = -data.<a class="code" href="structpios__lsm303__mag__data.html#a2989fa1111551a8ec9135c7446bb0a03">mag_z</a> * mag_scale_z;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695                                 xQueueSendToBack(pios_lsm303_dev-&gt;<a class="code" href="structlsm303__dev.html#a4801df95b04cdb58185c818dca8ae4ef">queue_mag</a>, (<span class="keywordtype">void</span> *)&amp;normalized_data, 0);
<a name="l00696"></a>00696                         }
<a name="l00697"></a>00697                 }
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 <span class="preprocessor">#endif</span>
<a name="l00702"></a>00702 <span class="preprocessor"></span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="pios__lsm303_8c.html">pios_lsm303.c</a>      </li>

    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
